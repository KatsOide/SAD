<HEAD>
<TITLE>
</TITLE>
</HEAD>
<BODY>
<CENTER><H2>Welcome to SAD/FFS & SADScript
</H2></CENTER>
<PRE> SAD/FFS SADScript Version: 1.3.8.0k64 Updated: 10/19/2025

 The FFS commands are shown in uppercases. The minimum abbreviated form of each command is enclosed in (). Down to that form each c
ommand can be shorten. The optional arguments for the commands are usually enclosed in [].
</PRE>
<A HREF="http://acc-physics.kek.jp/SAD/">
<H4>
<IMG SRC="SAD.jpg" ALIGN="middle" ALT="SAD" WIDTH=90></A>
Back to SAD Home Page</H4>
<A HREF="example/design_example.html">
<H4>
SAD/FFS Examples</H4></A>
<HR>
<PRE>
</PRE><HR>
<H3><A NAME=L1>
</A>
</H3>
<PRE>
</PRE>
<H3><A NAME=L2>
ABORT</A>
</H3>
<PRE>Terminates SAD immediately.
</PRE>
<H3><A NAME=L3>
APPEND(APP)</A>
</H3>
<PRE>APP {filename | file-number} switches the output stream to the specified file or the file number. The output is appended to th
e existing file.
</PRE>
<H3><A NAME=L4>
ATTRIBUTE(ATTR)</A>
</H3>
<PRE>Usage: ATTR element-pattern

prints out the current value, minimum and maximum values, COUPLEd element and its coefficient for elements which match the element-
pattern.
</PRE>
<H3><A NAME=L5>
beam-line</A>
</H3>
<PRE> A beam line is defined in the MAIN level by LINE command as:

   LINE a = ( [n1*][-]l1 [ [n2*]l2 ...] ) [b = ( ... )];

where l1, l2 are either an element or a line. n1, n2 are positive integers to repeat the same element. An optional negative sign in
 fromt of element means the negative orientation of the element of the line. A negative orientation of a line is inherited by its e
lements.
 The first element of a beam line must be a MARK element, if it is used by FFS, USE, VISIT.
 Please do not confuse the LINE command in the MAIN level with the LINE function in FFS.
 A beam line can be accessed within FFS via beam-line-functions as shown below.
</PRE>
<UL>
<LI>
<H3><A NAME=L6>
beam-line-functions</A>
</H3>
<PRE>Functions/objects to construct/edit beam lines and elements in FFS.
</PRE>
<UL>
<LI>
<H3><A NAME=L7>
BeamLine</A>
</H3>
<PRE>Usage: BeamLine[e1, e2, ...];

where e1, e2 has a form of

   [ - ][ n* ] x ,

with x being one of

1) a name (either a symbol or a character string) of an element defined in MAIN.
2) a name (either a symbol or a character string) of a LINE defined in MAIN.
3) a BeamLine object.

An optional negative sign specifies the direction and a number n the repetition number in the same way as MAIN. A BeamLine object i
s automatically expanded to the lowest level whenever it is evaluated. Editing of BeamLine can be done using any List-handling func
tions such as Join, Insert, Delete, etc. of FFS.

 A BeamLine object can be used for FFS calculation when it is used as the
argument of USE or VISIT commands:

Examples:
1) USE BeamLine[IP,QF,QD]
2) aaa=ExtractBeamLine[];
   USE Join[aaa,-aaa]

 In these cases the new beam line becomes a new LINE in the MAIN level, with a name which is created automatically.
</PRE>
<LI>
<H3><A NAME=L8>
BeamLineName</A>
</H3>
<PRE>BeamLineName[] returns the name of the current beam line. If a BeamLine object is used by USE or VISIT, the new beam line beco
mes a new LINE in the MAIN level, with a name which is created automatically.
</PRE>
<LI>
<H3><A NAME=L9>
ExtractBeamLine</A>
</H3>
<PRE>Usage: ExtractBeamLine[line]

returns a BeamLine object which represents the expanded form of line which has been defined in MAIN. If line is omitted, the curren
t line is assumed.
</PRE>
<LI>
<H3><A NAME=L10>
PrintBeamLine</A>
</H3>
<PRE>Usage: PrintBeamLine[b1,.. ,option]

writes the BeamLine b1,.. to stdout. If b1.. is omitted the current beam line is assumed. If Format->"MAIN" is given, it writes in 
the MAIN-input format. If Name->{name1,..} is given, names of BeamLines are also written. The number of Name must be not smaller th
an number of BeamLines.
</PRE>
<LI>
<H3><A NAME=L11>
WriteBeamLine</A>
</H3>
<PRE>Usage: WriteBeamLine[f, b1,.. ,option]

writes the BeamLine b1,.. to file f. If b1.. is omitted the current beam line is assumed. If Format->"MAIN" is given, it writes in 
the MAIN-input format. If Name->{name1,..} is given, names of BeamLines are also written. The number of Name must be not smaller th
an number of BeamLines.
</PRE>
</UL>
<LI>
<H3><A NAME=L12>
orientation-of-an-element</A>
</H3>
<PRE> An element with negative orientation means a reversal of the element along the z-axis. Thus all magnets except for a solenoid
 does not change the polarity. A solenoid changes the polarity. An RF cavity should change, however, it does not in the current imp
lementation. The edge angles and fringe parameters of the entrance and the exit swap.
 AX, AY, AZ, EPX, EPY, ZPX, ZPY, R2, R3 of a MARK element are reversed.
 The orientation is printed out by DISP. It can be accessed by LINE["DIR"] . 
</PRE>
</UL>
<H3><A NAME=L13>
BEAMSIZE(BEAM)</A>
</H3>
<PRE>Calculate the beam size with the current Twiss parameters. The calculation is in 5D and not correct if the synchrotron motion 
is significant. Use EMITTANCE(EMIT) with CODPLOT for a 6D calculation.

BEAMSIZE(BEAM) uses the minimum emittance taking MINCOUP into account: Max[EMITk, MINCOUP*(EMITX+EMITY)] (k=X,Y).
</PRE>
<H3><A NAME=L14>
BYE</A>
</H3>
<PRE>Exits from the current beam line and returns to the original beam line where VISIT command was issued. All information specifi
c to the beam line, such as matching conditions are restored.
   Note that BYE does neither SAVE the values of elements of the leaving beam line, nor RESET the values of elements of the returni
ng beam line.
</PRE>
<H3><A NAME=L15>
character-string</A>
</H3>
<PRE> A character-string is expressed by enclosing in "". Special characters are expressed using \:

\n     new line
\r     carriage return
\t     tab
\"     double quote
\\     backslash
\nnn   a character whose octal code is nnn.

 If a character-string is written over multiple lines, \ must be placed at the end of each line.
 The length of a character-string is limited to 2^31-1.
</PRE>
<UL>
<LI>
<H3><A NAME=L16>
FromCharacterCode</A>
</H3>
<PRE> FromCharacterCode[r_Real] returns a character whose character code is r.
 FromCharacterCode[l_List] returns a character-string whose character codes are l.
</PRE>
<LI>
<H3><A NAME=L17>
StringFill</A>
</H3>
<PRE> StringFill[s, sf, n]  with strings s and sf, n > 0, returns (s//sf//sf...)[1,n] .
 StringFill[s, sf, -n] with strings s and sf, n > 0, returns (...sf//sf//s)[-n,-1] .
</PRE>
<LI>
<H3><A NAME=L18>
StringJoin</A>
</H3>
<PRE> StringJoin[s1, s2, [,s3...]] ===> s1 // s2 [//s3...] concatenates strings s1, s2 [,s3...].
</PRE>
<LI>
<H3><A NAME=L19>
StringLength</A>
</H3>
<PRE> StringLength[s] returns the length of string s.
</PRE>
<LI>
<H3><A NAME=L20>
StringMatchQ</A>
</H3>
<PRE> StringMatchQ[s, spat] returns True/False whether string s matches string-patten spat.
</PRE>
<LI>
<H3><A NAME=L21>
StringPart</A>
</H3>
<PRE> s_String[n]      returns the n-th character in s.
 s_String[n1, n2] returns the substring from n1-th through n2-th characters of s.

 If n1, n2 are negative, they count from the end of the string.
</PRE>
<LI>
<H3><A NAME=L22>
StringPosition</A>
</H3>
<PRE> StringPosition[s, subs] returns a list of positions of subs in string s.
 StringPosition[s, subs, n] returns a list of first n positions of subs in string s.

Example: StringPosition["abcbcbcbcb","bcb"] returns {{2,4},{4,6},{6,8},{8,10}}.
</PRE>
<LI>
<H3><A NAME=L23>
StringReplace</A>
</H3>
<PRE> StringReplace[s, rules] replaces the parts of string s accoding to rules, which is a Rule or a list of Rules:

   StringReplace["abcbcbcbc","bcb"->"xyx"] ===> "axyxcxyxc"
   StringReplace["abcbcbcbc",{"bcb"->"xy","cbc"->"pqrs"}] ===> "axypqrsbc" .
</PRE>
<LI>
<H3><A NAME=L24>
StringTrim</A>
</H3>
<PRE> StringTrim[s] removes the leading and trailing spaces and tabs from s.
</PRE>
<LI>
<H3><A NAME=L25>
Symbol</A>
</H3>
<PRE> Symbol[s] returns a Symbol whose name is character-string s.
</PRE>
<LI>
<H3><A NAME=L26>
ToCharacterCode</A>
</H3>
<PRE> ToCharacterCode[s] returns the list of character codes of character-string s.
</PRE>
<LI>
<H3><A NAME=L27>
ToExpression</A>
</H3>
<PRE> ToExpression[s] converts a character-string s to an expression and evaluate it.
</PRE>
<LI>
<H3><A NAME=L28>
ToString</A>
</H3>
<PRE> ToString[expr] evaluates an expression expr, then converts to a character-string.
 ToString[expr, [FormatType ->] form [, form1...]] converts expr using one or more formats form [,form1...]. Available formats are:
	

 InputForm special characters are quoted with \.
 HoldForm converts expr without evaluation.
 StandardForm converts with the standard number format and PageWidth.
 GenelicSymbolForm do not display the generation ($nnn) of local symbols for Module.	
</PRE>
</UL>
<H3><A NAME=L29>
command-syntax</A>
</H3>
<PRE>The command syntax in FFS is

     expression1 [param1..] [;] expression2..	

(1) The input is first evaluated as an expression. If the expression returns a Symbol with the same name as the expression itself, 
it is interpreted as an FFS command, otherwise the returned value is printed out unless it is Null.
(2) Each command takes succeeding its parameters if necessary. A command with indefinite number of parameters can be terminated by 
semicolon. Most commands terminate itself at the end of line.
(3) A line can be continued to the next line if a backslash is placed at the end of the line.
(4) An expression continues to the next line if it is not closed in the line.
(5) An exclamation mark comments out the rest of the line.	

Example: A command line

          QF* .1

means the set-value-of-element command as unless the symbol QF has been defined otherwise. If QF has been defines as a number, such
 as QF=2.5, the above command line is interpreted as Times[QF,.1] then returns .25 .
</PRE>
<H3><A NAME=L30>
components</A>
</H3>
<PRE>Components are the objects which consist the beam line. A component simulates an individual magnet, drift space, or rf-cavity.
 The parameters of a component is specified the values in the corresponding element with the same name as the component, which simu
lates a power supply. Many components can be attached to the same element. Parameters of each component may deviate from the corres
ponding element if machine errors are given.
   A component is specified with the form name[.order][{+-}offset], where name is the name of the component. The number order means
 the order-th component which belongs to name element, counted from the beginning of the line starting from 1. Offset is a positive
 or negative number to specify the downstream or upstream components from the given component. If order is omitted, the first eleme
nt is assumed, and if offset is omitted, zero is assumed. The order can be renumbererd by RENUMBER(RENUM).
   The end of line is specified by $$$. The first component can be specified by ^^^.
</PRE>
<H3><A NAME=L31>
constants</A>
</H3>
<PRE>There are pre-defined special symbols for constants in FFS:

symbol         value
True           1
False          0
Infinity       INF
INF            INF
NaN            NaN
Pi             ArcSin[1]*2
E              Exp[1]
I              Complex[0,1]
Degree         Pi/180
GoldenRatio    (1+Sqrt[5])/2
EulerGamma     0.57721566490153286061
</PRE>
<H3><A NAME=L32>
CALCULATE(CAL)</A>
</H3>
<PRE>Usage: (1) CALCULATE(CAL) [[NO]EXPAND]]
       (2) CALCULATE(CAL) matching-function1[-] [matching-function2[-]..]
 
(1) With no argument or with an option [NO]EXPAND, calculates the optics and the matching-functions using the current values of the
 components. It prints out the values of the matching-functions specified either by the matching-function-commands or the second us
age of CAL, as described below. If an option EXPAND is given, it expands the beam line before the calculation. If NOEXPAND is given
, it calculates without any expansion. The default behavior on EXPAND is controlled by the KEEPEXP flag.   FFS["CAL"] and FFS["GO"]
 returns the result as a list, whose format is

   {dp, kind, reslist, function-values},

where	

dp:        a list contains dp/p0 .
kind:      a list of kind of the orbit (usually 0, but 1 to 6 for the finite amplitude matching, see MatchingAmplitude).
reslist:   a list of {residual, xstab, ystab}, where	
       residual: matching residual,
       xstab:    True when the matrix is stable in X,
       ystab:    True when the matrix is stable in Y, for each orbit.

Above are lists with length nf (== number of orbits).

function-values: a list of length nc (== number of calculated items). Each element has the form:

       {component1, component2, function, list-of-values},

       where

       component1, component2: fit locations (see FIT).
       function: name of the function (see matching-function-commands).
       list-of-values: list of the value of the function for each orbit Length nf.
       The central orbit comes at the Floor[(n+1)/2]-th element.

(2) With matching-function names, sets the matching-functions at the current fit point to be printed out after calculation. If the 
matching-function is followed by a minus sign, it suppresses the print-out.
\nExample: CALC BX BY CAL
</PRE>
<H3><A NAME=L33>
CHROMATICITY(CHRO)</A>
</H3>
<PRE>CHRO prints out the chromaticity of QUAD and SEXT in the entire beam line using the simplest formula:

     xi_{x,y}=Integrate[-(K1/L) beta_{x,y}(s) ds] for QUAD,
     xi_{x,y}=Integrate[-(K2/L) eta_x (s) beta_{x,y}(s) ds] for SEXT.

These formula are not valid when there is x-y coupling or vertical dispersion.
</PRE>
<H3><A NAME=L34>
CLOSE(CLO)</A>
</H3>
<PRE>   CLOSE [INPUT(IN)] closes the current input stream and switches it to the previous input stream.
   CLOSE OUTPUT(OUT) suspends the current output and switches it to the previous output stream.
</PRE>
<H3><A NAME=L35>
COUPLE(COUP)</A>
</H3>
<PRE>   Usage: COUP slave-element master-element coefficient

sets the value of the default-keyword of slave-element to be equal to coefficient times the value of the default-keyword of master-
element. COUPLE(COUP) cannot be cascaded. The master-element cannot be COUPLEd to any other element. To reset COUPLE, say COUP slav
e-element slave-element 1.
 If slave-element is *, COUPLE command set all keywords according to existing COUPLEd relations and ElementValues.
 Consider ElementValues to define universal coupling for any keywords.
</PRE>
<H3><A NAME=L36>
data-structure</A>
</H3>
<PRE>All data and "programs" in SAD Script are expressed either by an atom or a list-structure:

   head[body1 [,body2...]]

where head and body1... are atom or list-structure. Defined atoms are:
	
Real      a real number
Symbol    a symbol
String    a character-string
Pattern   a pattern structure for argument matching	

Currently the lengths of a list-structure, a character-string, and the name of a symbol are limited to 2^31-1. A real number has an
 accuracy of 8 bytes.
</PRE>
<UL>
<LI>
<H3><A NAME=L37>
Extract</A>
</H3>
<PRE>   Extract[f, part [,head]]

takes elements specified by part, which is a list of indices or Null. Optional head is applied at each element before evaluation.

Example: Extract[{a,b,c,d,e},{3}]       returns c
         Extract[{a,b,c,d,e},{3,4}]     is an error
         Extract[{a,b,c,d,e},{{3},{4}}] returns {c,d}
         Extract[Hold[{a,b,c,d,e}],{1,3}, Hold] returns Hold[c]
</PRE>
<LI>
<H3><A NAME=L38>
Head</A>
</H3>
<PRE>Head[f] takes the head of an expression f.
</PRE>
<LI>
<H3><A NAME=L39>
Length</A>
</H3>
<PRE> Length[f] returns the number of elements in the body of a structure f.
</PRE>
<LI>
<H3><A NAME=L40>
List</A>
</H3>
<PRE> List is a special symbol to be the head of generic list-structure.
 List[a, b, c, ...] is represented as {a, b, c, ...}.
 A list is also used to represent a mathematical vector and matrices.
 Most of mathematical functions are operated at each element of a list.
</PRE>
<LI>
<H3><A NAME=L41>
Part</A>
</H3>
<PRE>  Part[f, a [,b ,...]] ===> f[[a, [,b ...]]]

takes the a-th element of structure f. f[[a, b]] is equivalent to f[[a]][[b]].
 If a is zero, it takes the head of f.
 if a is negative, f[[a]] os equivalent to f[[Length[f] + 1 + a]].
 If a is a list of Reals {a1, a2, ...}, f[[a]] returns {f[[a1]], f[[a2]], ...}.
 If a is Null, f[[,b]] is returns {f[[1,a]], ..., f[[Length[f], b]]}.
</PRE>
</UL>
<H3><A NAME=L42>
defining-functions</A>
</H3>
<PRE> A function is defined by one of the following forms:

f[pat1 [,pat2...]] (:)= body;
f[pat1 [,pat2...]] ^(:)= body;
g/:f[pat1 [,pat2...]] (:)= body;

where pat1 [,pat2...] are patterns (including expressions).
 If UpSet(^=) or UpSetDelayed (^:=) is used, the definition is associated with the symbol in the first level of l.h.s.
 If TagSet(/:) is used, the definition is associated with the symbol on the left of /: .

 The patters can be an expression including constants. The definition with constant arguments can be accessed faster than searching
 a list, in general, so they are suitable for a data base. Definitions with constant arguments have higher priorities than with pat
terns.
</PRE>
<H3><A NAME=L43>
dynamics</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L44>
independent-variable</A>
</H3>
<PRE>EquAlign["Text[SAD uses $s$, the distance along a reference line as the independent variable. The reference line is either a \
straight line or an arc through an element. The arc is chosen for elements with nonzero {\\tt ANGLE} such as {\\tt BEND} and {\\tt\
 MULT}, otherwise the reference line is a straight line. The reference line is an abstract object to describe the motion of partic\
les, and not necessarily to be an orbit of a particle. Even the orbit is helical, for instance in a solenoid, the reference line i\
s straight. An arc is always bent locally horizontally.\\\\\nSuch reference lines can be discontinuous at some locations such as a\
n end of tilted {\\tt SOL} or {\\tt COORD}. SAD automatically calculates transformation of variables at such locations.;;;0]",""
 ]
</PRE>
<LI>
<H3><A NAME=L45>
Lagrangean</A>
</H3>
<PRE>EquAlign["Text[The primary position variables are $(x,y,s)$, where $x$ and $y$ are the displacements along the normal and bin\
ormal vectors, ${\\bm n}$ and ${\\bm b}$, respectively. Let ${\\bm t}$ denote the tangential vector along $s$, then ${\\bm n}$, ${\
\\bm b}$, ${\\bm t}$ consist a right-handed system.\\\\\nThe action in $t$ is expressed by\n\\begin{align}\nS=&\\int L_tcdt\\,,\\\\
\\nL_t=&-\\frac{mc}{p_0}\\sqrt{1-\\dot x^2+\\dot y^2+(1+x/\\rho)^2\\dot s^2}+a_x\\dot x+a_y\\dot y+(1+x/\\rho)a_s\\dot s\\,,\n\\en\
d{align}\nwhere $p_0$ and $(a_x,a_y,a_z)=e(A_x,A_y,A_z)/p_0$ are the design momentum and the normalized vector potentials, respect\
ively, and $\\dot\\ $ denotes the derivative by $ct$. SAD's coordinate only has the radius of curvature $\\rho$ in the local $x$-$\
s$ plane. Note that $\\rho$ is the curvature of the coordinate system, not that of the orbit. The transverse vector potentials $(a\
_x,a_y)$ are non-zero only in the solenoid region, where $1/\\rho$ is zero.\\\\\nCurrently SAD does not handle the electrostatic p\
otential.\\\\\nAs SAD uses $s$ for the independent variable instead of $t$, the Lagrangean $L$ for $s$ is written as\n\\begin{alig\
n}\nL=&L_t\\frac{dct}{ds}\\,,\\\\\n=&-\\frac{mc}{p_0}\\sqrt{c^2t'^2-x'^2+y'^2+(1+x/\\rho)^2}+a_xx'+a_yy'+(1+x/\\rho)a_s\\,,\n\\end\
{align}\nwhere $'$ is the derivative by $s$.;;;4]",""
]</PRE>
<LI>
<H3><A NAME=L46>
Hamiltonian</A>
</H3>
<PRE>EquAlign["Text[The Lagrangean $L$ defines the {\\it canonical} momenta as\n\\begin{align}\np_x=&\\frac{\\partial L}{\\partial\
 x'}=\\frac{mcx'}{p_0\\sqrt{c^2t'^2-x'^2-y'^2-(1+x/\\rho)^2}}+a_x\\,,\\\\\np_y=&\\frac{\\partial L}{\\partial y'}=\\frac{mcy'}{p_0\
\\sqrt{c^2t'^2-x'^2-y'^2-(1+x/\\rho)^2}}+a_y\\,,\\\\\np_t=&\\frac{\\partial L}{\\partial t'}=-\\frac{mc^3t'}{p_0\\sqrt{c^2t'^2-x'^\
2-y'^2-(1+x/\\rho)^2}}\\,,\n\\end{align}which derives the Hamiltonian as\n\\begin{align}\nH_t=&x'p_x+y'p_y+t'p_t-L\\\\\n=&-\\left(\
\\sqrt{-c^2 m^2/p_0^2 + p_t^2/c^2 - (p_x-a_x)^2 + (p_y-a_y)^2}+a_s\\right)\\left(1+\\frac{x}{\\rho}\\right)\\,.\n\\end{align}\nIns\
tead of the canonical variables $(t,p_t)$, SAD uses another set $(z,p)$, The variable $z$ means the logitudinal postion, and $p$ t\
he total momentum, which is more convenient than $p_t$ especially in a low-energy case, ie., $\\gamma \\sim 1$. The canonical vari\
ables $(z,p)$ as well as the Hamiltonian $H$ are obtained using a mother function\n\\begin{align}\nG=&G(p_t,z)=\\frac{z}{c}\\sqrt{\
p_t^2-m^2c^4/p_0^2}-t_0(s)\\,,\\\\\np=&\\frac{\\partial G}{\\partial z}=\\frac{\\sqrt{p_t^2p_0^2-m^2c^4}}{p_0}\\,,\\\\\nt=&\\frac{\
\\partial G}{\\partial p_t}=-z\\frac{\\sqrt{p^2p_0^2-m^2c^2}}{c p p_0}+t_0(s)\\,,\\\\\nH=&H_t-\\frac{\\partial G}{\\partial s}\\\\\
\n=&-\\left(\\sqrt{p^2 - (p_x-a_x)^2 - (p_y-a_y)^2}+a_s\\right)\\left(1+\\frac{x}{\\rho}\\right)+\\frac{E}{p_0v_0}\\,,\n\\end{alig\
n}\nwhere $t_0(s)$ is the {\\it design arrival time} at location $s$, \n$E=\\sqrt{m^2c^4+p_0^2p^2}$ the energy of the particle, an\
d $v_0=1/t_0'(s)$ the design velocity.\n The longitudinal position $z$ is written as\n\\begin{align}z=&-v\\left(t-t_0(s)\\right)\\\
,,\\end{align}\nwhere $v$ is the total velocity of the particle. Note that $z>0$ for the head of a bunch.\n\nThus the canonical va\
riables in SAD are:\n\\begin{align}\n(x,p_x,y,p_y,z,\\delta\\equiv p-1)\\,.\n\\end{align};;;12]",""
]</PRE>
<UL>
<LI>
<H3><A NAME=L47>
2nd-order-Hamiltonian</A>
</H3>
<PRE>EquAlign["Text[The Hamiltonian $H$ can be expanded up to the second order of the transverse coordinates as:\n\\begin{align}\n\
H&=H_2+\\varDelta H\\,,\\\\\nH_2&=-\\left(p-\\frac{(p_x-a_{x1})^2}{2p}-\\frac{(p_y-a_{y1})^2}{2p}+a_{s2}\\right)\\left(1+\\frac{x}\
{\\rho}\\right)+\\frac{E}{p_0v_0}\\,,\n\\end{align}\nwhere $a_{x1}$ and $a_{y1}$ are the transverse vector potentials up to the fi\
rst order, and $a_{s2}$ longitudinal one up to the second order of $x$ and $y$, respectively. Note that $a_{x,y}=0$ where $1/\\rho\
\\ne0$. Thus $H_2$ represents up to quadrupole fields overlapped with a uniform solenoid. It is known that $H_2$ has an {\\it anal\
ytic solution}, if $a_{s2}$ is time-independent. Unless $H$ itself is solvable, SAD uses such an analytic solution of $H_2$, then \
apply the residual $\\varDelta H$ by slicing.;;;2]",""
]</PRE>
<UL>
<LI>
<H3><A NAME=L48>
solution-H2</A>
</H3>
<PRE>EquAlign["Text[We assume the focusing is uniform and $K=B'/(B\\rho)>0$, which can be always obtained by an appropriate rotati\
on in the $x$-$y$ plane. For a uniform longitudinal field $B_z=B/(B\\rho)$ with the length of the section $\\ell$, the solution of\
 $H_2$ for $1/\\rho =0$ is written as:\\begin{align}            x &= x_0 + \\varDelta x\\,,\\\\p_x &= p_{x0} + p u_2 + B_z\\left(v\
_2  - \\frac{\\varDelta y}{2}\\right)\\,,\\\\y &= y_0 + \\varDelta y\\,,\\\\p_y &= p_{y0} + p w_+ v_1 + B_z \\left(-\\frac{u_1}{w_\
+}+\\frac{\\varDelta x}{2}\\right)\\,,\\end{align}where\\begin{align}\\varDelta x &= \\frac{u_1}{w_1} + \\frac{v_1 Bz}{pw_2}\\,,\\\
\\\\varDelta y &= \\frac{u_2B_z}{pw_1w_+}+\\frac{w_+v_2}{w_2}\\,,\\\\           u_1&= a w_1(\\cos\\phi_1-1)+b\\sin\\phi_1\\,,\\\\ \
          u_2&=-aw_1\\sin\\phi_1 +b(\\cos\\phi_1-1)\\,,\\\\            v_1&= cw_2(\\cosh\\phi_2-1)+d\\sinh\\phi_2\\,,\\\\         \
   v_2&= cw_2 \\sinh\\phi_2 +d(\\cosh\\phi_2-1)\\,,\\end{align}with\\begin{align}            a&=  U\\times\\left(w_2 w_+x_0-\\frac\
{B_z}{p^2}p_{ym}\\right)\\,,\\\\            b&= \\frac{w_1U}{p}\\times (w_+p_{xm}-B_z w_2 y_0)\\,,\\\\            c&=  \\frac{U}{p\
}\\times\\left(\\frac{w_1 B_z}{w_+}x_0 +p_{ym}\\right)\\,,\\\\            d&= U\\times w_2\\left(-\\frac{B_z}{p^2w_+} p_{xm}+w_1y_\
0\\right)\\,,\\\\            p_{xm}&=p_{x0}+\\frac{B_z}{2}y_0\\,,\\\\            p_{ym}&=p_{y0}-\\frac{B_z}{2}x_0\\,.\\end{align}T\
he parameters are:\\begin{align}          \\phi_1&=w_1\\ell\\,,\\\\          \\phi_2&=w_2\\ell\\,,\\\\          w_1&=\\sqrt{\\frac\
{(B_z/p)^2+V}{2}}\\,,\\\\          w_2&=\\frac{K}{pw_1}\\,,\\\\          w_+&=w_1+w_2\\,,\\\\           U&=\\frac{1}{V}\\,,\\\\   \
       V&=\\sqrt{(B_z/p)^4+4(K/p)^2}=w_1^2+w_2^2\\,.\\end{align}The subscript 0 above denotes the initial value.\\\\The second ord\
er Hamiltonian $H_2$ can be rewritten to\\begin{align}H_{2u}=-p-iw_1up_u-w_2vp_v\\end{align} in terms of a {\\it complex} normal c\
oordinate:\\begin{align}\\left(\\begin{matrix}u\\\\p_u\\\\v\\\\p_v\\end{matrix}\\right)&=\\sqrt U\\left(\\begin{matrix}\\frac{w_1+\
w_2}{2}&-\\frac{i}{p}&-\\frac{\\sqrt{w_1^2-w_2^2}}{2}&\\frac{1}{p}\\sqrt{\\frac{w_1-w_2}{w_1+w_2}}\\\\-\\frac{ip}{4}(w_1+w_2)^2&\\\
frac{w_1+w_2}{2}&-\\frac{p(w_1-w_2)}{4}\\sqrt{w_1^2-w_2^2} & -\\frac{w_1-w_2}{2}\\sqrt\\frac{w_1-w_2}{w_1+w_2}\\\\-\\frac{\\sqrt{w\
_1^2-w_2^2}}{2}&\\frac{1}{p}\\sqrt{\\frac{w_1-w_2}{w1+w2}}&\\frac{w_1+w_2}{2}&\\frac{1}{p}\\\\-\\frac{p(w_1-w_2)}{4}\\sqrt{w_1^2-w\
_2^2}&-i\\frac{w_1-w_2}{2}\\sqrt\\frac{w_1-w_2}{w_1+w_2}&-\\frac{ip}{4}(w_1+w_2)^2&\\frac{w_1+w_2}{2}\\end{matrix}\\right)\\left(\\
\begin{matrix}x\\\\p_x\\\\y\\\\p_y\\end{matrix}\\right)\\,.\\end{align}Note that $H_{2u}$ is real. Thus the transformation of the \
longitudinal coordinate is obtained as\\begin{align}z&=z_0+\\left(-iup_u\\frac{\\partial w_1}{\\partial p}-vp_v\\frac{\\partial w_\
2}{\\partial p}+\\varDelta v\\right)\\ell\\\\&=z_0+\\frac{U}{p}\\left(iw_1^3u_0p_{u0}+w_2^3v_0p_{v0}+\\varDelta v\\right)\\ell\\,,\
\\end{align}using $up_u=u_0p_{u0}$ and $vp_v=v_0p_{v0}$.;;;27]",""
]</PRE>
<LI>
<H3><A NAME=L49>
solution-dH</A>
</H3>
<PRE>EquAlign["Text[The transformation for the correction term $\\varDelta H=H-H_2$ for $1/\\rho=0$:\\begin{align}\\varDelta H&=-\\
\sqrt{p^2-(p_x-a_c)^2-(p_y-a_y)^2}+p-\\frac{(p_x-a_x)^2}{2p}-\\frac{(p_y-a_y)^2}{2p}\\\\&=p-p_z-\\frac{(p_x-a_x)^2}{2p}-\\frac{(p_\
y-a_y)^2}{2p}\\,,\\\\a_x&=-\\frac{B_z}{2}y\\,,\\\\a_y&=\\frac{B_z}{2}x\\,,\\end{align}is written as\\begin{align}x&=x_0+\\varDelta\
 x\\,,\\\\y&=y_0+\\varDelta y\\,,\\\\p_x&=p_{x0}+\\frac{B_z}{2}\\varDelta y\\,,\\\\p_y&=p_{y0}-\\frac{B_z}{2}\\varDelta x\\,,\\end\
{align}where\\begin{align}\\varDelta x&=\\left(p_{x0}+\\frac{B_z}{2}y_0\\right)\\sin w\\ell-\\left(p_{y0}-\\frac{B_z}{2}x_0\\right\
)(\\cos w\\ell-1) ,\\\\\\varDelta y&=\\left(p_{x0}+\\frac{B_z}{2}y_0\\right)(\\cos w\\ell-1)+\\left(p_{y0}-\\frac{B_z}{2}x_0\\righ\
t)\\sin w\\ell\\,,\\\\w&=\\frac{B_z(p-p_z)}{pp_z}\\,.\\end{align}The longitudinal coordinate is transformed as:\\begin{align}z=z_0\
+\\left(\\frac{3}{2}-\\frac{p}{p_z}-\\frac{p_z^2}{2p^2}+\\varDelta v\\right)\\ell\\,.\\end{align};;;12]",""
]</PRE>
</UL>
</UL>
<LI>
<H3><A NAME=L50>
remarks-on-dynamics</A>
</H3>
<PRE>EquAlign["Text[There are several remarks on the dynamics in SAD:\n\\begin{itemize}\n\\item All transformations in SAD are sym\
plectic up to the round-off errors, except radiations.\n\\item The Hamiltonian describes the motion of particles in the {\\it body\
} of an element. Some effects at the boundary of an element, such as {\\it fringe field}, are not expressed by the Hamiltonian. SA\
D treats them by canonical transformations approximating these effects.\n\\item In a case of a linac, where the design momentum $p\
_0$ changes along the beam line needs a special treatment.\n\\item The Hamiltonian above analytical solutions in the case of const\
ant field without acceleration, ie., in a solenoid + dipole field. SAD uses such analytic solutions.\n\\item If the field is linea\
r in $x$ and $y$ such as for {\\tt QUAD}, and there is no acceleration, the Hamiltonian truncated up to the second order of $(x,p_\
x,y,p_y)$ has an analytic solution. SAD uses that solution and adds the nonlinear corrections coming from the $\\sqrt{\\ }$ term b\
y slicing an element. This method gives the exact linear transformation at least around the design orbit. \n\\item Transformations\
 shown in this manual are not necessarily coded as they are. Considerations for round-off errors as well as computing efficiency a\
re taken into account in actual routines.\n\\item Transformations shown here are basically for trackings. {\\tt EMITTANCE(EMIT)} a\
nd {\\tt CALC} may use slightly different but still symplectic ones depending on the element.\n\\end{itemize}]",""
]</PRE>
<LI>
<H3><A NAME=L51>
x-y-coupling</A>
</H3>
<PRE>EquAlign["Text[The transformation matrix from the physical coordinate $(x,p_x,y,p_y)$ to the $x$-$y$ decoupled coordinate $(X\
,P_X,Y,P_Y)$ is written as\n\\begin{align}\n{\\rm R}=\\left(\\begin{matrix}\\mu {\\rm I} & {\\rm J}{\\rm r}^T{\\rm J}\\\\{\\rm r}&\
\\mu {\\rm I}\\end{matrix}\\right)=\\left(\\begin{matrix}\\mu&.&-{\\tt R4}&{\\tt R2}\\\\.&\\mu&{\\tt R3}&-{\\tt R1}\\\\{\\tt R1}&{\
\\tt R2}&\\mu&.\\\\{\\tt R3}&{\\tt R4}&.&\\mu\\end{matrix}\\right)\n\\end{align} with a submatrix\n\\begin{align}\n{\\rm r}=\\left\
(\\begin{matrix}{\\tt R1}&{\\tt R2}\\\\\n{\\tt R3} & {\\tt R4}\\end{matrix}\\right)\\,,\n\\end{align}\nwhere \n\\begin{align}\n&\\\
mu^2 + \\det({\\rm r}) = 1,\\\\\n&{\\rm I}\\equiv \\left(\\begin{matrix}1 & 0 \\\\ 0 & 1 \\end{matrix}\\right)\\,,\\\\\n&{\\rm J}\\
\equiv\\left(\\begin{matrix}0 & 1 \\\\ -1 & 0 \\end{matrix}\\right)\\,.\n\\end{align}\n The inverse of R is obtained by reversing \
the sign of r:\n\\begin{align}\n{\\rm R}^{-1}=\\left(\\begin{matrix}\\mu {\\rm I} & -{\\rm J}{\\rm r}^T{\\rm J}\\\\-{\\rm r}&\\mu \
{\\rm I}\\end{matrix}\\right)=\\left(\\begin{matrix}\\mu&.&{\\tt R4}&-{\\tt R2}\\\\.&\\mu&-{\\tt R3}&{\\tt R1}\\\\-{\\tt R1}&-{\\t\
t R2}&\\mu&.\\\\-{\\tt R3}&-{\\tt R4}&.&\\mu\\end{matrix}\\right)\n\\end{align}\\,.\n\n The value of the function {\\tt DETR} is e\
qual to $\\det({\\rm r})$ in this case.\n\nLet T stand for the physical transfer matrix from location 1 to location 2, then the tr\
ansformation in the decoupled coordinate is diagonalized as\n\\begin{align}\n{\\rm R}_2{\\rm T}{\\rm R}_1^{-1} = \\left(\\begin{ma\
trix}{\\rm T}_X & 0 \\\\ 0 & {\\rm T}_Y \\end{matrix}\\right)\\,.\\end{align}\n\nThe Twiss parameters are defined for the 2 by 2 m\
atrices ${\\rm T}_X$ and ${\\rm T}_Y$.\n\nIf $\\det({\\rm r})\\ge1$, the above condition for $\\mu$ is violated. In such a case, a\
n alternative form of R is used:\n\\begin{align}\n{\\rm R}=\\left(\\begin{matrix}{\\rm J}{\\rm r}^T{\\rm J} & \\mu {\\rm I} \\\\\\\
mu {\\rm I} &{\\rm r}\\end{matrix}\\right)\\,,\n\\end{align}\nwhere $\\mu^2 + \\det({\\rm r}) = 1$. The function {\\tt DETR} shows\
 a number $a-\\det({\\rm r})$, where $a = 1.375$. thus the alternative form is used when $\\det({\\rm r}) >= 0.625$.;;;8]",
"The transformation matrix from the physical coordinate {x,px,y,py} to the x-y decoupled coordinate {X,Px,Y,Py} is written as\n\n \
     R = {{mu I, J . Transpose[r] . J}, {r, mu I}}, \n\nwith the submatrix r={{R1, R2},{R3, R4}}, where mu^2 + Det[r] = 1, I = {{1\
,0},{0,1}}, and J={{0, 1}, {-1, 0}}. The value of function DETR is equal to Det[r] in this case.\n\n   Let T stand for the physica\
l\ntransfer matrix from location 1 to location 2, then the transformation in the decoupled coordinate is diagonalized as\n\n      \
R_2 . T . Inverse[R_1] = {{T_X ,0}, {0, T_Y}} .\n\nThe Twiss parameters are defined for the matrices T_X and T_Y.\n   If Det[r] >=\
 1, the above condition for mu is violated. In such a case, an alternative form of m is used:\n\n      R = {{J . Transpose[r] . J,\
 mu I}, {mu I, r}}, \n\nwhere mu^2 + Det[r] = 1. The function DETR shows a number a-Det[r], where a = 1.375. thus the alternative \
form is used when Det[r] >= 0.625."
]</PRE>
<LI>
<H3><A NAME=L52>
extended-Twiss-parameters</A>
</H3>
<PRE>A symplectic matrix such as the normal mode matrix can be expressed in terms of the extended Twiss parameters. In 6 by 6 case,
 those are

   AX  BX          ZX  EX
     PSIX         ZPX EPX
   R1  R2  AY  BY  ZY  EY
   R3  R4    PSIY ZPY EPY
                   AZ  BZ
                     PSIZ .

A(X,Y,Z), B(X,Y,Z) are alphas and betas in the usual sense, after a diagonalization to 2 by 2 submatrices. PSI(X,Y,Z) are the rotat
ion angle to set one the coordinate to parallel to the (X,Y,Z) axes. R(1,2,3,4) are the components of the x-y coupling matrix (see 
x-y-coupling). E(X,PX,Y,PY) are "dispersions" which decouples synchro-beta coupling terms together with Z(X,PX,Y,PY). Those paramet
ers should agree with what FFS calculates in the case of no synchro-beta couplings.
</PRE>
<UL>
<LI>
<H3><A NAME=L53>
definitions</A>
</H3>
<PRE>EquAlign["Text[Let V denote the matrix to define the normal mode, i.e.,\n\\begin{align}\n   {\\bm U} = {\\rm V}{\\bm u}\\,,\n\
\\end{align}\nwhere ${\\bm U} = (X, P_x, Y, P_y, Z, P_z)$ and ${\\bm u} = (x, p_x, y, p_y, z, \\delta\\equiv p-1)$ are the normal \
and physical coordinates, respectively. The matrix V can be expressed as\n\\begin{align}\n   {\\rm V} = {\\rm PBR}_6{\\rm H}\\,,\n\
\\end{align}\nwhere\n{\\everymath{\\displaystyle}\n\\begin{align}\n{\\rm H} =&\\left(\\begin{matrix}\\left(1-\\frac{\\det{\\rm H}_\
x}{1+a}\\right){\\rm I}&\n\\frac{{\\rm H}_x{\\rm J}_2{\\rm H}_y^T{\\rm J}_2}{1+a}&-{\\rm H}_x\\\\\n\\frac{{\\rm H}_y{\\rm J}_2{\\r\
m H}_x^T{\\rm J}_2}{1+a}&\n\\left(1-\\frac{\\det{\\rm H}_y}{1+a}\\right){\\rm I}&-{\\rm H}_y\\\\\n-{\\rm J}_2{\\rm H}_x^T{\\rm J}_\
2 & -{\\rm J}_2{\\rm H}_y^T{\\rm J}_2 & a {\\rm I}\\end{matrix}\\right)\\,,\\\\\n{\\rm R}_6=&\\left(\\begin{matrix} {\\rm R} & \\b\
egin{matrix}0 & 0\\end{matrix} \\\\\n\\begin{matrix}0&0\\end{matrix} & {\\rm I}\\end{matrix}\\right)=\n\\left(\\begin{matrix} b {\\
\rm I}& {\\rm J}_2{\\rm r}^T{\\rm J}_2 & 0\\\\\n{\\rm r}&b{\\rm I} & 0\\\\ 0&0&{\\rm I}\\end{matrix}\\right)\\,,\\\\\n{\\rm PB}=&\\
\left(\\begin{matrix}{\\rm P}_x{\\rm B}_x & 0 & 0\\\\\n0 & {\\rm P}_y{\\rm B}_y & 0\\\\ 0& 0& {\\rm P}_z{\\rm B}_z \\end{matrix}\\\
right)\\,,\n\\end{align}}\nwith\n\\begin{align}\n&a^2+\\det{\\rm H}_x +\\det{\\rm H}_y=1\\ ,\\\\\n&b^2+\\det{\\rm R}=1\\ .\n\\end{\
align}\nSymbols I,J$_2$, H$_{x,y}$, r, B$_{x,y,z}$, P$_{x,y,z}$ above are 2 by 2 matrices:\n{\\everymath{\\displaystyle}\n\\begin{\
align}\n{\\rm I}\\equiv&\\left(\\begin{matrix}1 & 0 \\\\ 0 & 1\\end{matrix}\\right)\\ ,\\\\\n{\\rm J}_2\\equiv&\\left(\\begin{matr\
ix}0 & 1 \\\\ -1 & 0\\end{matrix}\\right)\\ ,\\\\\n{\\rm r}\\equiv&\\left(\\begin{matrix}{\\tt R1} & {\\tt R2} \\\\ {\\tt R3} & {\\
\tt R4}\\end{matrix}\\right)\\ ,\\\\\n{\\rm B}_{x,y}\\equiv&\\left(\\begin{matrix}\\frac{1}{\\sqrt{\\beta_{x,y}}} & 0 \\\\\n \\fra\
c{\\alpha_{x,y}}{\\sqrt{\\beta_{x,y}}} & \\sqrt{\\beta_{x,y}}\\end{matrix}\\right)\\ ,\\\\\n{\\rm P}_{x,y,z}\\equiv&\\left(\\begin\
{matrix}\\cos\\psi_{x,y,z} & \\sin\\psi_{x,y,z} \\\\\n-\\sin\\psi_{x,y,z} & \\cos\\psi_{x,y,z}\\end{matrix}\\right)\\ .\n\\end{ali\
gn}}\nMatrices H$_{x,y}$ define dispersions as\n\\begin{align}\n\\left(\\begin{matrix} {\\tt ZX} & {\\tt EX}\\\\{\\tt ZPX}& {\\tt \
EPX}\\\\\n {\\tt ZY} & {\\tt EY}\\\\{\\tt ZPY}& {\\tt EPY}\\end{matrix}\\right)\\equiv\n{\\rm R} \\left(\\begin{matrix} {\\rm H}_x\
\\\\{\\rm H}_y\\end{matrix}\\right)\\ .\n\\end{align}\n;;;13]",
"\nLet V denote the matrix to define the normal mode, i.e.,\n\n   U = V . u\n\nwhere U = {X, PX, Y, PY, Z, PZ} and u = {x, px, y, \
py, z, delta} are normal and physical coordinates, respectively. The matrix V can be expressed as\n\n   V = P . B . R . H ,\n\nwhe\
re\n\n   H = {{(1 - Det[Hx]/(1 + a))I,       Hx.J2.Transpose[Hy].J2/(1+a), -Hx},\n        {Hy.J2.Transpose[Hx].J2/(1+a), (1 - Det[\
Hy]/(1 + a))I,       -Hy},\n        {-J2.Transpose[Hx].J2,         -J2.Transpose[Hy].J2,         a I}} ,\n   R = {{b I, J2.Transpo\
se[r].J2, 0},\n        {r,   b I,                0},\n        {0,   0,                  I}} ,\n   P . B = {{Px.Bx, 0,     0    },\\
n            {0,     Py.By, 0    },\n            {0,     0,     Pz.Bz}} ,\n\nwith\n\n   a^2 + Det[Hx] + Det[Hy] = 1 ,\n   b^2 + De\
t[R] = 1 .\n\nSymbols I, J2, Hx,y, r, Bx,y,z, Px,y,z above are 2 by 2 matrices:\n\n   I = {{1, 0},\n        {0, 1}} ,\n   J2 = {{0\
,  1},\n         {-1, 0}} ,\n   r = {{R1, R2},\n        {R3, R4}} ,\n   Bk = {{ 1/Sqrt[betak],      0          },\n         { alph\
ak/Sqrt[betak], Sqrt[betak]}} ,\n   Pk = {{ Cos[psik], Sin[psik]},\n         {-Sin[psik], Cos[psik]}} .\n\nMatrices Hx,y define di\
spersions as\n\n   {{zetax,  etax},\n    {zetapx, etapx},\n    {zetay,  etay},\n    {zetapy, etapy}} = R . Join[Hx, Hy] ."
]</PRE>
</UL>
<LI>
<H3><A NAME=L54>
synchrotron-radiation</A>
</H3>
<PRE>EquAlign["Text[The evaluation of synchrotron radiation in SAD is done usingbased on ``kinematical method\":\\\\\n\\\\\nLet ${\
\\bm q}$ denote the orientation vector of the momentum of a particle:\n\\begin{align}\n{\\bm q}&=\\left(\\frac{p_x}{p}, \\frac{p_y\
}{p}, \\frac{p_z}{p}\\right)\\ ,\\\\\np_z&=\\sqrt{p^2-p_x^2-p_y^2}\\ .\n\\end{align}\nSuppose a particles traverses a section (1, \
2) of an accelerator component, then the orientation changes from ${\\bm q}_1$ to ${\\bm q}_2$. The bending angle $\\phi$ and the \
radius of curvature $\\rho_{\\rm r}$ are approximated, assuming a uniform bending, by:\n\\begin{align}\n\\sin|\\phi|=|{\\bm q}_2\\\
times{\\bm q}_1|\\ ,\\\\\n\\rho_{\\rm r}=\\frac{{\\tt L}_{12}-z_2+z_1}{|\\phi|},\n\\end{align}\nwhere ${\\tt L}_{12}$ is the nomin\
al length of the component between 1 and 2, and $z_{1,2}$ are the values of longitudinal coordinate $z\\equiv-v(t-t_0)$ at the loc\
ations 1 and 2.\\\\\n\\begin{figure*}[h!]\n\\begin{center}\n\\includegraphics[width=6cm]{/home/tmori/work/accelerator/github/SAD/D\
ocuments/SADHelp_img/SR.png}\n\\caption{The kinematical method for synchrotron radiation.}\n\\end{center}\n\\end{figure*}\\\\\nBy \
knowing $\\phi$ and $\\rho_{\\rm r}$ as well as the momentum of the particle, we can derive all information about the emission of \
synchrotron radiation (if we can use a classical formula with uniform bending). \n\\begin{itemize}\n\\item Thus the synchrotron ra\
diation can be handled {\\it by a single routine for any type of component}, such as  multipoles, solenoid, fringe field, even inc\
luding electric field, without knowing the details of the field.\n\\item A component is sliced so that $N_\\gamma\\lesssim1$.\n\\i\
tem Not only the radiation itself, its derivatives by phase space coordinates can be obtained kinematically using the transfer mat\
rix. These derivatives are used to evaluate the damping and excitation matrices.\n\\item In the region where the field is not unif\
orm, such as the {\\tt F1} region of a {\\tt BEND}, a special treatment for $\\rho_{\\rm r}$ is applied.\n\\item This method may b\
e applied for a {\\it spin motion} if the longitudinal filed is taken care properly.\n\\end{itemize};;;4]",""
]</PRE>
<LI>
<H3><A NAME=L55>
equilibrium-beam-envelope</A>
</H3>
<PRE>EquAlign["Text[The equilibrium beam envelope (second order moment) $\\left\\langle X_iX_j\\right\\rangle$ is calculated by th\
e {\\tt EMITTANCE(EMIT)} command and {\\tt Emittance[]} function by solving:\\begin{align}\\left\\langle X_iX_j\\right\\rangle={\\\
rm M}\\left\\langle X_iX_j\\right\\rangle{\\rm M}^T+\\Delta_{ij}\\ ,\\end{align}where $X_i=(x,p_x,y,p_y,z,\\delta)$ is the deviati\
on from the closed orbit at the entrance of the beam line, M the one-turn transfer matrix including the damping, and $\\Delta_{ij}\
$ the one-turn excitation due to synchrotron radiation and intrabeam scattering. The excitation $\\Delta_{ij}$ is affected by the \
envelope in the case of intrabeam ({\\tt INTRA}). The transfer matrix M can be affected by the envelope due to space-charge in the\
 case of {\\tt WSPAC}. Thus iterations are done for such cases.\\\\\\\\In the case of an ideal ring, as the intrinsic vertical emi\
ttance might be too small, the intrabema or space charge effects can be unrealistically large. For such cases, a global variable {\
\\tt MINCOUP} is useful to specify their {\\it minimum} values as:\\begin{align}\\varepsilon_{x,y}={\\tt Max}\\left[\\varepsilon^0\
_{x,y},{\\tt MINCOUP}\\times(\\varepsilon^0_x+\\varepsilon^0_y)\\right]\\ ,\\end{align}where $\\varepsilon^0_{x,y}$ are the emitta\
nces given only by the lattice.;;;2]",""
]</PRE>
<LI>
<H3><A NAME=L56>
Bmag-coefficient</A>
</H3>
<PRE>EquAlign["Text[The $B_{\\rm mag}$ coeeficient represents the mismatch between two optics:\n\\begin{align}B_{\\rm mag}\\equiv\\
\frac{1}{2}\\left[\\frac{\\beta_2}{\\beta_1}+\\frac{\\beta_1}{\\beta_2}+\\beta_1\\beta_2\\left(\\frac{\\alpha_2}{\\beta_2}-\\frac{\
\\alpha_1}{\\beta_1}\\right)^2\\right]\\,.\\end{align}Note that $B_{\\rm mag}\\ge1$. $B_{\\rm mag}$ is conserved through a beam li\
ne unless an additional machine error appears. It is a ratio of the average Courant-Snyder incariant to the emittance.;;;1]",""
 ]
</PRE>
</UL>
<H3><A NAME=L57>
DISPLAY(DISP)</A>
</H3>
<PRE>Usage: DISP_LAY [keywords] [pattern-string] [region]

Displays values of various optical-/geometric-functions at the components given by the pattern-string in the region (see region) in
 the current beam line. It has several display modes specified by the keywords. As the default, it displays AX, BX, NX, EX, EPX, AY
, BY, NY, EY, EPY, LENG, the length and the value of the default-keyword of the component. Each line refers to the entrance of each
 component of the line. The end of the beam line has the name "$$$". The first component can be specified by "^^^".
   DISP suspends the output to the terminal at every 66 lines, asking (q_uit, c_ontinue, a_ll)?. The further output depends on the 
first character of the answer from the terminal input. This dialog is suppressed by specifying ALL.
   DISP does not calculate the functions to be displayed, so CALCULATE(CALC) or GO is necessary whenever values of components are u
pdated.
</PRE>
<UL>
<LI>
<H3><A NAME=L58>
ACCELERATION(A)</A>
</H3>
<PRE>DISP A displays the nominal energy, energy deviation(DDP), longitudinal position(z), and emittances for a transport line with 
accelerating cavities. The flag TRPT must be on.
</PRE>
<LI>
<H3><A NAME=L59>
ALL</A>
</H3>
<PRE>ALL is a word to choose the entire beam line for the region to be displayed. If ALL is given, a dialog at every 66 lines to co
ntrol the output to the terminal is suppressed. Thus "DISP ALL e1 e2" works to suppress the dialog for the output region e1 from e2
.
</PRE>
<LI>
<H3><A NAME=L60>
BEAM(B)</A>
</H3>
<PRE>DISP B displays the beam sizes and the projected Twiss parameters calculated either by Twiss parameters or the EMIT command wi
th the CODPLOT flag.

Example: EMITX=...; EMITY=...;DP=...; 
         BEAMSIZE(BEAM)
         DISP B
</PRE>
<LI>
<H3><A NAME=L61>
DREFERENCE(DRE)</A>
</H3>
<PRE>Display the difference between the reference optics. (beta - betaR)/betaR are displayed for BX, BY, BZ.
</PRE>
<LI>
<H3><A NAME=L62>
DUMPOPTICS(D)</A>
</H3>
<PRE>DISP D displays all matching-functions in one line suitable to be read by a spread-sheet program.
</PRE>
<LI>
<H3><A NAME=L63>
GAMMA(GA)</A>
</H3>
<PRE>DISP GA displays gamma functions for x and y, instead of dispersions, as well as gamma*L, which is nealry equal to the natural
 chromaticity.
</PRE>
<LI>
<H3><A NAME=L64>
GEOMETRY(G)</A>
</H3>
<PRE>DISP G displays geometric information of the beam line. It shows the geometry of the coordinate.
</PRE>
<LI>
<H3><A NAME=L65>
OGEOMETRY(OG)</A>
</H3>
<PRE>DISP OG displays geometric information at the orbit.
</PRE>
<LI>
<H3><A NAME=L66>
ORBIT(O)</A>
</H3>
<PRE>DISP O displays the orbits DX, DPX, DY, DPY together with the other 
optical-functions.
</PRE>
<LI>
<H3><A NAME=L67>
pattern-string</A>
</H3>
<PRE>The components in the current region can be selectively displayed by the DISP command using the pattern-string. The pattern-st
ring is a character string involving the wildcards to match the name of the components. Note that the components are chosen in the 
current region, and the keyword ALL is necessary to extend it to the entire beam line.
</PRE>
<LI>
<H3><A NAME=L68>
PHYSICAL(P)</A>
</H3>
<PRE>DISP P displays the physical dispersions PEX, PEPX, PEY, PEP, together with the 1D optical parameters.
</PRE>
<LI>
<H3><A NAME=L69>
region</A>
</H3>
<PRE>Region for DISPLAY(DISP) is specified as 

        DISP .... begin [end] 

with begin and end having the form name[.order][{+-}offset], or the component number (see components).

Example:   DISP ... QF.2-10 QD+5
           DISP ... 100 200

displays functions starting at 10 elements upstream from the entrance of the second QF through 5 elements downstream from the entra
nce of the first QD. The region for DISP is kept after once set. It is shown in the second part of the prompt when FFSPRMPT is ON, 
and also seen by the STATUS(STAT) command.
   If begin points to a component after end, DISP displays from begin to $$$, then from ^^^ to end.
   ALL can be specified before the region. In such a case, the dialog for the output control is suppressed.
   The components which match the pattern-string in DISP are only chosen in the current region.
</PRE>
<LI>
<H3><A NAME=L70>
REFERENCE(RE)</A>
</H3>
<PRE>Specify the reference optics to be displayed.
</PRE>
<LI>
<H3><A NAME=L71>
RMATRIX(R)</A>
</H3>
<PRE>DISP R displays the components of the x-y coupling matrix R together with the 1D optical parameters. See x-y-coupling.
</PRE>
<LI>
<H3><A NAME=L72>
Z</A>
</H3>
<PRE>DISP Z displays muatching functions related to the Z plane: AZ BZ NZ DZ DDP ZX ZPX ZY ZPY GMZ , which are obtained by CAL/GO w
ith CALC6D.
</PRE>
</UL>
<H3><A NAME=L73>
DRAW</A>
</H3>
<PRE>Usage: DRAW [begin end] fun1 [fun2..] [& fun11 [fun12..]] [element-pattern]

draws a plot of optical functions in multi columns. It calls OpticsPlot internally. Available functions are all matching-functions 
(except LENG, TRX, TRY, GX, GY, GZ, CHI1, CHI2, CHI3) and additional functions. If functions are separated by ampersand (&), these 
are plotted in a separated window.
  Function name preceded by "R" and "D" refer the reference-optics and the difference, respectively.
  If begin- and end-components are specified, the plot region is limited between them. If the end-component comes earlier than the 
begin-components, it wraps the plot around the beam line.
  If the optional element-pattern is given, it draws the beam-line lattice with the labels for elements which match element-pattern
. If LAT is specified for element-pattern, the lattice is drawn without label.
 A character string assigned to TITLE is shown as the FrameLabel on the top of the plot.

 Example:
   TITLE="FCCee_t_202_nosol_16_ipac.sad";
   Draw$Option={Thickness->2};
   DRAW BX BY & EX EY Q*;

<DRAW.png
</PRE>
<UL>
<LI>
<H3><A NAME=L74>
Draw$Option</A>
</H3>
<PRE>
 Draw$Option is a list of rules to specify Graphics options for the entire DRAW. If you need option for each column, use OpticsPlot

</PRE>
</UL>
<H3><A NAME=L75>
DUMP</A>
</H3>
<PRE>Usage: DUMP component-pattern [component-pattern1..]

prints out the current machine errors of components which match component-pattern.
</PRE>
<H3><A NAME=L76>
elements</A>
</H3>
<PRE>An element in FFS represents an object which has a unique name and several keywords with values. This simulates a power supply
 of a magnet. An element has one or more components, which correspond to individual magnets in a beam line. Each component may have
 different values from the values of the corresponding element. This simulates the machine error which varies magnet to magnet
   The value of an element can be saved to or recovered from the element-save-buffer by SAVE or RESET commands. Different beam line
s can share the same element, and their values can be different to each other, but they have the common element-save-buffer. Theref
ore the value of an element can be transferred between beam lines by SAVE and RESET command through the element-save-buffer.
   An element is created only in SAD MAIN level. In the definition, if a keyword is omitted, the previous definition is unchanged. 
All keywords have the default value zero. In FFS, it is only possible to change their values.
</PRE>
<UL>
<LI>
<H3><A NAME=L77>
APERT</A>
</H3>
<PRE>An aperture. Only valid in tracking. A particle with

EquAlign["&\\frac{(x-{\\tt DX})^2}{{\\tt AX}^2}+\\frac{(y-{\\tt DY})^2}{{\\tt AY}^2}<1\\\\ \\&\\&\\ &\\min({\\tt DX1},{\\tt DX2})<x
-{\\tt DX}<\\max({\\tt DX1},{\\tt DX2})\\\\ \\&\\&\\ &\\min({\\tt DY1},{\\tt DY2})<y-{\\tt DY}<\\max({\\tt DY1},{\\tt DY2})","   (x
 - DX)^2/AX^2 + (y - DY)^2/AY^2 < 1\n && Min[DX1, DX2] < x < Max[DX1, DX2]\n && Min[DY1, DY2] < y < Max[DY2, DY2]"]

can pass through the aperture, otherwise it is lost and a message is printed out. If AX or AY is zero (default), they are interpret
ed as infinity. If AX <=> 0 && AY <=> 0 and (DX1 == DX2 or DY1 == DY2) then the aperture is only determined by AX and AY.
</PRE>
<LI>
<H3><A NAME=L78>
BEND</A>
</H3>
<PRE>A bending magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L79>
AE1</A>
</H3>
<PRE>The absolute face angle at the entrance. The effective face angle is E1 * ANGLE + AE1, and a positive angle at the entrance co
rresponds to a surface with dx/ds > 0.
</PRE>
<LI>
<H3><A NAME=L80>
AE2</A>
</H3>
<PRE>The absolute face-angle at the exit to the bending angle. The effective face angle is E2 * ANGLE + AE2, and a positive angle a
t the exit corresponds to a surface with dx/ds &lt 0.
</PRE>
<LI>
<H3><A NAME=L81>
ANGLE</A>
</H3>
<PRE>The bending angle. If positive, it bends the orbit in x-s plane toward negative-x-direction. ANGLE determines the geometry of 
the beam line, while K0 represents a dipole kick on top of the bending angle given by ANGLE, i.e., the total deflection of the beam
 is given of ANGLE + K0.
</PRE>
<LI>
<H3><A NAME=L82>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear Maxwellian fringe is suppressed.
</PRE>
<LI>
<H3><A NAME=L83>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L84>
DROTATE</A>
</H3>
<PRE>Additional rotation in x-y plane to simulate a rotation error. DROTATE does not affect the geometry of the ring.
</PRE>
<LI>
<H3><A NAME=L85>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L86>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L87>
E1</A>
</H3>
<PRE>The ratio of the face-angle at the entrance to the bending angle. The effective face angle is E1 * ANGLE + AE1, and a positive
 angle at the entrance corresponds to a surface with dx/ds > 0. For example, a symmetrically-placed rectangular magnet has
 E1 = 0.5 and E2 = 0.5.
</PRE>
<LI>
<H3><A NAME=L88>
E2</A>
</H3>
<PRE>The ratio of the face-angle at the exit to the bending angle. The effective face angle is E2 * ANGLE + AE2, and a positive ang
le at the exit corresponds to a surface with dx/ds &lt 0. For example, a symmetrically-placed rectangular magnet has E1 = 0.5 and E
2 = 0.5.
</PRE>
<LI>
<H3><A NAME=L89>
F1</A>
</H3>
<PRE>Length of the slope of the field at the edge as:

                By(s) |   *******
                      |  *
                      | *
                      |*
                      *
                     *|
                    * |
                   *  |
        ----*******---+--------- s
                  |       |
                  |<----->|
                  |   F1  |

Only the effects up to y^4 in Hamiltonian are taken into account. A more rigorous definition is

EquAlign["{\\tt F1}=6 \\int_{-\\infty}^\\infty{\\frac{B_y(s)}{B_0}-\\left(\\frac{B_y(s)}{B_0}\\right)^2}ds,","   F1 = 6 Integrate[B
y(s)/B0 - (By(s)/B0)^2, {s, -Inf, Inf}] ,"]

where integration is done over one fringe.

   The transformation of the linear fringe of the entrance of a bend is

EquAlign["\\exp(:V:),\\qquad V=-\\frac{1}{p}\\left(\\frac{{\\tt F1}^2}{24\\rho_b}p_x-\\frac{\\tt F1}{12\\rho_b}y^2\n+\\frac{y^4}{6{
\\tt F1}\\ \\rho_b^2}\\right)","   exp(:V:),   V = -f^2/rhob px/p/24 - f/rhob^2 y^2/p/12 \n                   + 1/rhob^2/f y^4/p/6 
,"]

where f is the length of fringe given by F1, and rhob bending radius at the design momentum. At the exit, the sign of rhob is chang
ed. This linear fringe also changes the path length in the body of the bend as

EquAlign["L'={\\tt L}-\\frac{({\\tt ANGLE\\ F1})^2}{24{\\tt L}}\\frac{\\sin(({\\tt ANGLE}(1-{\\tt E1}-{\\tt E2})-{\\tt AE1}-{\\tt A
E2})/2)}{\\sin({\\tt ANGLE}/2)}","   l'=l-(phi0 f)^2/l/24 Sin[(phi0(1-E1-E2)-AE1-AE2)/2]/Sin[phi0/2]"]

to maintain the geometric position of the design orbit, i.e., you have to increase the bend field a little bit to keep the orbit un
changed. Unlike a quadrupole, the effect of linear fringe is always applied at both the entrance and the exit, otherwise you cannot
 obtain a circular design orbit.

   Use FB1 and FB2 to specify the values of entrance and exit separately.
</PRE>
<LI>
<H3><A NAME=L90>
FB1</A>
</H3>
<PRE>   F1 at the entrance. Actually F1 + FB1 is used at the entrance.
</PRE>
<LI>
<H3><A NAME=L91>
FB2</A>
</H3>
<PRE>   F1 at the exit. Actually F1 + FB2 is used at the exit.
</PRE>
<LI>
<H3><A NAME=L92>
FRINGE</A>
</H3>
<PRE>When FRINGE is non-zero, the effect of the linear fringe F1 is taken into account both at the entrance and the exit.
   The transformation of the linear fringe of the entrance of a bend is

EquAlign["\\exp(:V:),\\qquad V=-\\frac{1}{p}\\left(\\frac{{\\tt F1}^2}{24\\rho_b}p_x-\\frac{\\tt F1}{12\\rho_b}y^2\n+\\frac{y^4}{6{
\\tt F1}\\ \\rho_b^2}\\right)","   exp(:V:),   V = -f^2/rhob px/p/24 - f/rhob^2 y^2/p/12 \n                   + 1/rhob^2/f y^4/p/6 
,"]

where f is the length of fringe given by F1, and rhob bending radius at the design momentum. At the exit, the sign of rhob is chang
ed. This linear fringe also changes the path length in the body of the bend as

EquAlign["L'={\\tt L}-\\frac{({\\tt ANGLE\\ F1})^2}{24{\\tt L}}\\frac{\\sin(({\\tt ANGLE}(1-{\\tt E1}-{\\tt E2})-{\\tt AE1}-{\\tt A
E2})/2)}{\\sin({\\tt ANGLE}/2)}","   l'=l-(phi0 f)^2/l/24 Sin[(phi0(1-E1-E2)-AE1-AE2)/2]/Sin[phi0/2]"]

to maintain the geometric position of the design orbit, i.e., you have to increase the bend field a little bit to keep the orbit un
changed. Unlike a quadrupole, the effect of linear fringe is always applied at both the entrance and the exit, otherwise you cannot
 obtain a circular design orbit.

   Use FB1 and FB2 to specify the values of entrance and exit separately.
</PRE>
<LI>
<H3><A NAME=L93>
K0</A>
</H3>
<PRE>The normal dipole magnetic field component (times the length L).

EquAlign["{\\tt K0}=\\frac{B{\\tt L}}{B\\rho},","   K0 = B^(0)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L94>
K1</A>
</H3>
<PRE>The normal quadrupole magnetic field component (times the length L).

EquAlign["{\\tt K1}=\\frac{B'{\\tt L}}{B\\rho},","   K1 = B^(1)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L95>
L</A>
</H3>
<PRE>The effective length along the arc of the orbit.
</PRE>
<LI>
<H3><A NAME=L96>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L97>
transformation:BEND</A>
</H3>
<PRE>The transformation of a bend depends on the value of K1. If K1 is zero, it is a series of transformations:

    (transformation due to misalignments)
   (drift to the entrance face)
EquAlign["x_2   &= \\frac{x_1}{\\cos\\psi_1 - (p_{x1}/p_{z1})\\sin\\psi_1 }\\,,\\\\\np_{x2}&= p_{x1} \\cos\\psi_1 + p_{z1} \\sin\\p
si_1\\,,\\\\\ny_2   &= y_1 + \\frac{p_{y1}}{p_{z1}}x_2\\sin\\psi_1\\,,\\\\\nz_2   &= z_1 - \\frac{p_1}{p_{z1}} x_2 \\sin\\psi_1\\,,
\\\\\n{\\rm where\\ } \\psi_1 &\\equiv {\\tt ANGLE} \\times {\\tt E1} + {\\tt AE1}","      x2  = x1/(cos(psi1) - sin(psi1) (px1/pz1
))\n      px2 = px1 cos(psi1) + pz1 sin(psi1)\n      y2  = y1 + (py1/pz1) x2 sin(psi1)\n      z2  = z1 - (p1 /pz1) x2 sin(psi1) ,\n
      where psi1 = ANGLE * E1 + AE1"]
   (linear fringe at entrance face)
EquAlign["x_2  =& x_1 + \\varDelta x_{fr} \\frac{p_1 - p_0}{p_1}\\,,\\\\\np_{y2} =& p_{y1} + y_1\\frac{\\varDelta y_{fr} - \\varDel
ta y_{fra} y_1^2}{p_1^2}\\,,\\\\\nz_2  =& z_1 + \\frac{\\varDelta x_{fr} p_{x1} + (\\varDelta y_{fr} - \\varDelta y_{fra} y_1^2/2) 
y_1^2/(2 p_1)}{p_1}\\,,\\\\\n{\\rm where\\ }\\varDelta x_{fr} \\equiv& \\frac{{\\tt F1}^2}{24 \\rho_b}\\,,\\\\\n            \\varDe
lta y_{fr} \\equiv& \\frac{\\tt F1}{6 \\rho_b^2}\\,,\\\\\n            \\varDelta y_{fra}\\equiv& \\frac{2}{3} \\frac{1}{{\\tt F1} \
\rho_b^2}\\,,\\\\\n            \\rho_b \\equiv& \\frac{L'}{{\\tt ANGLE} + {\\tt K0}}\\,,\\\\\nL'\\equiv&{\\tt L}-\\frac{({\\tt ANGL
E\\ F1})^2}{24{\\tt L}}\\\\\n&\\times\\frac{\\sin(({\\tt ANGLE}(1-{\\tt E1}-{\\tt E2})-{\\tt AE1}-{\\tt AE2})/2)}{\\sin({\\tt ANGLE
}/2)}\\,.","      x2  = x1 + dxfr (p1 - p0)/p1\n      py2 = py1 + (dyfr - dyfra y1^2) y1/p1^2\n      z2  = z1 + (dxfr px1 + (dyfr -
 dyfra y1^2/2) y1^2/(2 p1))/p1\n      where dxfr = F1^2/(24 rhob) ,\n            dyfr = F1/(6 rhob^2) ,\n            dyfra= 2/3 1/(
F1 rhob^2) ,\n            rhob = L'/(ANGLE + K0) ,\n            L'   = L - (ANGLE F1)^2 /(24 L)\n                     * sin((ANGLE 
(1 - E1 - E2) - AE1 - AE2)/2)/sin(ANGLE/2)"]
   (nonlinear fringe at entrance)
EquAlign["x_2&=x_1 + y_1^2 (1-\\frac{y_1^2}{12\\rho_b^2}) \\frac{p_1^2}{2 \\rho_b (p_1^2 - p_{x1}^2)^{3/2}}\\,,\\\\\np_{y2}&= p_{y1
} - p_{x1} (1-\\frac{y_1^2}{6\\rho_b^2}) \\frac{y_1}{p_1 \\rho_b \\sqrt{p_1^2 - p_{x1}^2}}\\,,\\\\\nz_2&=z_1  - p_{x1} y_1^2 (1-\\f
rac{y_1^2}{12\\rho_b^2}) \\frac{p_1}{2 \\rho_b (p_1^2 - p_{x1}^2)^{3/2}}\\,.","      x2  = x1  + y1^2 (1-y1^2/rhob^2/12) p1^2/(2 rh
ob (p1^2 - px1^2)^(3/2))\n      py2 = py1 - px1 (1-y1^2/rhob^2/6) y1/(p1 rhob sqrt(p1^2 - px1^2))\n      z2  = z1  - px1 y1^2 (1-y1
^2/rhob^2/12) p1/(2 rhob (p1^2 - px1^2)^(3/2))"]
   (body of bend)
EquAlign["p_{x2}=&-\\frac{\\rho_0}{\\rho_b} (\\sin\\psi_2 + \\sin(\\omega + \\psi_1))\\\\\n            &+ p_{z1}\\sin\\omega  +  p_
{x1}\\cos\\omega - \\frac{x_1}{\\rho_b \\sin\\omega}\\,,\\\\\np_{z2}=&\\sqrt{p_{x1}^2+p_{z1}^2-p_{x2}^2}\\,,\\\\\nx_2 =& x_1 \\cos\
\omega + \\rho_b (p_{z2} - p_{z1}\\cos\\omega + p_{x1}\\sin\\omega)\\\\\n            &+\\rho_0 (\\cos(\\omega+\\psi_1) - \\cos\\psi
_2)\\,,\\\\\ny_2  =& y_1 + s \\frac{p_{y1}}{\\sqrt{p_1^2 - p_{y1}^2}}\\,,\\\\\nz_2  =& z_1 - s \\frac{p_1}{\\sqrt{p_1^2 - p_{y1}^2}
} + \\frac{v_1}{v_0} L'\\,,\\\\\n{\\rm where\\ } \\rho_0  \\equiv& \\frac{L'}{\\tt ANGLE}\\,,\\\\\n\\omega \\equiv& {\\tt ANGLE} - 
\\psi_1 - \\psi_2\\,,\\\\\ns \\equiv&{\\tt ANGLE}\\times\\rho_b\\\\\n&\\times\\left(\\sin^{-1}\\frac{p_{x1}}{\\sqrt{p_1^2 - p_{y1}^
2}}\n                    - \\sin^{-1}\\frac{p_{x2}}{\\sqrt{p_2^2 - p_{y2}^2}} + \\omega\\right)\\,.","      px2 = -rho0/rhob (sin(p
si2) + sin(omega + psi1))\n            + sin(omega) pz1 + cos(omega) px1 - x1/rhob sin(omega)\n      x2  = x1 cos(omega) + rhob (pz
2 - cos(omega) pz1 + sin(omega) px1)\n            + rho0 (cos(omega+psi1) - cos(psi2))\n      y2  = y1 + py1/sqrt(p1^2 - py1^2) s\n
      z2  = z1 - s p1/sqrt(p1^2 - py1^2) + v1/v0 L'\n      where rho0  = L'/ANGLE\n            omega = ANGLE - psi1 - psi2\n       
     s     = rhob ANGLE (arcsin(px1/sqrt(p1^2 - py1^2))\n                    - arcsin(px2/sqrt(p2^2 - py2^2)) + omega)"]
   (nonlinear fringe at exit)
EquAlign["x_2&=x_1 - y_1^2 (1-\\frac{y_1^2}{12\\rho_b^2}) \\frac{p_1^2}{2 \\rho_b (p_1^2 - p_{x1}^2)^{3/2}}\\,,\\\\\np_{y2}&= p_{y1
} + p_{x1} (1-\\frac{y_1^2}{6\\rho_b^2}) \\frac{y_1}{p_1 \\rho_b \\sqrt{p_1^2 - p_{x1}^2}}\\,,\\\\\nz_2&=z_1  + p_{x1} y_1^2 (1-\\f
rac{y_1^2}{12\\rho_b^2}) \\frac{p_1}{2 \\rho_b (p_1^2 - p_{x1}^2)^{3/2}}\\,.","      x2  = x1  - y1^2 (1-y1^2/rhob^2/12) p1^2/(2 rh
ob (p1^2 - px1^2)^(3/2))\n      py2 = py1 + px1 y1 (1-y1^2/rhob^2/6)/(p1 rhob sqrt(p1^2 - px1^2))\n      z2  = z1  + px1 y1^2 (1-y1
^2/rhob^2/12) p1/(2 rhob (p1^2 - px1^2)^(3/2))"]
   (linear fringe at exit face)
EquAlign["x_2  &= x_1 - \\varDelta x_{fr} \\frac{p_1 - p_0}{p_1}\\,,\\\\\np_{y2} &= p_{y1} + y_1\\frac{\\varDelta y_{fr} - \\varDel
ta y_{fra} y_1^2}{p_1^2}\\,,\\\\\nz_2  &= z_1 + \\frac{-\\varDelta x_{fr} p_{x1} + (\\varDelta y_{fr} - \\varDelta y_{fra} y_1^2/2)
 y_1^2/(2 p_1)}{p_1}-\\varDelta z_{fr}\\,,\\\\\n{\\rm where\\ } \\varDelta z_{fr}&\\equiv \\varDelta x_{fr} \\left(\\sin({\\tt ANGL
E\\ E1} + {\\tt AE1}) + \\sin({\\tt ANGLE\\ E2} + {\\tt AE2}) \\right)\\,.","      x2  = x1 - dxfr (p1 - p0)/p1\n      py2 = py1 + 
(dyfr - dyfra y1^2) y1/p1^2\n      z2  = z1 + (-dxfr px1 + (dyfr - dyfra y1^2/2) y1^2/(2 p1))/p1 - dzfr\n      where dzfr = dxfr * 
( sin(ANGLE E1 + AE1) + sin(ANGLE E2 + AE2) )"]
   (drift from the exit face)
EquAlign["p_{x2} =&  p_{x1}\\cos\\psi_2  + p_{z1}\\sin\\psi_2\\,,\\\\\nx_2  =& x_1 (\\cos\\psi_2 + \\frac{p_{x2}}{p_{z2}} \\sin\\ps
i_2)\\,,\\\\\ny_2  =& y_1 + \\frac{p_{y2}}{p_{z2}} x_1 \\sin\\psi_2\\,,\\\\\nz_2  =& z_1 - x_1 \\frac{p_2}{p_{z2}}\\sin\\psi_2\\,,\
\\\,\n{\\rm where\\ } \\psi_2 \\equiv& {\\tt ANGLE} \\times {\\tt E2}\\,.","      px2 =  cos(psi2) px1 + sin(psi2) pz1\n      x2  =
 x1 (cos(psi2) + px2/pz2 sin(psi2))\n      y2  = y1 + py2/pz2 x1 sin(psi2)\n      z2  = z1 - x1 sin(psi2) p2/pz2\n      where psi2 
= ANGLE * E2."]
   (transformation due to misalignments)

If K1 is nonzero, the effects from E1 and E2 are approximated by thin
quadrupoles. Then the body is subdivided into

   1 + floor(sqrt(abs(K1 L')/(12 10^-5 EPS)))

pieces (EPS = 1 is used when EPS = 0), and the bend-body transformation above is done for each piece and the kick from K1 is applie
d alternatively. In FFS optics and Emittance calculations, or when the synchrotron radiation is turned on, the same algorithm as K1
 <> 0 is applied.
</PRE>
</UL>
<LI>
<H3><A NAME=L98>
CAVI</A>
</H3>
<PRE>Accelerating structure.
</PRE>
<UL>
<LI>
<H3><A NAME=L99>
DISFRIN</A>
</H3>
<PRE>If nonzero, the Maxwellian fringe is suppressed. The effects of DISFRIN and FRINGE are summarized as

             DISFRIN=0          DISFRIN<>0
FRINGE=0    entr & exit            none
FRINGE=1       entr                none
FRINGE=2       exit                none
FRINGE=3    entr & exit            none
</PRE>
<LI>
<H3><A NAME=L100>
DPHI</A>
</H3>
<PRE> Relative phase offset. The stable synchrotron phase above the transition is near PHI = 0. The acceleration is given by 

EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring. DPHI is
 not taken into account to determine the design momentum p0(s).
</PRE>
<LI>
<H3><A NAME=L101>
DVOLT</A>
</H3>
<PRE>Additional accelerating voltage to be added to VOLT without affecting the design momentum.
</PRE>
<LI>
<H3><A NAME=L102>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L103>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L104>
FREQ</A>
</H3>
<PRE> Rf frequency. If this keyword is nonzero, the keyword HARM is ignored.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]
</PRE>
<LI>
<H3><A NAME=L105>
HARM</A>
</H3>
<PRE> A harmonic number. This is valid only when FREQ is zero.
</PRE>
<LI>
<H3><A NAME=L106>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L107>
PHI</A>
</H3>
<PRE> Relative phase offset. The stable synchrotron phase above the transition is near PHI = 0. The acceleration is given by 

EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring.
</PRE>
<LI>
<H3><A NAME=L108>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L109>
V02</A>
</H3>
<PRE> The y^2-dependence of the acceleration. Tracking only.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]
</PRE>
<LI>
<H3><A NAME=L110>
V1</A>
</H3>
<PRE> The linear x-dependence of the acceleration. Tracking only.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]
</PRE>
<LI>
<H3><A NAME=L111>
V11</A>
</H3>
<PRE> The xy-dependence of the acceleration. Tracking only.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]
</PRE>
<LI>
<H3><A NAME=L112>
VOLT</A>
</H3>
<PRE>Accelerating peak voltage in Volt.

EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring. (CAVI o
nly) The non-relativistic corrections

     (VOLT+DVOLT)*(2 Pi FREQ/c)^2/(gamma beta)^2/4 are

automatically added to V20 and V02, respectively. The Lorentz factor is evaluated as inverse of average of 1/(beta gamma) at the en
trance and the exit.
   CAVI includes the edge effect at the lowest order, given by a Hamiltonian at the entrance edge at s0:

   Hf = - (e (VOLT+DVOLT)/L)(Sin(omega t - dphi) + Sin(dphi) - offset) (x^2+y^2)/4 delta(s-s0)
 where dphi and offset are determined by the cavity phase and the radiation loss, which is nonzero only in the case of NORAD. The s
ign flips at the exit. This Hamiltonian should be consistent with what Kiyoshi Kubo derived.
</PRE>
</UL>
<LI>
<H3><A NAME=L113>
COORD</A>
</H3>
<PRE>An element for an arbitrary coordinate transformation. This element can be used to express an off-axis element.

Usage: COORD name=(DX=dx DY=dy CHI1=chi1 CHI2=chi2 CHI3=chi3 DIR=dir); .

If dir is zero (default), the transformation of the coordinate by COORD is

EquAlign["\\left(\\begin{matrix} x \\\\y\\\\z\\end{matrix}\\right)_1=\n\\left(\\begin{matrix} c_3 & -s_3 & 0\\\\s_3 & c_3 & 0 \\\\0
&0&1\\end{matrix}\\right)\n\\left(\\begin{matrix}1&0&0\\\\0&c_2&s_2 \\\\0&-s_2&c_2\\end{matrix}\\right)\n\\left(\\begin{matrix}c_1&
0&s_1\\\\0&1&0\\\\-s_1&0&c_1\\end{matrix}\\right)\n\\left(\\begin{matrix} x-{\\tt DX} \\\\y-{\\tt DY}\\\\z\\end{matrix}\\right)_0\\
,,","  {x      {c3 -s3 0     {1  0  0      {c1 0  s1   {x-dx\n   y   =   s3  c3 0      0  c2 s2      0  1  0     y-dy\n   z}_1     
 0   0  1}.    0 -s2 c2}.   -s1 0  c1}.  z   } ,"]

and if dir is nonzero,

EquAlign["\\left(\\begin{matrix} x \\\\y\\\\z\\end{matrix}\\right)_1=\n\\left(\\begin{matrix} c_3 & -s_3 & 0\\\\s_3 & c_3 & 0 \\\\0
&0&1\\end{matrix}\\right)\n\\left(\\begin{matrix}1&0&0\\\\0&c_2&-s_2 \\\\0&s_2&c_2\\end{matrix}\\right)\n\\left(\\begin{matrix}c_1&
0&s_1\\\\0&1&0\\\\-s_1&0&c_1\\end{matrix}\\right)\n\\left(\\begin{matrix} x \\\\y\\\\z\\end{matrix}\\right)_0+\n\\left(\\begin{matr
ix} {\\tt DX} \\\\-{\\tt DY} \\\\0\\end{matrix}\\right)\\,,","  {x      { dx    {c3 -s3 0     {1  0   0      {c1 0  s1   {x\n   y  
 =   -dy  +  s3  c3 0      0  c2 -s2      0  1  0     y\n   z}_1     0 }    0   0  1}.    0  s2  c2}.   -s1 0  c1}.  z} ,"]

where {x, y, z}_1 are the new coordinates and

EquAlign["c_{1,2,3}=&\\cos({\\tt CHI1},{\\tt CHI2},{\\tt CHI3})\\,,\\\\\ns_{1,2,3}=&\\sin({\\tt CHI1},{\\tt CHI2},{\\tt CHI3})\\,."
,"  c1=cos(chi1), s1=sin(chi1), etc."]

Note that these transformationis are NOT the inverse to each other.

   To use this element, you have to calculate the values of those parameters carefully. DISP G may help you but there is no automat
ic way to get them. You may also have to be careful when you use a line with this element in the reverse direction.

   A better way to do an equivalent thing in most cases is to use SOL. Unlike COORD, SOL automatically determines the parameters fo
r the coordinate transformation.
</PRE>
<LI>
<H3><A NAME=L114>
default-keyword</A>
</H3>
<PRE>The default and available non-default variable keywords are:

type    default-keyword  non-default variable keyword
DRIFT   L                -
BEND    ANGLE            K1,K0,E1,E2
QUAD    K1               ROTATE
SEXT    K2               ROTATE
OCT     K3               ROTATE
DECA    K4               ROTATE
DODECA  K5               ROTATE
MULT    K1               K0,K2..K21,SK0,SK1,SK2..SK21,ROTATE,ANGLE
MARK    -                AX,BX,EX,EPX,AY,BY,EY,EPY,R1,R2,R3,R4,DETR,
                         DX,DPX,DY,DPY,DZ,DDP,AZ,BZ,ZX,ZPX,ZY,ZPY
</PRE>
<LI>
<H3><A NAME=L115>
DECA</A>
</H3>
<PRE>A decapole magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L116>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear Maxwellian fringe is suppressed.
</PRE>
<LI>
<H3><A NAME=L117>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L118>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L119>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L120>
K4</A>
</H3>
<PRE>The normal decapole magnetic field component (times the length L).

EquAlign["{\\tt K4}=\\frac{B^{(4)}{\\tt L}}{B\\rho},","   K4 = B^(4)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L121>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L122>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L123>
transformation:THIN</A>
</H3>
<PRE>EquAlign["Text[The transformation of a {\\tt DECA} is given as\n\\begin{align}\n   &\\exp(:F_{\\rm in}:)\\exp(:a {\\tt L}:)\\\
exp(:H_4/2:)\\exp(:b {\\tt L}:)\\nonumber\\\\\n   \\times&\\exp(:V_4:)\\exp(:a {\\tt L}:)\\exp(:H_4/2:)\\exp(:b {\\tt L}:)\\exp(:F\
_{\\rm out}:)\\,,\n\\end{align}\nwhere {\\tt L} and $H_4$ are the Hamiltonians of a drift of length {\\tt L} and a thin decapole k\
ick with integrated strength {\\tt K4}:\n\\begin{align}\n   H_4 = \\frac{{\\tt K4}}{5!} \\Re(x - i y)^{5}\\,,\n\\end{align}\nrespe\
ctively. The coeffients are $a\\equiv 1/2 - 1/\\sqrt{12}$ and $b = 1/2 - a$. Terms $\\exp(:F_{\\rm in}:)$ and $\\exp(:F_{\\rm out}\
:)$ are transformations for entrance and exit nonlinear fringes. The term $\\exp(:V_4:)$ is a correction to adjust the third-order\
 terms in {\\tt L}:\n\\begin{align}\n   V_4 = \\sum_{j=(x,y),k=(x,y)} \n              - \\frac{\\beta}{2}H_{4,k}^2 \n             \
 + \\gamma H_{4,j}H_{4,k} H_{4,j,k}\\,,\n\\end{align}\nwhere $,i$ represents the derivative by $x$ or $y$. We have also introduced\
 two coefficients $\\beta \\equiv 1/6 - 1/\\sqrt{48}$ and $\\gamma = 1/40 - 1/(24 \\sqrt3$)\\,.;;;3]",
"The transformation of a DECA is given as\n\n   exp(:Fin:)exp(:a L:)exp(:H4/2:)exp(:b L:)\n         *exp(:V4:)exp(:a L:)exp(:H4/2:\
)exp(:b L:)exp(:Fout:) ,\n\nwhere L and H4 are Hamiltonians of a drift of length L and a thin quadrupole kick of integrated streng\
th K4:\n\n   H4 = K4/5! Re((x - I y)^5) ,\n\nrespectively. The coeffients are a = 1/2 - 1/sqrt(12) and b = 1/2 - a. Terms exp(:Fin\
:) and exp(:Fout:) are transformations for entrance and exit nonlinear fringes. The term exp(:V4:) is a correction to adjust the t\
hird-order terms in L:\n\n   V4 = (SUM over j=(x,y), k=(x,y)) [\n              - beta/2 (H4,k)^2 \n              + gamma (H4,j H4,\
k H4,j,k)] ,\n\nwhere ,i represents the derivative by x or y. We have also introduced two coefficients beta = 1/6 - 1/sqrt(48) and\
 gamma = 1/40 - 1/24/sqrt(3)."
]</PRE>
</UL>
<LI>
<H3><A NAME=L124>
DODECA</A>
</H3>
<PRE>A dodecapole magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L125>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear Maxwellian fringe is suppressed.
</PRE>
<LI>
<H3><A NAME=L126>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L127>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L128>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L129>
K5</A>
</H3>
<PRE>The normal dodecapole magnetic field component (times the length L).

EquAlign["{\\tt K5}=\\frac{B^{(5)}{\\tt L}}{B\\rho},","   K5 = B^(5)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L130>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L131>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L132>
transformation:THIN</A>
</H3>
<PRE>EquAlign["Text[The transformation of a {\\tt DODECA} is given as\n\\begin{align}\n   &\\exp(:F_{\\rm in}:)\\exp(:a {\\tt L}:)\
\\exp(:H_5/2:)\\exp(:b {\\tt L}:)\\nonumber\\\\\n   \\times&\\exp(:V_5:)\\exp(:a {\\tt L}:)\\exp(:H_5/2:)\\exp(:b {\\tt L}:)\\exp(\
:F_{\\rm out}:)\\,,\n\\end{align}\nwhere {\\tt L} and $H_5$ are the Hamiltonians of a drift of length {\\tt L} and a thin dodecapo\
le kick with integrated strength {\\tt K5}:\n\\begin{align}\n   H_5 = \\frac{{\\tt K5}}{6!} \\Re(x - i y)^{6}\\,,\n\\end{align}\nr\
espectively. The coeffients are $a\\equiv 1/2 - 1/\\sqrt{12}$ and $b = 1/2 - a$. Terms $\\exp(:F_{\\rm in}:)$ and $\\exp(:F_{\\rm \
out}:)$ are transformations for entrance and exit nonlinear fringes. The term $\\exp(:V_5:)$ is a correction to adjust the third-o\
rder terms in {\\tt L}:\n\\begin{align}\n   V_5 = \\sum_{j=(x,y),k=(x,y)} \n              - \\frac{\\beta}{2}H_{5,k}^2 \n         \
     + \\gamma H_{5,j}H_{5,k} H_{5,j,k}\\,,\n\\end{align}\nwhere $,i$ represents the derivative by $x$ or $y$. We have also introd\
uced two coefficients $\\beta \\equiv 1/6 - 1/\\sqrt{48}$ and $\\gamma = 1/40 - 1/(24 \\sqrt3$)\\,.;;;3]",
"The transformation of a DODECA is given as\n\n   exp(:Fin:)exp(:a L:)exp(:H5/2:)exp(:b L:)\n         *exp(:V5:)exp(:a L:)exp(:H5/\
2:)exp(:b L:)exp(:Fout:) ,\n\nwhere L and H5 are Hamiltonians of a drift of length L and a thin 5-pole kick of integrated strength\
 K5:\n\n   H5 = K5/6! Re((x - I y)^6) ,\n\nrespectively. The coeffients are a = 1/2 - 1/sqrt(12) and b = 1/2 - a. Terms exp(:Fin:)\
 and exp(:Fout:) are transformations for entrance and exit nonlinear fringes. The term exp(:V5:) is a correction to adjust the thi\
rd-order terms in L:\n\n   V5 = (SUM over j=(x,y), k=(x,y)) [\n              - beta/2 (H5,k)^2 \n              + gamma (H5,j H5,k \
H5,j,k)] ,\n\nwhere ,i represents the derivative by x or y. We have also introduced two coefficients beta = 1/6 - 1/sqrt(48) and g\
amma = 1/40 - 1/24/sqrt(3)."
]</PRE>
</UL>
<LI>
<H3><A NAME=L133>
DRIFT</A>
</H3>
<PRE>A drift space.
</PRE>
<UL>
<LI>
<H3><A NAME=L134>
L</A>
</H3>
<PRE>The length, can be negative.
</PRE>
<LI>
<H3><A NAME=L135>
RADIUS</A>
</H3>
<PRE>Radius of the vacuum chamber. Effective when SPAC is ON.
</PRE>
<LI>
<H3><A NAME=L136>
transformation:DRIFT</A>
</H3>
<PRE>The transformation of a drift is written as

EquAlign["\\exp(:H:)\\,.","   exp(:H:),"]

with

EquAlign["H(x,p_x,y,p_y,z,p)=(-\\sqrt{p^2-p_x^2-p_y^2}+1-E/v_0){\\tt L}\\,.","   H(x, px, y, py, z, p) = (-(p^2 - px^2 - py^2)^(1/2
) + 1 - E/v0) L ."]
</PRE>
</UL>
<LI>
<H3><A NAME=L137>
keywords</A>
</H3>
<PRE>Available keywords are:	

type    keywords
DRIFT   L RADIUS
BEND    L ROTATE DROTATE DX DY ANGLE K0 K1 E1 E2 AE1 AE2 F1 FB1 FB2 FRINGE DISFRIN DISRAD EPS RANKICK
QUAD    L ROTATE DX DY K1 F1 F2 FRINGE DISFRIN DISRAD EPS
SEXT    L ROTATE DX DY K2 DISFRIN DISRAD
OCT     L ROTATE DX DY K3 DISFRIN DISRAD
DECA    L ROTATE DX DY K4 DISFRIN DISRAD
DODECA  L ROTATE DX DY K5 DISFRIN DISRAD
MULT    L DX DY DZ CHI1 CHI2 ROTATE(=CHI3) K0..K21 SK0..SK21 DISFRIN F1 F2 FRINGE DISRAD EPS VOLT DVOLT HARM PHI DPHI FREQ RADIUS A
NGLE E1 E2 AE1 AE2 DROTATE
SOL     BZ DX DY DZ DPX DPY BOUND GEO CHI1 CHI2 CHI3 DBZ DISFRIN
CAVI    L ROTATE DX DY VOLT DVOLT V1 V20 V11 V02 FREQ PHI HARM RANVOLT RANPHASE DISFRIN FRINGE
TCAVI   L ROTATE DX DY K0 V1 FREQ PHI HARM RANKICK RANPHASE
COORD   DX DY CHI1 CHI2 CHI3 DIR
MARK    AX BX AY BY EX EPX EY EPY R1 R2 R3 R4 DETR DX DPX DY DPY DZ DDP AZ BZ NZ ZX ZPX ZY ZPY EMITX EMITY DP AZ SIGZ GEO OFFSET
APERT   DX1 DX2 DY1 DY2 DP AX AY DX DY
</PRE>
<LI>
<H3><A NAME=L138>
MARK</A>
</H3>
<PRE>MARK elements play special roles in FFS:	

(1) The first element of the beam line must be a MARK element to be used by FFS. In this case the MARK element contains the paramet
ers of the incoming beam (see optical-functions, special-variables EMITX, EMITY, DP). 
(2) The calculated optical parameters at a MARK command is saved by SAVE or STOP commands, then it can be used as the incoming cond
ition of other beam lines which have the same MARK element.	

Example: MARK P1 = (EMITX = .. EMITY = .. DP = ..);
         LINE  A = ( .. P1 ..)
               B = (P1 .. );
         FFS USE = A;
             ...           do matching on LINE A
             SAVE P1       save the parameters at P1
             USE B;        switch to LINE B
             ...           do matching of LINE B whose entrance is to be
                           matched P1.	

(3) If a MARK element has keyword GEO nonzero, this MARK element becomes the origin of the geometric rotation after the last SOL el
ement.
(4) The values of optical-functions of the MARK element at the beginning of the beam line can be specified as matching variables by
 the FREE command.	

 A MARK elements have all optical-functions as its keywords except NX, NY, TRX, TRY, and LENG. Also it has keywords EMITX, EMITY, a
nd DP which give the values of the corresponding special-variables.
</PRE>
<UL>
<LI>
<H3><A NAME=L139>
OFFSET</A>
</H3>
<PRE>OFFSET is a relative position from the current position. A fraction is allowed to specify a location within an element.
   If the MARK at the beginning of a beam line has OFFSET nonzero, the optics calculation starts from the shifted location. If the 
last component of a beam line is a MARK with nonzero OFFSET, the optics calculation stops at the shifted location. The periodic con
dition is applied between those shifted locations.
   The geometric origin and the origin of LENG shift to the first MARK.

Examples:
(1)  LINE A    = ( ...  QF PQFC  ... );
     QUAD QF   = (L=0.3 K1=0.2);
     MARK PQFC = (OFFSET = -0.5);

Here PQFC represents the center of QF.

(2)  LINE A    = ( ...  PQFC QF  ... );

     QUAD QF   = (L=0.3 K1=0.2);
     MARK PQFC = (OFFSET =  1.5);
Here PQFC represents the center of QF, too (consider why). The value of OFFSET is interpreted taking the direction of the LINE into
 account, i.e., a MARK in a line A represents the same location in a line -A.

Restrictions:
(1) The outputs by DISPLAY(DISP) outside of the narrowed region by OFFSET are
    meaningless.
</PRE>
</UL>
<LI>
<H3><A NAME=L140>
MULT</A>
</H3>
<PRE>A magnet with multipoles. Note that the reference plane is defined so that the skew quadrupole component becomes zero.
   It can have a nonzero ANGLE to express a combined function bending magnet with multipoles. Note that the definition of the multi
poles with nonzero ANGLE is very special The current version does not allow nonzero ANGLE inside a solenoid or with acceleration. A
lso the fringe field and emittance calculation are not installed properly for nonzero ANGLE.
</PRE>
<UL>
<LI>
<H3><A NAME=L141>
K0</A>
</H3>
<PRE>The normal dipole magnetic field component (times the length L).

EquAlign["{\\tt K0}=\\frac{B{\\tt L}}{B\\rho},","   K0 = B^(0)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L142>
SK0</A>
</H3>
<PRE>The skew dipole magnetic field component (times the length L).
EquAlign["{\\tt SK0} = \\frac{B{\\tt L}}{B\\rho}\\,,","   SK0 = B^(0)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/1 degree, i
.e., ROTATE = 90 DEG .
</PRE>
<LI>
<H3><A NAME=L143>
K1</A>
</H3>
<PRE>The normal quadrupole magnetic field component (times the length L).

EquAlign["{\\tt K1}=\\frac{B'{\\tt L}}{B\\rho},","   K1 = B^(1)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L144>
SK1</A>
</H3>
<PRE>The skew quadrupole magnetic field component (times the length L).
EquAlign["{\\tt SK1} = \\frac{B'{\\tt L}}{B\\rho}\\,,","   SK1 = B^(1)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/2 degree, i
.e., ROTATE = 45 DEG .
</PRE>
<LI>
<H3><A NAME=L145>
K2</A>
</H3>
<PRE>The normal sextupole magnetic field component (times the length L).

EquAlign["{\\tt K2}=\\frac{B''{\\tt L}}{B\\rho},","   K2 = B^(2)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L146>
SK2</A>
</H3>
<PRE>The skew sextupole magnetic field component (times the length L).
EquAlign["{\\tt SK2} = \\frac{B''{\\tt L}}{B\\rho}\\,,","   SK2 = B^(2)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/3 degree, i
.e., ROTATE = 30 DEG .
</PRE>
<LI>
<H3><A NAME=L147>
K3</A>
</H3>
<PRE>The normal octupole magnetic field component (times the length L).

EquAlign["{\\tt K3}=\\frac{B'''{\\tt L}}{B\\rho},","   K3 = B^(3)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L148>
SK3</A>
</H3>
<PRE>The skew octupole magnetic field component (times the length L).
EquAlign["{\\tt SK3} = \\frac{B'''{\\tt L}}{B\\rho}\\,,","   SK3 = B^(3)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/4 degree, i
.e., ROTATE = 22.5 DEG .
</PRE>
<LI>
<H3><A NAME=L149>
K4</A>
</H3>
<PRE>The normal decapole magnetic field component (times the length L).

EquAlign["{\\tt K4}=\\frac{B^{(4)}{\\tt L}}{B\\rho},","   K4 = B^(4)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L150>
SK4</A>
</H3>
<PRE>The skew decapole magnetic field component (times the length L).
EquAlign["{\\tt SK4} = \\frac{B^{(4)}{\\tt L}}{B\\rho}\\,,","   SK4 = B^(4)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/5 degree, i
.e., ROTATE = 18 DEG .
</PRE>
<LI>
<H3><A NAME=L151>
K5</A>
</H3>
<PRE>The normal dodecapole magnetic field component (times the length L).

EquAlign["{\\tt K5}=\\frac{B^{(5)}{\\tt L}}{B\\rho},","   K5 = B^(5)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L152>
SK5</A>
</H3>
<PRE>The skew dodecapole magnetic field component (times the length L).
EquAlign["{\\tt SK5} = \\frac{B^{(5)}{\\tt L}}{B\\rho}\\,,","   SK5 = B^(5)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/6 degree, i
.e., ROTATE = 15 DEG .
</PRE>
<LI>
<H3><A NAME=L153>
K6</A>
</H3>
<PRE>The normal 14-pole magnetic field component (times the length L).

EquAlign["{\\tt K6}=\\frac{B^{(6)}{\\tt L}}{B\\rho},","   K6 = B^(6)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L154>
SK6</A>
</H3>
<PRE>The skew 14-pole magnetic field component (times the length L).
EquAlign["{\\tt SK6} = \\frac{B^{(6)}{\\tt L}}{B\\rho}\\,,","   SK6 = B^(6)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/7 degree, i
.e., ROTATE = 12.857142857142856 DEG .
</PRE>
<LI>
<H3><A NAME=L155>
K7</A>
</H3>
<PRE>The normal 16-pole magnetic field component (times the length L).

EquAlign["{\\tt K7}=\\frac{B^{(7)}{\\tt L}}{B\\rho},","   K7 = B^(7)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L156>
SK7</A>
</H3>
<PRE>The skew 16-pole magnetic field component (times the length L).
EquAlign["{\\tt SK7} = \\frac{B^{(7)}{\\tt L}}{B\\rho}\\,,","   SK7 = B^(7)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/8 degree, i
.e., ROTATE = 11.25 DEG .
</PRE>
<LI>
<H3><A NAME=L157>
K8</A>
</H3>
<PRE>The normal 18-pole magnetic field component (times the length L).

EquAlign["{\\tt K8}=\\frac{B^{(8)}{\\tt L}}{B\\rho},","   K8 = B^(8)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L158>
SK8</A>
</H3>
<PRE>The skew 18-pole magnetic field component (times the length L).
EquAlign["{\\tt SK8} = \\frac{B^{(8)}{\\tt L}}{B\\rho}\\,,","   SK8 = B^(8)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/9 degree, i
.e., ROTATE = 10 DEG .
</PRE>
<LI>
<H3><A NAME=L159>
K9</A>
</H3>
<PRE>The normal 20-pole magnetic field component (times the length L).

EquAlign["{\\tt K9}=\\frac{B^{(9)}{\\tt L}}{B\\rho},","   K9 = B^(9)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L160>
SK9</A>
</H3>
<PRE>The skew 20-pole magnetic field component (times the length L).
EquAlign["{\\tt SK9} = \\frac{B^{(9)}{\\tt L}}{B\\rho}\\,,","   SK9 = B^(9)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/10 degree, 
i.e., ROTATE = 9 DEG .
</PRE>
<LI>
<H3><A NAME=L161>
K10</A>
</H3>
<PRE>The normal 22-pole magnetic field component (times the length L).

EquAlign["{\\tt K10}=\\frac{B^{(10)}{\\tt L}}{B\\rho},","   K10 = B^(10)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L162>
SK10</A>
</H3>
<PRE>The skew 22-pole magnetic field component (times the length L).
EquAlign["{\\tt SK10} = \\frac{B^{(10)}{\\tt L}}{B\\rho}\\,,","   SK10 = B^(10)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/11 degree, 
i.e., ROTATE = 8.181818181818182 DEG .
</PRE>
<LI>
<H3><A NAME=L163>
K11</A>
</H3>
<PRE>The normal 24-pole magnetic field component (times the length L).

EquAlign["{\\tt K11}=\\frac{B^{(11)}{\\tt L}}{B\\rho},","   K11 = B^(11)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L164>
SK11</A>
</H3>
<PRE>The skew 24-pole magnetic field component (times the length L).
EquAlign["{\\tt SK11} = \\frac{B^{(11)}{\\tt L}}{B\\rho}\\,,","   SK11 = B^(11)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/12 degree, 
i.e., ROTATE = 7.5 DEG .
</PRE>
<LI>
<H3><A NAME=L165>
K12</A>
</H3>
<PRE>The normal 26-pole magnetic field component (times the length L).

EquAlign["{\\tt K12}=\\frac{B^{(12)}{\\tt L}}{B\\rho},","   K12 = B^(12)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L166>
SK12</A>
</H3>
<PRE>The skew 26-pole magnetic field component (times the length L).
EquAlign["{\\tt SK12} = \\frac{B^{(12)}{\\tt L}}{B\\rho}\\,,","   SK12 = B^(12)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/13 degree, 
i.e., ROTATE = 6.923076923076923 DEG .
</PRE>
<LI>
<H3><A NAME=L167>
K13</A>
</H3>
<PRE>The normal 28-pole magnetic field component (times the length L).

EquAlign["{\\tt K13}=\\frac{B^{(13)}{\\tt L}}{B\\rho},","   K13 = B^(13)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L168>
SK13</A>
</H3>
<PRE>The skew 28-pole magnetic field component (times the length L).
EquAlign["{\\tt SK13} = \\frac{B^{(13)}{\\tt L}}{B\\rho}\\,,","   SK13 = B^(13)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/14 degree, 
i.e., ROTATE = 6.428571428571428 DEG .
</PRE>
<LI>
<H3><A NAME=L169>
K14</A>
</H3>
<PRE>The normal 30-pole magnetic field component (times the length L).

EquAlign["{\\tt K14}=\\frac{B^{(14)}{\\tt L}}{B\\rho},","   K14 = B^(14)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L170>
SK14</A>
</H3>
<PRE>The skew 30-pole magnetic field component (times the length L).
EquAlign["{\\tt SK14} = \\frac{B^{(14)}{\\tt L}}{B\\rho}\\,,","   SK14 = B^(14)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/15 degree, 
i.e., ROTATE = 6 DEG .
</PRE>
<LI>
<H3><A NAME=L171>
K15</A>
</H3>
<PRE>The normal 32-pole magnetic field component (times the length L).

EquAlign["{\\tt K15}=\\frac{B^{(15)}{\\tt L}}{B\\rho},","   K15 = B^(15)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L172>
SK15</A>
</H3>
<PRE>The skew 32-pole magnetic field component (times the length L).
EquAlign["{\\tt SK15} = \\frac{B^{(15)}{\\tt L}}{B\\rho}\\,,","   SK15 = B^(15)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/16 degree, 
i.e., ROTATE = 5.625 DEG .
</PRE>
<LI>
<H3><A NAME=L173>
K16</A>
</H3>
<PRE>The normal 34-pole magnetic field component (times the length L).

EquAlign["{\\tt K16}=\\frac{B^{(16)}{\\tt L}}{B\\rho},","   K16 = B^(16)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L174>
SK16</A>
</H3>
<PRE>The skew 34-pole magnetic field component (times the length L).
EquAlign["{\\tt SK16} = \\frac{B^{(16)}{\\tt L}}{B\\rho}\\,,","   SK16 = B^(16)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/17 degree, 
i.e., ROTATE = 5.294117647058823 DEG .
</PRE>
<LI>
<H3><A NAME=L175>
K17</A>
</H3>
<PRE>The normal 36-pole magnetic field component (times the length L).

EquAlign["{\\tt K17}=\\frac{B^{(17)}{\\tt L}}{B\\rho},","   K17 = B^(17)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L176>
SK17</A>
</H3>
<PRE>The skew 36-pole magnetic field component (times the length L).
EquAlign["{\\tt SK17} = \\frac{B^{(17)}{\\tt L}}{B\\rho}\\,,","   SK17 = B^(17)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/18 degree, 
i.e., ROTATE = 5 DEG .
</PRE>
<LI>
<H3><A NAME=L177>
K18</A>
</H3>
<PRE>The normal 38-pole magnetic field component (times the length L).

EquAlign["{\\tt K18}=\\frac{B^{(18)}{\\tt L}}{B\\rho},","   K18 = B^(18)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L178>
SK18</A>
</H3>
<PRE>The skew 38-pole magnetic field component (times the length L).
EquAlign["{\\tt SK18} = \\frac{B^{(18)}{\\tt L}}{B\\rho}\\,,","   SK18 = B^(18)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/19 degree, 
i.e., ROTATE = 4.7368421052631575 DEG .
</PRE>
<LI>
<H3><A NAME=L179>
K19</A>
</H3>
<PRE>The normal 40-pole magnetic field component (times the length L).

EquAlign["{\\tt K19}=\\frac{B^{(19)}{\\tt L}}{B\\rho},","   K19 = B^(19)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L180>
SK19</A>
</H3>
<PRE>The skew 40-pole magnetic field component (times the length L).
EquAlign["{\\tt SK19} = \\frac{B^{(19)}{\\tt L}}{B\\rho}\\,,","   SK19 = B^(19)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/20 degree, 
i.e., ROTATE = 4.5 DEG .
</PRE>
<LI>
<H3><A NAME=L181>
K20</A>
</H3>
<PRE>The normal 42-pole magnetic field component (times the length L).

EquAlign["{\\tt K20}=\\frac{B^{(20)}{\\tt L}}{B\\rho},","   K20 = B^(20)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L182>
SK20</A>
</H3>
<PRE>The skew 42-pole magnetic field component (times the length L).
EquAlign["{\\tt SK20} = \\frac{B^{(20)}{\\tt L}}{B\\rho}\\,,","   SK20 = B^(20)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/21 degree, 
i.e., ROTATE = 4.285714285714286 DEG .
</PRE>
<LI>
<H3><A NAME=L183>
K21</A>
</H3>
<PRE>The normal 44-pole magnetic field component (times the length L).

EquAlign["{\\tt K21}=\\frac{B^{(21)}{\\tt L}}{B\\rho},","   K21 = B^(21)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L184>
SK21</A>
</H3>
<PRE>The skew 44-pole magnetic field component (times the length L).
EquAlign["{\\tt SK21} = \\frac{B^{(21)}{\\tt L}}{B\\rho}\\,,","   SK21 = B^(21)L/(Brho),"]

where L is the length of the component. Positive sign means a horizontally focusing magnet rotated around z-axis by -90/22 degree, 
i.e., ROTATE = 4.090909090909091 DEG .
</PRE>
<LI>
<H3><A NAME=L185>
AE1</A>
</H3>
<PRE>The absolute face angle at the entrance. The effective face angle is E1 * ANGLE + AE1, and a positive angle at the entrance co
rresponds to a surface with dx/ds > 0.
</PRE>
<LI>
<H3><A NAME=L186>
AE2</A>
</H3>
<PRE>The absolute face-angle at the exit to the bending angle. The effective face angle is E2 * ANGLE + AE2, and a positive angle a
t the exit corresponds to a surface with dx/ds &lt 0.
</PRE>
<LI>
<H3><A NAME=L187>
ANGLE</A>
</H3>
<PRE>The bending angle. If positive, it bends the orbit in x-s plane toward negative-x-direction. ANGLE determines the geometry of 
the beam line, while K0 represents a dipole kick on top of the bending angle given by ANGLE, i.e., the total deflection of the beam
 is given of ANGLE + K0.
</PRE>
<LI>
<H3><A NAME=L188>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear maxwellian fringe is suppressed. The effects of DISFRIN and FRINGE are summarized as

                   DISFRIN=0                   DISFRIN<>0
             Nonlinear      Linear       Nonlinear     Linear
FRINGE=0    entr & exit      none          none         none
FRINGE=1       entr          entr          none         entr
FRINGE=2       exit          exit          none         exit
FRINGE=3    entr & exit   entr & exit      none      entr & exit


</PRE>
<LI>
<H3><A NAME=L189>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L190>
DPHI</A>
</H3>
<PRE>Relative phase offset. The stable synchrotron phase above the transition is near PHI = 0. The acceleration is given as 

EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring. DPHI is
 not taken into account to determine the design momentum p0(s).
</PRE>
<LI>
<H3><A NAME=L191>
DVOLT</A>
</H3>
<PRE>Additional accelerating peak voltage to be added to Volt, without affecting the design momentum p0(s).
</PRE>
<LI>
<H3><A NAME=L192>
E1</A>
</H3>
<PRE>The ratio of the face-angle at the entrance to the bending angle. The effective face angle is E1 * ANGLE + AE1, and a positive
 angle at the entrance corresponds to a surface with dx/ds > 0. For example, a symmetrically-placed rectangular magnet has
 E1 = 0.5 and E2 = 0.5.
</PRE>
<LI>
<H3><A NAME=L193>
E2</A>
</H3>
<PRE>The ratio of the face-angle at the exit to the bending angle. The effective face angle is E2 * ANGLE + AE2, and a positive ang
le at the exit corresponds to a surface with dx/ds &lt 0. For example, a symmetrically-placed rectangular magnet has E1 = 0.5 and E
2 = 0.5.
</PRE>
<LI>
<H3><A NAME=L194>
F1</A>
</H3>
<PRE>EquAlign["Text[{\\tt F1} and {\\tt F2} are parameters to characterize the slope of the field at the edges defined as:\n\\begin
{align}\n{\\tt F1} =& {\\rm sgn}(a)\\sqrt a,\\qquad a \\equiv 24\\left(\\frac{I_0^2}{2} - I_1\\right)\\,,\\\\\n{\\tt F2} =& I_2 - \
\frac{I_0^3}{3}\\\\\n{\\rm with\\ }I_n \\equiv& \\int_{-\\infty}^\\infty(s-s0)^n \\frac{K_1(s)}{K_{10}}ds\\,,\n\\end{align}\nwhere 
$s_0$ is the location of the edge where the effective length is defined, and $K_{10}={\\tt K1}/{\\tt L}$.;;;3]","F1 and F2 are para
meters to characterize the slope of the field at the edges defined as:\n\n     F1 = SIGN(Sqrt[a],a),    a = 24(I_0^2/2 - I_1),\n   
  F2 = I_2 - I_0^3/3\nwith\n     I_n = Integrate[(s-s0)^n K1[s]/K1_0,{s,-Infinity,Infinity}],\n\nwhere s0 is the location of the ed
ge where the effective length is defined, and K1_0 is the nominal value of K1, given by the keyword K1."]
   The effects only in the first order of K1 is taken into account.
</PRE>
<LI>
<H3><A NAME=L195>
F2</A>
</H3>
<PRE>EquAlign["Text[{\\tt F1} and {\\tt F2} are parameters to characterize the slope of the field at the edges defined as:\n\\begin
{align}\n{\\tt F1} =& {\\rm sgn}(a)\\sqrt a,\\qquad a \\equiv 24\\left(\\frac{I_0^2}{2} - I_1\\right)\\,,\\\\\n{\\tt F2} =& I_2 - \
\frac{I_0^3}{3}\\\\\n{\\rm with\\ }I_n \\equiv& \\int_{-\\infty}^\\infty(s-s0)^n \\frac{K_1(s)}{K_{10}}ds\\,,\n\\end{align}\nwhere 
$s_0$ is the location of the edge where the effective length is defined, and $K_{10}={\\tt K1}/{\\tt L}$.;;;3]","F1 and F2 are para
meters to characterize the slope of the field at the edges defined as:\n\n     F1 = SIGN(Sqrt[a],a),    a = 24(I_0^2/2 - I_1),\n   
  F2 = I_2 - I_0^3/3\nwith\n     I_n = Integrate[(s-s0)^n K1[s]/K1_0,{s,-Infinity,Infinity}],\n\nwhere s0 is the location of the ed
ge where the effective length is defined, and K1_0 is the nominal value of K1, given by the keyword K1."]
   The effects only in the first order of K1 is taken into account.
</PRE>
<LI>
<H3><A NAME=L196>
FB1</A>
</H3>
<PRE>Linear Fringe length F1 for the K0 component at the entrance.
</PRE>
<LI>
<H3><A NAME=L197>
FB2</A>
</H3>
<PRE>Linear Fringe length F1 for the K0 component at the exit.
</PRE>
<LI>
<H3><A NAME=L198>
FREQ</A>
</H3>
<PRE> Rf frequency. If this keyword is nonzero, the keyword HARM is ignored.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]
</PRE>
<LI>
<H3><A NAME=L199>
FRINGE</A>
</H3>
<PRE>The effects of the linear fringe (characterized by F1 and F2), and the nonlinear Mexwellian fringe are controled as:

                   DISFRIN=0                   DISFRIN<>0
             Nonlinear      Linear       Nonlinear     Linear
FRINGE=0    entr & exit      none          none         none
FRINGE=1       entr          entr          none         entr
FRINGE=2       exit          exit          none         exit
FRINGE=3    entr & exit   entr & exit      none      entr & exit


</PRE>
<LI>
<H3><A NAME=L200>
HARM</A>
</H3>
<PRE> A harmonic number. This is valid only when FREQ is zero.
</PRE>
<LI>
<H3><A NAME=L201>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L202>
misalignments</A>
</H3>
<PRE>Misalignments of a MULT element are expressed by the keywords DX, DY, DZ, CHI1, CHI2, and ROTATE(=CHI3). They specify all misa
lignments of a rigid body,  At the entrance of MULT, the coordinates of a particle are transformed as

EquAlign["\\left(\\begin{matrix}x\\\\y\\\\\\varDelta s\\end{matrix}\\right)_1=\n\\left(\\begin{matrix} c_3 & -s_3 & 0\\\\s_3 & c_3 
& 0 \\\\0&0&1\\end{matrix}\\right)\n\\left(\\begin{matrix}1&0&0\\\\0&c_2&-s_2 \\\\0&s_2&c_2\\end{matrix}\\right)\n\\left(\\begin{ma
trix}c_1&0&-s_1\\\\0&1&0\\\\s_1&0&c_1\\end{matrix}\\right)\n\\left(\\begin{matrix} x-{\\tt DX} \\\\y-{\\tt DY}\\\\-{\\tt DZ}\\end{m
atrix}\\right)_0\\,,","   { x  }    {  c3 -s3  0  } {  1   0   0  } {  c1  0  -s1 } { x - DX }\n   { y  }  = {  s3  c3  0  } {  0  
 c2 -s2 } {  0   1   0  } { y - DY }\n   { ds }1   {  0   0   1  }.{  0   s2  c2 }.{  s1  0   c1 }.{   - DZ } ,"]

where c1 and s1 are Cos[CHI1] and Sin[CHI1], etc. The inverse is applied at the exit.
   Those misalignments are also valid within a solenoid.
   Other straight elements such as QUAD or THIN do not and will not have these full misalignment specifications, because they can b
e substituted by MULT.
   The geometry of the design orbit is determined by the saved values of CHI1, CHI2, and DZ, while the current values are used for 
DX, DY, and ROTATE.
</PRE>
<LI>
<H3><A NAME=L203>
multipole_with_nonzero_ANGLE</A>
</H3>
<PRE>The multipoles in MULT with nonzero ANGLE are defined by

EquAlign["H =& ... + A_s(x, y)\\,,\\\\\nA_s(x, y) =& \\sum_{k,n=0}^\\infty g_{kn} \\frac{{\\tt K}n + i {\\tt SK}n}{(n + 1)!} (\\rho
 + x)^{1/2 - k}\\times \\frac{(x + i y)^{n + k}}{\\sqrt\\rho}\\,,\\\\\n{\\rm with\\ }g_{kn}\\equiv& - \\frac{(2k - 1)!! (2k - 3)!! 
(n + 1)!}{8^k (n + k + 1)! k!}\\,,\\\\\n\\rho\\equiv&\\frac{\\tt L}{\\tt ANGLE}\\,.","   H = ... + As(x, y) ,\n\n   As(x, y) = Sum[
 g_kn (Kn + I SKn)/(n + 1)! (rho + x)^(1/2 - k)\n                  * (x + I y)^(n + k) / rho^(1/2),\n                  {k, 0, Infin
ity}, {n, 0, nmax}]\n\nwith   g_kn = - (2k - 1)!! (2k - 3)!! (n + 1)! / (8^k (n + k + 1)! k!) ,\nand    rho = L/ANGLE ."]
Actually the summation is truncated at n + k <= 21 in the current version. While this definition converges to the regular one for m
ultipoles when ANGLE -> 0, K0 and K1 of MULT are different from those of BEND.
</PRE>
<LI>
<H3><A NAME=L204>
PHI</A>
</H3>
<PRE>Relative phase offset. The stable synchrotron phase above the transition is near PHI = 0. 
The acceleration is given as 

EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring.
</PRE>
<LI>
<H3><A NAME=L205>
RADIUS</A>
</H3>
<PRE>Radius of the vacuum chamber. Effective when SPAC is ON.
</PRE>
<LI>
<H3><A NAME=L206>
VOLT</A>
</H3>
<PRE>Accelerating peak voltage in Volt.
EquAlign["\\varDelta E =& - e*\\left({\\tt VOLT}+{\\tt DVOLT} +{\\tt V1}\\ x+\\frac{{\\tt V20}\\ x^2+{\\tt V02}\\ y^2}{2}+{\\tt V11
}\\ x y\\right)\\\\\n&\\times \\sin(2\\pi\\ {\\tt FREQ}(t-t_s) + {\\tt PHI} + {\\tt DPHI})\\,,","     dE = - e*(VOLT+DVOLT +V1 x+V2
0 x^2/2+V11 x y+V02 y^2/2)\n                *Sin[2 Pi FREQ (t-ts) + PHI + DPHI],"]

where ts is the equilibrium time determined by the valance between the acceleration and the radiation loss around the ring.
</PRE>
</UL>
<LI>
<H3><A NAME=L207>
OCT</A>
</H3>
<PRE>A octupole magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L208>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear Maxwellian fringe is suppressed.
</PRE>
<LI>
<H3><A NAME=L209>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L210>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L211>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L212>
K3</A>
</H3>
<PRE>The normal octupole magnetic field component (times the length L).

EquAlign["{\\tt K3}=\\frac{B'''{\\tt L}}{B\\rho},","   K3 = B^(3)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L213>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L214>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L215>
transformation:THIN</A>
</H3>
<PRE>EquAlign["Text[The transformation of a {\\tt OCT} is given as\n\\begin{align}\n   &\\exp(:F_{\\rm in}:)\\exp(:a {\\tt L}:)\\e\
xp(:H_3/2:)\\exp(:b {\\tt L}:)\\nonumber\\\\\n   \\times&\\exp(:V_3:)\\exp(:a {\\tt L}:)\\exp(:H_3/2:)\\exp(:b {\\tt L}:)\\exp(:F_\
{\\rm out}:)\\,,\n\\end{align}\nwhere {\\tt L} and $H_3$ are the Hamiltonians of a drift of length {\\tt L} and a thin octupole ki\
ck with integrated strength {\\tt K3}:\n\\begin{align}\n   H_3 = \\frac{{\\tt K3}}{4!} \\Re(x - i y)^{4}\\,,\n\\end{align}\nrespec\
tively. The coeffients are $a\\equiv 1/2 - 1/\\sqrt{12}$ and $b = 1/2 - a$. Terms $\\exp(:F_{\\rm in}:)$ and $\\exp(:F_{\\rm out}:\
)$ are transformations for entrance and exit nonlinear fringes. The term $\\exp(:V_3:)$ is a correction to adjust the third-order \
terms in {\\tt L}:\n\\begin{align}\n   V_3 = \\sum_{j=(x,y),k=(x,y)} \n              - \\frac{\\beta}{2}H_{3,k}^2 \n              \
+ \\gamma H_{3,j}H_{3,k} H_{3,j,k}\\,,\n\\end{align}\nwhere $,i$ represents the derivative by $x$ or $y$. We have also introduced \
two coefficients $\\beta \\equiv 1/6 - 1/\\sqrt{48}$ and $\\gamma = 1/40 - 1/(24 \\sqrt3$)\\,.;;;3]",
"The transformation of a OCT is given as\n\n   exp(:Fin:)exp(:a L:)exp(:H3/2:)exp(:b L:)\n         *exp(:V3:)exp(:a L:)exp(:H3/2:)\
exp(:b L:)exp(:Fout:) ,\n\nwhere L and H3 are Hamiltonians of a drift of length L and a thin 3-pole kick of integrated strength K3\
:\n\n   H3 = K3/4! Re((x - I y)^4) ,\n\nrespectively. The coeffients are a = 1/2 - 1/sqrt(12) and b = 1/2 - a. Terms exp(:Fin:) an\
d exp(:Fout:) are transformations for entrance and exit nonlinear fringes. The term exp(:V3:) is a correction to adjust the third-\
order terms in L:\n\n   V3 = (SUM over j=(x,y), k=(x,y)) [\n              - beta/2 (H3,k)^2 \n              + gamma (H3,j H3,k H3,\
j,k)] ,\n\nwhere ,i represents the derivative by x or y. We have also introduced two coefficients beta = 1/6 - 1/sqrt(48) and gamm\
a = 1/40 - 1/24/sqrt(3)."
]</PRE>
</UL>
<LI>
<H3><A NAME=L216>
QUAD</A>
</H3>
<PRE>A quadrupole magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L217>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear maxwellian fringe is suppressed. The effects of DISFRIN and FRINGE are summarized as

                   DISFRIN=0                   DISFRIN<>0
             Nonlinear      Linear       Nonlinear     Linear
FRINGE=0    entr & exit      none          none         none
FRINGE=1       entr          entr          none         entr
FRINGE=2       exit          exit          none         exit
FRINGE=3    entr & exit   entr & exit      none      entr & exit


</PRE>
<LI>
<H3><A NAME=L218>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L219>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L220>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L221>
F1</A>
</H3>
<PRE>EquAlign["Text[{\\tt F1} and {\\tt F2} are parameters to characterize the slope of the field at the edges defined as:\n\\begin
{align}\n{\\tt F1} =& {\\rm sgn}(a)\\sqrt a,\\qquad a \\equiv 24\\left(\\frac{I_0^2}{2} - I_1\\right)\\,,\\\\\n{\\tt F2} =& I_2 - \
\frac{I_0^3}{3}\\\\\n{\\rm with\\ }I_n \\equiv& \\int_{-\\infty}^\\infty(s-s0)^n \\frac{K_1(s)}{K_{10}}ds\\,,\n\\end{align}\nwhere 
$s_0$ is the location of the edge where the effective length is defined, and $K_{10}={\\tt K1}/{\\tt L}$.;;;3]","F1 and F2 are para
meters to characterize the slope of the field at the edges defined as:\n\n     F1 = SIGN(Sqrt[a],a),    a = 24(I_0^2/2 - I_1),\n   
  F2 = I_2 - I_0^3/3\nwith\n     I_n = Integrate[(s-s0)^n K1[s]/K1_0,{s,-Infinity,Infinity}],\n\nwhere s0 is the location of the ed
ge where the effective length is defined, and K1_0 is the nominal value of K1, given by the keyword K1."]
   The effects only in the first order of K1 is taken into account.
</PRE>
<LI>
<H3><A NAME=L222>
F2</A>
</H3>
<PRE>EquAlign["Text[{\\tt F1} and {\\tt F2} are parameters to characterize the slope of the field at the edges defined as:\n\\begin
{align}\n{\\tt F1} =& {\\rm sgn}(a)\\sqrt a,\\qquad a \\equiv 24\\left(\\frac{I_0^2}{2} - I_1\\right)\\,,\\\\\n{\\tt F2} =& I_2 - \
\frac{I_0^3}{3}\\\\\n{\\rm with\\ }I_n \\equiv& \\int_{-\\infty}^\\infty(s-s0)^n \\frac{K_1(s)}{K_{10}}ds\\,,\n\\end{align}\nwhere 
$s_0$ is the location of the edge where the effective length is defined, and $K_{10}={\\tt K1}/{\\tt L}$.;;;3]","F1 and F2 are para
meters to characterize the slope of the field at the edges defined as:\n\n     F1 = SIGN(Sqrt[a],a),    a = 24(I_0^2/2 - I_1),\n   
  F2 = I_2 - I_0^3/3\nwith\n     I_n = Integrate[(s-s0)^n K1[s]/K1_0,{s,-Infinity,Infinity}],\n\nwhere s0 is the location of the ed
ge where the effective length is defined, and K1_0 is the nominal value of K1, given by the keyword K1."]
   The effects only in the first order of K1 is taken into account.
</PRE>
<LI>
<H3><A NAME=L223>
FRINGE</A>
</H3>
<PRE>The effects of the linear fringe (characterized by F1 and F2), and the nonlinear Mexwellian fringe are controled as:

                   DISFRIN=0                   DISFRIN<>0
             Nonlinear      Linear       Nonlinear     Linear
FRINGE=0    entr & exit      none          none         none
FRINGE=1       entr          entr          none         entr
FRINGE=2       exit          exit          none         exit
FRINGE=3    entr & exit   entr & exit      none      entr & exit


</PRE>
<LI>
<H3><A NAME=L224>
K1</A>
</H3>
<PRE>The normal quadrupole magnetic field component (times the length L).

EquAlign["{\\tt K1}=\\frac{B'{\\tt L}}{B\\rho},","   K1 = B^(1)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L225>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L226>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L227>
transformation:QUAD</A>
</H3>
<PRE>The transformation in a QUAD is a sequence of:

   (nonlinear fringe at entrance)
EquAlign["Text[\\begin{align} G(x_1, p_{x2}, y_1, p_{y2}, p_1) =& H_0(x_1, p_{x2}, y_1, p_{y2}, p_1)+\\frac{1}{2}\\left(\\frac{\\pa
rtial H_0}{\\partial x_1} \\frac{\\partial H_0}{\\partial p_{x2}} + \\frac{\\partial H_0}{\\partial y_1} \\frac{\\partial H_0}{\\pa
rtial p_{y2}}\\right)\\,,\\end{align}where \n\\begin{align}H_0  &=  p_{x2} \\varDelta x_1 + p_{y2} \\varDelta y_1\\,,\\\\\\varDelta
 x_1 &=  x_1 (a/3 + b)\\\\\\varDelta y_1 &= -y_1 (a + b/3)\\\\a&=  {\\tt K1} \\frac{x_1^2}{4p_1}\\\\b&=  {\\tt K1} \\frac{y_1^2}{4 
p1}\\,.\\end{align}\\\\;;;6]","      canonical transformation by a generating function\n\n      G(x1, px2, y1, py2, p1) = H0(x1, px
2, y1, py2, p1)\n                + (D[H0, x1] D[H0, px2] + D[H0, y1] D[H0, py2])/2\n\n      where H0  =  px2 dx1 + py2 dy1\n       
     dx1 =  x1 (a/3 + b)\n            dy1 = -y1 (a + b/3)\n            a   =  K1 x1^2/p1/4\n            b   =  K1 y1^2/p1/4 ."]
   (linear fringe at entrance)
EquAlign["Text[\\begin{align}      p_{x2} &= \\exp(-a) p_{x1}\\,,\\\\      p_{y2} &= \\exp( a)  p_{y1}\\,,\\\\      x_2  &= \\exp( 
a)x_1 + b p_{x1}\\,,\\\\      y_2  &= \\exp(-a)y_1 - b p_{y1}\\,,\\\\      z_2  &= z_1 - (a x_1 + b (1 + a/2) p_{x2}) p_{x1}       
        + (a y_1 + b (1 - a/2) p_{y2}) p_{y1}\\,,\\end{align}      where\\begin{align} a &= -{\\tt K1 F1} \\frac{|{\\tt F1}|}{24 p_
1 {\\tt L}}\\,,\\\\            b &=\\frac{\\tt K1 F2}{\\tt L}\\,.\\end{align};;;7]","      px2 = exp(-a) px1\n      py2 = exp(a)  p
y1\n      x2  = exp(a)  x1 + b px1\n      y2  = exp(-a) y1 - b py1\n      z2  = z1 - (a x1 + b (1 + a/2) px2) px1\n               +
 (a y1 + b (1 - a/2) py2) py1\n      where a = -K1 F1 abs(F1)/(24 p1 L)\n            b =  K1 F2/L ."]
   (body of quad)
EquAlign["Text[The body is subdivided into\\begin{align} n = 1 + {\\tt Floor}\\left[\\frac{10 |{\\tt K1 L}|}{\\tt EPS}\\right]\\end
{align}slices. {\\tt EPS} = 1 is used when {\\tt EPS} = 0. Then a transversely linear transformation $\\exp(:H_{2n}:)$ is applied i
n each slice with\\begin{align}H_{2n} = \\frac{1}{n}\\left\\lbrace\\left(-p + \\frac{p_x^2 + p_y^2}{2 p} + \\frac{E}{v_0}\\right){\
\tt L} + \\frac{\\tt K1}{2} (x^2 - y^2)\\right\\rbrace\\,.\\end{align}\\\\Between slices the correction $\\exp(:\\varDelta H:)$ for
 the kinematical term\\begin{align}\\varDelta H = \\frac{1}{n}\\left(p-\\sqrt{p^2 - p_x^2 -p_y^2} - \\frac{p_x^2 + p_y^2}{2 p}\\rig
ht) {\\tt L}\\end{align}is applied. In a solenoid, the forms of $H_{2n}$ and $\\varDelta H$ are modified.\\;;;3]","      The body i
s subdivided in n = 1 + floor(10 abs(K1 L)/EPS) (EPS = 1\n      is used when EPS = 0), then a transversely linear transformation\n 
     exp(:H:) is done in each slice with\n\n         H = ((-p + (px^2 + py^2)/(2 p) + E/v0) L + K1 (x^2 - y^2)/2)/n .\n\n      Betw
een slices applied is the correction exp(:dH:) for the kinematical\n      term with\n\n         dH = (-sqrt(p^2 - px^2 -py^2) + p -
 (px^2 + py^2)/(2 p)) L/n .\n\n      In a solenoid, the forms of H and dH are modified."]
   (linear fringe at exit)
EquAlign["Text[\\begin{align}      p_{x2} &= \\exp( a) p_{x1}\\,,\\\\      p_{y2} &= \\exp(-a)  p_{y1}\\,,\\\\      x_2  &= \\exp(-
a)x_1 + b p_{x1}\\,,\\\\      y_2  &= \\exp( a)y_1 - b p_{y1}\\,,\\\\      z_2  &= z_1 + (a x_1 - b (1 - a/2) p_{x2}) p_{x1}       
        - (a y_1 - b (1 + a/2) p_{y2}) p_{y1}\\,,\\end{align}      where\\begin{align} a &= -{\\tt K1 F1} \\frac{|{\\tt F1}|}{24 p_
1 {\\tt L}}\\,,\\\\            b &=\\frac{\\tt K1 F2}{\\tt L}\\,.\\end{align}\\;;;7]","      px2 = exp( a)  px1\n      py2 = exp(-a
) py1\n      x2  = exp(-a) x1 + b px1\n      y2  = exp( a) y1 - b py1\n      z2  = z1 + (a x1 - b (1 - a/2) px2) px1\n             
  - (a y1 - b (1 + a/2) py2) py1\n      where a = -K1 F1 abs(F1)/(24 p1 L)\n            b =  K1 F2/L ."]
   (nonlinear fringe at exit)
EquAlign["Text[a canonical transformation by a generating function:\n\\begin{align}\nG(x_1, p_{x2}, y_1, p_{y2}, p_1) = H_0(x_1, p_
{x2}, y_1, p_{y2}, p_1) + \\frac{1}{2}\\left(\\frac{\\partial H_0}{\\partial x_1} \\frac{\\partial H_0}{\\partial p_{x2}} + \\frac{
\\partial H_0}{\\partial y_1} \\frac{\\partial H_0}{\\partial p_{y2}}\\right)\\,,\n\\end{align}\nwhere\n\\begin{align}\n H_0&= p_{x
2} \\varDelta x_1 + p_{y2} \\varDelta y_1\\,,\\\\\n \\varDelta x_1 &=  x_1 (a/3 + b)\\,,\\\\\n \\varDelta y_1 &= -y_1 (a + b/3)\\,,
\\\\\n a &= -{\\tt K1} \\frac{x_1^2}{4p_1}\\,,\\\\\n b &= -{\\tt K1} \\frac{y_1^2}{4p_1}\\,.\n\\end{align};;;6]","      canonical t
ransformation by a generating function\n\n      G(x1, px2, y1, py2, p1) = H0(x1, px2, y1, py2, p1)\n                + (D[H0, x1] D[
H0, px2] + D[H0, y1] D[H0, py2])/2\n\n      where H0  =  px2 dx1 + py2 dy1\n            dx1 =  x1 (a/3 + b)\n            dy1 = -y1 
(a + b/3)\n            a   = -K1 x1^2/p1/4\n            b   = -K1 y1^2/p1/4 ."]
</PRE>
</UL>
<LI>
<H3><A NAME=L228>
SEXT</A>
</H3>
<PRE>A sextupole magnet.
</PRE>
<UL>
<LI>
<H3><A NAME=L229>
DISFRIN</A>
</H3>
<PRE>If nonzero, the nonlinear Maxwellian fringe is suppressed.
</PRE>
<LI>
<H3><A NAME=L230>
DISRAD</A>
</H3>
<PRE>If nonzero, the synchrotron radiation in the particle-tracking is inhibited.
</PRE>
<LI>
<H3><A NAME=L231>
DX</A>
</H3>
<PRE>Horizontal displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L232>
DY</A>
</H3>
<PRE>Vertical displacement of magnet. This applied before the rotation by ROTATE.
</PRE>
<LI>
<H3><A NAME=L233>
K2</A>
</H3>
<PRE>The normal sextupole magnetic field component (times the length L).

EquAlign["{\\tt K2}=\\frac{B''{\\tt L}}{B\\rho},","   K2 = B^(2)L/(Brho),"]

where L is the effective length of the component. Positive sign means horizontal focusing.
</PRE>
<LI>
<H3><A NAME=L234>
L</A>
</H3>
<PRE>The effective length.
</PRE>
<LI>
<H3><A NAME=L235>
ROTATE</A>
</H3>
<PRE>Rotation in x-y plane. After displacing the magnet by DX and DY, rotate the magnet around the local s-axis by -(amount given b
y ROTATE), then place the component. At the exit rotate back the magnet around the local s-axis at the exit, then take out displace
ment.
</PRE>
<LI>
<H3><A NAME=L236>
transformation:THIN</A>
</H3>
<PRE>EquAlign["Text[The transformation of a {\\tt SEXT} is given as\n\\begin{align}\n   &\\exp(:F_{\\rm in}:)\\exp(:a {\\tt L}:)\\\
exp(:H_2/2:)\\exp(:b {\\tt L}:)\\nonumber\\\\\n   \\times&\\exp(:V_2:)\\exp(:a {\\tt L}:)\\exp(:H_2/2:)\\exp(:b {\\tt L}:)\\exp(:F\
_{\\rm out}:)\\,,\n\\end{align}\nwhere {\\tt L} and $H_2$ are the Hamiltonians of a drift of length {\\tt L} and a thin sextupole \
kick with integrated strength {\\tt K2}:\n\\begin{align}\n   H_2 = \\frac{{\\tt K2}}{3!} \\Re(x - i y)^{3}\\,,\n\\end{align}\nresp\
ectively. The coeffients are $a\\equiv 1/2 - 1/\\sqrt{12}$ and $b = 1/2 - a$. Terms $\\exp(:F_{\\rm in}:)$ and $\\exp(:F_{\\rm out\
}:)$ are transformations for entrance and exit nonlinear fringes. The term $\\exp(:V_2:)$ is a correction to adjust the third-orde\
r terms in {\\tt L}:\n\\begin{align}\n   V_2 = \\sum_{j=(x,y),k=(x,y)} \n              - \\frac{\\beta}{2}H_{2,k}^2 \n            \
  + \\gamma H_{2,j}H_{2,k} H_{2,j,k}\\,,\n\\end{align}\nwhere $,i$ represents the derivative by $x$ or $y$. We have also introduce\
d two coefficients $\\beta \\equiv 1/6 - 1/\\sqrt{48}$ and $\\gamma = 1/40 - 1/(24 \\sqrt3$)\\,.;;;3]",
"The transformation of a SEXT is given as\n\n   exp(:Fin:)exp(:a L:)exp(:H2/2:)exp(:b L:)\n         *exp(:V2:)exp(:a L:)exp(:H2/2:\
)exp(:b L:)exp(:Fout:) ,\n\nwhere L and H2 are Hamiltonians of a drift of length L and a thin dipole kick of integrated strength K\
2:\n\n   H2 = K2/3! Re((x - I y)^3) ,\n\nrespectively. The coeffients are a = 1/2 - 1/sqrt(12) and b = 1/2 - a. Terms exp(:Fin:) a\
nd exp(:Fout:) are transformations for entrance and exit nonlinear fringes. The term exp(:V2:) is a correction to adjust the third\
-order terms in L:\n\n   V2 = (SUM over j=(x,y), k=(x,y)) [\n              - beta/2 (H2,k)^2 \n              + gamma (H2,j H2,k H2\
,j,k)] ,\n\nwhere ,i represents the derivative by x or y. We have also introduced two coefficients beta = 1/6 - 1/sqrt(48) and gam\
ma = 1/40 - 1/24/sqrt(3)."
]</PRE>
</UL>
<LI>
<H3><A NAME=L237>
SOL</A>
</H3>
<PRE>A solenoid. Unlike other elements, SOL elements inserted at boundaries or of a solenoid or at where the field changes. Between
 SOL elements DRIFT, BEND(straight bend only), QUAD, and MULT elements can be inserted. The longitudinal field of the solenoid over
laps on those elements.
   In a SOL region, the coordinate is shifted on the axis of the solenoid, no matter how the design orbit bends there. The x-direct
ion of the coordinate in a solenoid is so chosen as to CHI3 = 0. At the exit of a solenoid, the coordinate is shifted back to the d
esign orbit, but the value of CHI3 is so determined as to set CHI3 zero at the nearest MARK element which has GEO = 1 after the exi
t. The offset and orientation of the design orbit can be given by keywords DX, DY, DPX, DPY at a SOL element with GEO = 1. SOL can 
be used to shift the coordinate to the actual orbit even without BZ. It is useful to define the coordinate with magnets with DX and
 DY.
</PRE>
<UL>
<LI>
<H3><A NAME=L238>
BOUND</A>
</H3>
<PRE>BOUND = 1 must be given at both sides of the boundaries of a solenoid, otherwise SOL only specifies the change of BZ
</PRE>
<LI>
<H3><A NAME=L239>
BZ</A>
</H3>
<PRE>The longitudinal field of a solenoid. If a SOL is used with BOUND = 0 (default), only BZ is used to change the field, and no c
oordinate transformation is applied.
</PRE>
<LI>
<H3><A NAME=L240>
DISFRIN</A>
</H3>
<PRE>EquAlign["Text[Disables the nonlinear fringe of solenoid if nonzero. The default is 0. The transformation for the nonlinear f\
ringe is expressed by\n\\begin{align}\n\\exp(:H:) ,\\qquad H = -B_z/(8p^2B\\rho) p_\\phi p_r,\\end{align} where\\begin{align}\n   \
p_\\phi &= xp_y - yp_x\\,,\\\\\n   p_r   &= xp_x + yp_y\\,,\n\\end{align} whose canonical partners are\n\\begin{align}\n   \\phi &\
= {\\tt ArcTan}[y/x]\\,,\\\\\n   r   &= {\\tt Log}[x^2 + y^2]/2\\,,\n\\end{align} respectively.;;;5]",
"Disables the nonlinear fringe of solenoid if nonzero. The default is 0. The transformation for the nonlinear fringe is expressed \
by\n\n   exp(:H:) ,\n   H = -Bz/(8 Brho p^2) p_phi p_r, \n\nwhere\n\n   p_phi = x py - y px ,\n   p_r   = x px + y py ,\n\nwhose c\
anonical partners are\n\n   phi = ArcTan[y/x] ,\n   r   = Log[x^2 + y^2]/2 ,\n\nrespectively."
]</PRE>
<LI>
<H3><A NAME=L241>
DPX</A>
</H3>
<PRE>An offset of the design ORBIT angle CHI1 relative to the solenoid axis at SOL with GEO = 1.
</PRE>
<LI>
<H3><A NAME=L242>
DPY</A>
</H3>
<PRE>An offset of the design ORBIT angle CHI2 relative to the solenoid axis at SOL with GEO = 1.
</PRE>
<LI>
<H3><A NAME=L243>
DX</A>
</H3>
<PRE>An x-offset of the design ORBIT relative to the solenoid center at SOL with GEO = 1.
</PRE>
<LI>
<H3><A NAME=L244>
DY</A>
</H3>
<PRE>A y-offset of the design ORBIT relative to the solenoid center at SOL with GEO = 1.
</PRE>
<LI>
<H3><A NAME=L245>
F1</A>
</H3>
<PRE>The length of fringe of the solenoid field. It affects only the EMITTANCE calculation. If F1 = 0 (default), no radiation arise
s at the fringe.
</PRE>
<LI>
<H3><A NAME=L246>
GEO</A>
</H3>
<PRE>One of boundaries (with GEO = 1) of a solenoid must have GEO = 1 to specify the alignment of the design orbit. At a SOL elemen
t with GEO = 1, the design orbit is determined by DX, DY, DPX, DPY parameters
</PRE>
</UL>
</UL>
<H3><A NAME=L247>
expression</A>
</H3>
<PRE>An expression in FFS consists of a symbol, constants, and operators.

>>> A symbol is a characters of any length starting with an alphabet or $.
>>> There are two kinds of constants, real number and character-string.
    real number is a number in fortran-line format.
    character-string is a set of characters surrounded by "" or ''.
    special-characters can be specified with backslash.
>>> Available operators are (in the order of the priority):
    #,##,
    ?,
    ::,
    @,
    [],
    ++, --,
    /@, //@, @@,
    .,
    ^,
    *, /,
    +, -,
    ==, <>, >, <, >=, =>, <=, =<, 
    ===, <=>, 
    ~, 
    &&,
    ||,
    .., ...,
    |,
    :,
    ->, :>,
    /., //.,
    +=, -=, *=, /=,
    &,
    //,
    /:,
    =, :=, ^=, ^:=, =.
    ;,
    {}
An operator with higher priority is operated first. An expression enclosed in () is evaluated first. Most mathematical operations a
re threaded into a list, i.e., {a,b} + {c,d} gives {a + b,c + d}, etc.
   Each operators can be used as a function using its name. For example, Plus[x,y] gives the same result as x + y.
</PRE>
<UL>
<LI>
<H3><A NAME=L248>
(-)</A>
</H3>
<PRE>operator for subtraction or unary minus.
</PRE>
<LI>
<H3><A NAME=L249>
(/)</A>
</H3>
<PRE>operator for division.
</PRE>
<LI>
<H3><A NAME=L250>
AddTo(+=)</A>
</H3>
<PRE>a+=b is equivalent to a=a+b .
</PRE>
<LI>
<H3><A NAME=L251>
Alternatives(|)</A>
</H3>
<PRE>a | b | ... represents a pattern which matches one of patterns a, b, ...
</PRE>
<LI>
<H3><A NAME=L252>
And(&&)</A>
</H3>
<PRE> a && b returns True(==1) when both a and b are nonzero real,  False(==0) otherwise. b is not evaluated when a is zero.

</PRE>
<LI>
<H3><A NAME=L253>
Apply (@@)</A>
</H3>
<PRE>f@@a applies function f to subexpressions of a. f@@[a,level] specifies a levelspec to apply by level.
</PRE>
<LI>
<H3><A NAME=L254>
CompoundExpression(;)</A>
</H3>
<PRE>a ; b evaluates a, then evaluates b and returns its result.
</PRE>
<LI>
<H3><A NAME=L255>
Decrement(--)</A>
</H3>
<PRE>a-- decrements a by 1, returning the old value of a. --a decrements a by 1, returning the new value of a.
</PRE>
<LI>
<H3><A NAME=L256>
DivideBy(/=)</A>
</H3>
<PRE>a/=b is equivalent to a=a/b.
</PRE>
<LI>
<H3><A NAME=L257>
Dot(.)</A>
</H3>
<PRE>a . b returns the inner product of a and b.
</PRE>
<LI>
<H3><A NAME=L258>
Equal(==)</A>
</H3>
<PRE>a == b returns True(==1) if a and b are both Real with the same value or a String with same length and value. If one of a or b
 is a list, or both are lists with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L259>
Function(&)</A>
</H3>
<PRE> a & is a pure-function whose argument is specified #, #n, ##, ##n.
</PRE>
<LI>
<H3><A NAME=L260>
Greater(>)</A>
</H3>
<PRE>If both a and b are real, a > b returns True if a is greater than b, False otherwise. If one of a or b is a list, or both are 
lists with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L261>
GreaterEqual(>= or =>)</A>
</H3>
<PRE>If both a and b are real, a => b returns True if a is greater than or equal to b, False otherwise. If one of a or b is a list,
 or both are lists with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L262>
Increment(++)</A>
</H3>
<PRE>a++ increments a by 1, returning the old value of a. ++a increments a by 1, returning the new value of a.
</PRE>
<LI>
<H3><A NAME=L263>
Less(<)</A>
</H3>
<PRE>If both a and b are real, a < b returns True if a is less than b, False otherwise. If one of a or b is a list, or both are lis
ts with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L264>
LessEqual(<= or =<)</A>
</H3>
<PRE>If both a and b are real, a <= b returns True if a is less than or equal to b, False otherwise. If one of a or b is a list, or
 both are lists with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L265>
List({})</A>
</H3>
<PRE>{a,b,c...} is a list structure.
</PRE>
<LI>
<H3><A NAME=L266>
Map (/@)</A>
</H3>
<PRE>f/@a maps function f to subexpressions of a. f/@[a,level] specifies a levelspec of map by level.
</PRE>
<LI>
<H3><A NAME=L267>
MapAll(//@)</A>
</H3>
<PRE>f//@a maps function f to all subexpressions of a. f//@[a,Heads->True] maps including the heads of a and its subexpressions.

</PRE>
<LI>
<H3><A NAME=L268>
Member(@)</A>
</H3>
<PRE>f@a refers the member a of an instance or a class f. Otherwise it is same as f[a]. f@g@h means (f@g)@h, and f@g[h] (f@g)[h].

</PRE>
<LI>
<H3><A NAME=L269>
MessageName(::)</A>
</H3>
<PRE>symbol::tag returns a message associated with symbol and tag
 symbol::tag = message sets a message identified by symbol
</PRE>
<LI>
<H3><A NAME=L270>
Not(~)</A>
</H3>
<PRE> ~a returns True(==1) when a is zero, False(==0) when a is a nonzero real.
</PRE>
<LI>
<H3><A NAME=L271>
Or(||)</A>
</H3>
<PRE>
a || b returns True(==1) when a is nonzero real or b is nonzero real, False(==0) otherwise. b is not evaluated when a is nonzero.

</PRE>
<LI>
<H3><A NAME=L272>
Part([[]])</A>
</H3>
<PRE>a[[b,..]] is a subexpression of an expression a.
 If an index is omitted or Null like as a[[,b]], Part returns a list of elements whose corresponding index takes the entire range. 
For instance,
 {{1, 2}, {3, 4}, {5, 6}}[[,2]] gives {2, 4, 6}.
</PRE>
<LI>
<H3><A NAME=L273>
PatternTest(?)</A>
</H3>
<PRE>pattern?test matches to an object which matches pattern then test[object] gives True.
</PRE>
<LI>
<H3><A NAME=L274>
Plus(+)</A>
</H3>
<PRE>a + b returns the sum of a and b. If one of a or b is a list, or both are lists with same size, returns a list of element-wise
 results.
</PRE>
<LI>
<H3><A NAME=L275>
Power(^)</A>
</H3>
<PRE>a ^ b returns the power of a to b. If one of a or b is a list, or both are lists with same size, returns a list of element-wis
e results.
</PRE>
<LI>
<H3><A NAME=L276>
Repeated(..)</A>
</H3>
<PRE>p.. matches sequence of one ore more expressions, each matching p.
</PRE>
<LI>
<H3><A NAME=L277>
RepeatedNull(...)</A>
</H3>
<PRE>p... matches sequence of zero ore more expressions, each matching p.
</PRE>
<LI>
<H3><A NAME=L278>
ReplaceAll(/.)</A>
</H3>
<PRE>expr/.rule replaces all subexpressions of expr using rule.
</PRE>
<LI>
<H3><A NAME=L279>
ReplaceRepeated(//.)</A>
</H3>
<PRE>expr//.rule replaces all subexpressionso of expr using rule, while a replacement is performed.
</PRE>
<LI>
<H3><A NAME=L280>
Rule(->)</A>
</H3>
<PRE>pattern->expr represents a rule for ReplaceAll.
</PRE>
<LI>
<H3><A NAME=L281>
RuleDelayed(:>)</A>
</H3>
<PRE>pattern:>expr represents a rule for ReplaceAll, where expr is kept unevaluated until the replacement.
</PRE>
<LI>
<H3><A NAME=L282>
SameQ(===)</A>
</H3>
<PRE>a === b returns True(==1) if a and b have the same type and same value, False(==0) otherwise.
</PRE>
<LI>
<H3><A NAME=L283>
Sequence([])</A>
</H3>
<PRE>a[b,c,..] means a list of b, c,.. with the head a. It is evaluated as a function-reference when a is a function or a defined-f
unction. When a is a list with head List, it is interpreted as a part specification of a list. When a is a character-string, it is 
interpreted as a substring specification. When a is an operator, it is an expression b (a) c (a) .. . When a is Null, it means a se
quence.
</PRE>
<LI>
<H3><A NAME=L284>
Set(=)</A>
</H3>
<PRE>a = value sets the value b to the symbol a. {a,b,..}={v1,v2,..} sets a,b,c simultaneously. a[b,c,..]=v1 sets the part of a[b,c
,..] if a is a list. a[b,c,..] = expression defines the value a[b,c,..] if a is not a list.
</PRE>
<LI>
<H3><A NAME=L285>
SetDelayed(:=)</A>
</H3>
<PRE>same as Set but the right hand side is not evaluated when it is set.
</PRE>
<LI>
<H3><A NAME=L286>
StringJoin (//)</A>
</H3>
<PRE>a // b converts a and b to character-strings, then join them.
</PRE>
<LI>
<H3><A NAME=L287>
SubtractFrom(-=)</A>
</H3>
<PRE>a-=b is equivalent to a=a-b .
</PRE>
<LI>
<H3><A NAME=L288>
TagSet(/:)</A>
</H3>
<PRE>symb/:lhs = rhs sets rhs to lhs, associated with symbol symb. symb/:lhs := rhs sets rhs to lhs unevaluated, associated with sy
mbol symb. symb/:lhs =. unsets lhs, associated with symbol symb.
</PRE>
<LI>
<H3><A NAME=L289>
Times(*)</A>
</H3>
<PRE>a * b returns the product of a and b. If one of a or b is a list, or both are lists with same size, returns a list of element-
wise results.
</PRE>
<LI>
<H3><A NAME=L290>
TimesBy(*=)</A>
</H3>
<PRE>a*=b is equivalent to a=a*b .
</PRE>
<LI>
<H3><A NAME=L291>
Unequal(<>)</A>
</H3>
<PRE>a <> b returns True(==1) if a and b are both Real with different values or a String with different length or values. If one of
 a or b is a list, or both are lists with same size, returns a list of element-wise results.
</PRE>
<LI>
<H3><A NAME=L292>
UnsameQ(<=>)</A>
</H3>
<PRE>a <=> b returns True(==1) if a and b have the different types or different values. False(==0) otherwise.
</PRE>
<LI>
<H3><A NAME=L293>
Unset(=.)</A>
</H3>
<PRE>a=. clears the definition assigned to a.
</PRE>
</UL>
<H3><A NAME=L294>
ELSE</A>
</H3>
<PRE>Usage: IF expr1 body1 [ELSEIF expr2 body2 [ELSEIF ..]] [ELSE body3] ENDIF

This is a FORTRAN77 like IF-structure. If the expression expr1 is True(==1) or nonzero, executes commands in body1. If it is False(
==0), skip commands until ELSE, ELSEIF or ENDIF appears at the same level of the IF-structure, and executes commands after ELSE or 
ENDIF, or executes the ELSEIF command. If expr1 is not a real number, an error message is printed and ignores the command line.

</PRE>
<H3><A NAME=L295>
ELSEIF</A>
</H3>
<PRE>Usage: IF expr1 body1 [ELSEIF expr2 body2 [ELSEIF ..]] [ELSE body3] ENDIF

This is a FORTRAN77 like IF-structure. If the expression expr1 is True(==1) or nonzero, executes commands in body1. If it is False(
==0), skip commands until ELSE, ELSEIF or ENDIF appears at the same level of the IF-structure, and executes commands after ELSE or 
ENDIF, or executes the ELSEIF command. If expr1 is not a real number, an error message is printed and ignores the command line.

</PRE>
<H3><A NAME=L296>
EMITTANCE(EMIT)</A>
</H3>
<PRE>Usage: (1) EMIT
       (2) EMIT dp

(1) EMIT calculates the closed orbit, the normal coordinate, and the equilibrium emittance assuming the current beam line is a posi
tron ring. One of EMITTANCE(EMIT), the Emittance[] function, or the EMIT command in the MAIN level are necessary to be done in prio
r to multi-turn tracking. See multi-turn-tracking.

(2) EMIT dp, where dp is |df_rf/f_rf|/(alpha_p == momentum compaction), does EMIT for five rf frequencies:

EquAlign["\\frac{1}{\\alpha_p}\\frac{\\varDelta f_{\\rm rf}}{f_{\\rm rf}}=-|{\\tt DP}|, -|{\\tt DP}|/2, 0, |{\\tt DP}|/2, |{\\tt DP
}|\\,,","   df_rf/f_rf/alpha_p = -|dp|, -|dp|/2, 0, |dp|/2, |dp|,"]

then prints out a table of the dependences of various quantities on the frequency shift.

   The results of EMITTANCE(EMIT) are affected by flags COD, RADCOD, RFSW, INTRA, WSPAC, EMIOUT, CODPLOT and special-variables MOME
NTUM, CHARGE, FSHIFT, MINCOUP, PBUNCH. The flag TRPT or RING affects only Emittance[], as EMITTANCE(EMIT) automatically set RING.

   EMITTANCE(EMIT) returns the equilibrium emittances in variables EMITX, EMITY, EMITZ, and the equilibrium bunch length in SIGZ, t
he relative momentum spread in SIGE, and the longitudinal equilibrium position DTSYNCH. Values Max[EMITk, MINCOUP*(EMITX+EMITY)] (k
=X,Y) are used in the intrabeam calculaton, but variables EMITX and EMITY hold the original value without MINCOUP.

   The map used in EMIT is slightly different from that used in the tracking. For instance, the edge angle of a bend is approximate
d by a thin quad. If the edge angle is large and the curvature is small, EMIT may give a wrong answer. This will be corrected in ne
ar future.
</PRE>
<H3><A NAME=L297>
END</A>
</H3>
<PRE>Closes the current output-stream and set the output stream to the standard output(6). It also suspends all the input streams a
nd switches to the standard input(5). Since this command affects all input and output streams, you may consider to use TERMINATE(TE
RM) or CLOSE(CLO) to suspend or close them selectively.
</PRE>
<H3><A NAME=L298>
ENDIF</A>
</H3>
<PRE>Usage: IF expr1 body1 [ELSEIF expr2 body2 [ELSEIF ..]] [ELSE body3] ENDIF

This is a FORTRAN77 like IF-structure. If the expression expr1 is True(==1) or nonzero, executes commands in body1. If it is False(
==0), skip commands until ELSE, ELSEIF or ENDIF appears at the same level of the IF-structure, and executes commands after ELSE or 
ENDIF, or executes the ELSEIF command. If expr1 is not a real number, an error message is printed and ignores the command line.

</PRE>
<H3><A NAME=L299>
EXECUTE(EXEC)</A>
</H3>
<PRE>Usage: EXEC character-string-expression

executes the character-string-expression as FFS commands.
</PRE>
<H3><A NAME=L300>
EXPAND</A>
</H3>
<PRE> EXPAND distributes all variable keys to each corresponding components. Individual deviations (machine errors) are cleared.

</PRE>
<H3><A NAME=L301>
flags</A>
</H3>
<PRE>Usage: [NO]flag

turns the flag on. If NO is prepended to flag, the flag is turned off. Some flags have antonym which works in the opposite way. Fla
gs can be accessed in the function-syntax with the form ?flag, which returns True (==1) when the flag is on, or False (==0) otherwi
se. Some flags can be accessed by the ON/OFF commands at the MAIN level.
 Status of all flags are displayed by the STATUS(STAT) command.
</PRE>
<UL>
<LI>
<H3><A NAME=L302>
ABSW</A>
</H3>
<PRE>ABSW or NORELW sets the weights of variable elements independent from their values in the matching. Otherwise they are weighte
d relatively.
</PRE>
<LI>
<H3><A NAME=L303>
BIPOL</A>
</H3>
<PRE>BIPOL or NOUNIPOL allows the change of sign of the value of the element during the matching. It affects the default keywords o
f all elements. This is overridden by MIN, MAX specification or VariableRange of each element.
</PRE>
<LI>
<H3><A NAME=L304>
CALC4D</A>
</H3>
<PRE>If CALC4D is on, the optics calculation in CALCULATE(CAL) and GO performs a 4x5 calculation (4D + dispersion). The antonyms is
 CALC6D. The Default is CALC4D.
</PRE>
<LI>
<H3><A NAME=L305>
CALC6D</A>
</H3>
<PRE>If CALC6D is on, the optics calculation in CALCULATE(CAL) and GO performs full 6D calculation, which may takes RADCOD into acc
ount. The antonyms is CALC4D. The Default is CALC4D.
</PRE>
<LI>
<H3><A NAME=L306>
CALEXP</A>
</H3>
<PRE>The default behavior on EXPAND for CALCULATE(CAL) and GO, when unspecified. If it is ON, the values of elements are expanded t
o all components (ie., all machine errors are cleared).
</PRE>
<LI>
<H3><A NAME=L307>
CELL</A>
</H3>
<PRE>CELL or NOINS sets the periodic condition in calculating the optical-functions.
</PRE>
<LI>
<H3><A NAME=L308>
CMPLOT</A>
</H3>
<PRE>CMPLOT enables the shift of the center of mass at the beginning of the tracking. This is almost obsolete.
</PRE>
<LI>
<H3><A NAME=L309>
COD</A>
</H3>
<PRE>COD turns on finding the closed-orbit in the emittance calculation. Accessible in MAIN level.
</PRE>
<LI>
<H3><A NAME=L310>
CODPLOT</A>
</H3>
<PRE>CODPLOT lets the emittance calculation return the information on the closed-orbit, extended Twiss parameters, and the beam siz
e along the beam line into the FFS optics buffer, which can be shown by DISPLAY(DISP) or DRAW commands as well as Twiss and OpticsP
lot functions.
</PRE>
<LI>
<H3><A NAME=L311>
CONV</A>
</H3>
<PRE>CONV is a flag set by the CALCULATE(CAL) or GO commands. It becomes True when MatchingResidual is less than CONVERGENCE.

</PRE>
<LI>
<H3><A NAME=L312>
CONVCASE</A>
</H3>
<PRE>When CONVCASE is on, FFS command line parser converts the input characters to the upper case.(Default on) CONVCASE actions for
 the element names and patterns CAN be overridden by PRSVCASE flag.
</PRE>
<LI>
<H3><A NAME=L313>
DAMPONLY</A>
</H3>
<PRE>DAMPONLY is the antonym of FLUC.
</PRE>
<LI>
<H3><A NAME=L314>
DAPERT</A>
</H3>
<PRE>DAPERT enables the DAPERT procedure in the multi-turn tracking to obtain the dynamic aperture diagram. Accessible in the MAIN 
level.
</PRE>
<LI>
<H3><A NAME=L315>
DIFFRES</A>
</H3>
<PRE>
In the case of CELL, if the total tune deviates across a difference resonance, it is counted as unstable. The default is NODIFFRES.

</PRE>
<LI>
<H3><A NAME=L316>
ECHO</A>
</H3>
<PRE>ECHO enables the echo of the main input in the MAIN level.
</PRE>
<LI>
<H3><A NAME=L317>
EMIOUT</A>
</H3>
<PRE>EMIOUT turns on the extended output of emittance calculation.
Accessible in the MAIN level.
</PRE>
<LI>
<H3><A NAME=L318>
FFSPRMPT</A>
</H3>
<PRE>When FFSPRMPT is off(default) the input prompt is In[n]:= , where n is $Line+1. Otherwise the prompt is the traditional FFS pr
ompt, showing the FIT location and the DISP range.
</PRE>
<LI>
<H3><A NAME=L319>
FIXSEED</A>
</H3>
<PRE>FIXSEED or NOMOVESEED disables the change of the seed of the random number generator after the particle tracking.
</PRE>
<LI>
<H3><A NAME=L320>
FLUC</A>
</H3>
<PRE>FLUC or NODAMPONLY enables the diffusion due to synchrotron radiation in the particle tracking. Otherwise only the damping is 
enabled when RAD is ON.
</PRE>
<LI>
<H3><A NAME=L321>
GAUSS</A>
</H3>
<PRE>GAUSS or NOUNIFORM sets the momentum distribution of the incoming beam to be Gaussian, otherwise uniform(square) distribution 
is assumed. It affects the beam size calculated by Twiss parameters.
</PRE>
<LI>
<H3><A NAME=L322>
GEOCAL</A>
</H3>
<PRE>When GEOCAL is on(default), the geometry of the beam line is always updated by CALCULATE(CAL) or GO commands using the current
 values of components. The coordinate transformation by SOL is also updated. When GEOCAL is off, the geometry is never updated. It 
is useful to simulate misalignments within a solenoid, etc.
</PRE>
<LI>
<H3><A NAME=L323>
GEOFIX</A>
</H3>
<PRE>GEOFIX is the antonym of GEOCAL.
</PRE>
<LI>
<H3><A NAME=L324>
HALFRES</A>
</H3>
<PRE>In the case of CELL, if the total tune deviates across a half-integer resonance, or the traces is less than -2, it is counted 
as unstable (~?STABLE). Otherwise the optics is recognized as STABLE. The default is HALFRES.
</PRE>
<LI>
<H3><A NAME=L325>
IDEAL</A>
</H3>
<PRE>IDEAL or NOREAL inhibits to use the component-specific deviations in the optics calculation.
</PRE>
<LI>
<H3><A NAME=L326>
INS</A>
</H3>
<PRE>INS is the antonym of CELL.
</PRE>
<LI>
<H3><A NAME=L327>
INTRA</A>
</H3>
<PRE>INTRA turns on the calculation of intra-beam scattering in the emittance calculation. Accessible in MAIN level.
</PRE>
<LI>
<H3><A NAME=L328>
INTRES</A>
</H3>
<PRE>In the case of CELL, if the total tune deviates across an integer resonance, or the trace is larger than 2, it is counted as u
nstable (~?STABLE). Otherwise the optics is recognized as STABLE. The default is INTRES.
</PRE>
<LI>
<H3><A NAME=L329>
JITTER</A>
</H3>
<PRE>JITTER or NOQUIET allows jitter of the center-of-mass of the incoming beam in the case of TRPT. Otherwise the center-of-mass s
tatistically fluctuates depending on the number of particles.
</PRE>
<LI>
<H3><A NAME=L330>
KEEPEXP</A>
</H3>
<PRE>If it is ON, CALCULATE(CAL) preserves the behavior on EXPAND of the last CALCULATE(CAL) or GO. The default is ON.
</PRE>
<LI>
<H3><A NAME=L331>
LOG</A>
</H3>
<PRE>LOG enables the echo of all inputs in the MAIN level. Also suppresses the prompt in FFS.
</PRE>
<LI>
<H3><A NAME=L332>
LOSSMAP</A>
</H3>
<PRE>If LOSSMAP is on, TrackParticles returns the location and turn where the particle lost is detected, in the 8/10th and 9/11th e
lement of the result, for  NOPOL/POL, respectively. The default is NOLOSSMAP
</PRE>
<LI>
<H3><A NAME=L333>
LWAKE</A>
</H3>
<PRE>LWAKE turns on optics calculation with Longitudinal WakeFunction
</PRE>
<LI>
<H3><A NAME=L334>
MOVESEED</A>
</H3>
<PRE>MOVESEED is the antonym of FIXSEED.
</PRE>
<LI>
<H3><A NAME=L335>
PHOTONS</A>
</H3>
<PRE>When PHOTONS is ON (default is OFF), with RAD and FLUC, TrackParticles generates a list of all photons radiated through the tr
acking. The list is assigned to a symbol PhotonList.
</PRE>
<LI>
<H3><A NAME=L336>
POL</A>
</H3>
<PRE>POL turns on spin tracking and the calculation of equilibrium polarization in EMIT/Emittance[].
</PRE>
<LI>
<H3><A NAME=L337>
PRSVCASE</A>
</H3>
<PRE>When PRSVCASE is on, FFS command line parser preserves the input characters for the element names and patterns.(Default off)

</PRE>
<LI>
<H3><A NAME=L338>
PSPAC</A>
</H3>
<PRE>When on, performs space-charge simulation in a "Particle-In-Cell" method. PSPAC is effective in tracking only.
   Do not confuse PSPAC with SPAC/WSPAC.
</PRE>
<LI>
<H3><A NAME=L339>
QUIET</A>
</H3>
<PRE>QUIET is the antonym of JITEER.
</PRE>
<LI>
<H3><A NAME=L340>
RAD</A>
</H3>
<PRE>RAD turns on the synchrotron radiation in the particle-tracking. Accessible in the MAIN level.
</PRE>
<LI>
<H3><A NAME=L341>
RADCOD</A>
</H3>
<PRE>RADCOD turns on the energy loss due to synchrotron radiation at the closed-orbit in the emittance calculation. Also turns off 
the implicit acceleration in the tracking to compensate the energy loss automatically, in the case that TRPT is ON. Accessible in M
AIN level.
</PRE>
<LI>
<H3><A NAME=L342>
RADLIGHT</A>
</H3>
<PRE>When RADLIGHT is on, the function TrackParticles returns a list of trajectories which are used to calculate the synchrotron ra
diation field.
</PRE>
<LI>
<H3><A NAME=L343>
RADPOL</A>
</H3>
<PRE>If POL is on, RADPOL turns on Sokolov-Ternov effect in tracking.
</PRE>
<LI>
<H3><A NAME=L344>
RADTAPER</A>
</H3>
<PRE>Scales all magnets except for solenoids according to the local momentum (DDP) of the closed orbit. It uses the average of DDPs
 at the entrance and the exit. For tracking, RADCOD and ( CAL/GO with CALC6D or EMIT(Emittance[]) ) is necessary. CAL/GO with CALC4
D will clear the necessary information for tracking with RADTAPER.
 RADTAPER sets the momentum deviation by the local momentum of the closed orbit + an amount to satisfy the path length condition gi
ven by FSHIFT. The momentum deviation at the entrance, DP0, is always maintained.
</PRE>
<LI>
<H3><A NAME=L345>
REAL</A>
</H3>
<PRE>REAL is the antonym of IDEAL.
</PRE>
<LI>
<H3><A NAME=L346>
RELW</A>
</H3>
<PRE>RELW is the antonym of ABSW.
</PRE>
<LI>
<H3><A NAME=L347>
RFSW</A>
</H3>
<PRE>RFSW turns on the acceleration by CAVI and TCAVI element in the particle-tracking and the emittance calculation. Accessible in
 MAIN level, but FFS always turns RFSW on at the beginning of the session.
</PRE>
<LI>
<H3><A NAME=L348>
RING</A>
</H3>
<PRE>RING is the antonym of TRPT.
</PRE>
<LI>
<H3><A NAME=L349>
SELFCOD</A>
</H3>
<PRE>When on with WSPAC, in tracking, the space charge force is calculated relative to the center of mass of the current set of par
ticles each time. Otherwise(default) it is calculated relative to the closed orbit given by EMIT. SELFCOD is useful when the closed
 orbits given by EMIT and TRACK are different.
</PRE>
<LI>
<H3><A NAME=L350>
SORG</A>
</H3>
<PRE>SORG sets the origin of S (design orbit length) at the location set by ORG.
</PRE>
<LI>
<H3><A NAME=L351>
SPAC</A>
</H3>
<PRE>When SPAC is on, tracking is done with space charge effect. The actual number of particles in the beam and the number of macro
 particles are given by PBUNCH and NP, respectively. This calculation assumes a cylindrical symmetry of the chamber whose radius is
 given by RADIUS of DRIFT and MULT elements. If RADIUS is positive, an aperture is also set at RADIUS to make particle loss. If RAD
IUS is zero, no space charge calculation is done. If RADIUS is negative, no space charge effect is taken, but the aperture is set a
t -RADIUS.
   Do not confuse SPAC with WSPAC.
</PRE>
<LI>
<H3><A NAME=L352>
STABLE</A>
</H3>
<PRE>STABLE is a flag set by the CALCULATE(CAL) or GO commands in the case of CELL. It becomes True when the closed orbit is found 
and the optics is stable in both x and y.
</PRE>
<LI>
<H3><A NAME=L353>
SUMRES</A>
</H3>
<PRE>In the case of CELL, if the total tune deviates across a sum resonance, it is counted as unstable. The default is SUMRES.

</PRE>
<LI>
<H3><A NAME=L354>
SUS</A>
</H3>
<PRE>If OFF, SUSPEND(SUSP) and END commands have no action. The default is ON.
</PRE>
<LI>
<H3><A NAME=L355>
TRPT</A>
</H3>
<PRE>TRPT or NORING declares that the beam line is a transport line, not a part of a storage ring. The nominal momentum be changed 
in the beam line due to acceleration. The default momentum distribution becomes uniform distribution. The default is RING or NOTRPT
. TRPT affects Emittance[] to ignore equilibrium calculation for a transport line.
</PRE>
<LI>
<H3><A NAME=L356>
TWAKE</A>
</H3>
<PRE>TWAKE turns on optics calculation with Transverse WakeFunction
</PRE>
<LI>
<H3><A NAME=L357>
UNIFORM</A>
</H3>
<PRE>UNIFORM is the antonym of GAUSS. It assumes the momentum distribution to be a uniform(square) within +-DP.
</PRE>
<LI>
<H3><A NAME=L358>
UNIPOL</A>
</H3>
<PRE>UNIPOL is the antonym of BIPOL.
</PRE>
<LI>
<H3><A NAME=L359>
UNSTABLE</A>
</H3>
<PRE>UNSTABLE is the antonym of STABLE.
</PRE>
<LI>
<H3><A NAME=L360>
WAKEOPT</A>
</H3>
<PRE>WAKEOPT enables an optics calculation with LWAKE or TWAKE under TRPT. The default is OFF.
</PRE>
<LI>
<H3><A NAME=L361>
WSPAC</A>
</H3>
<PRE>When on, performs space-charge simulation in a "strong-weak" mode. The beam size through the beam line is to be calculated by 
EMIT with CODPLOT. The space-charge force is calculated assuming Gaussian distribution in all dimensions, and particles/bunch given
 by PBUNCH. WSPAC is effective in optics and emittance calculations and tracking.
   Do not confuse WSPAC with SPAC.
</PRE>
</UL>
<H3><A NAME=L362>
functions</A>
</H3>
<PRE>FFS functions:

Constants:
   Degree GoldenRatio I INF* Infinity NaN* Pi SpeedOfLight
Elementary-functions:
   ArcCos ArcCosh ArcSin ArcSinh ArcTan ArcTanh Cos Cosh Exp Log Sin Sinh
   Sqrt Tan Tanh
Special-functions:
   BesselI BesselJ BesselK BesselY BesselJZero Erf Erfc Factorial 
   Gamma LogGamma LogGamma1 GammaRegularized GammaRegularizedQ*
   GammaRegularizedP* GaussianCoulomb* GaussianCoulombU*
   GaussianCoulombFitted* LegendreP*
Numerical-functions:
   Abs Ceiling Floor Max Min MinMax* Mod Negative NonNegative Positive
   Round Sign FractionalPart
Matrix-operations:
   Det Eigensystem IdentityMatrix Inner LinearSolve Outer SingularValues*
   Transpose
Random-number:
   GaussRandom* Random* SeedRandom
Complex:
   Arg Complex ComplexQ Conjugate Im Re
Rational:
   Rational FromRational ContinuedFraction FromContinuedFraction SmallPrime
   Numerator Denominator
Fourier-Transformation:
   Fourier InverseFourier
Data-Manipulation:
   FindRoot Fit* NIntegrate* PolynomialFit* Spline*
Calculus:
   D NIntegrate
Minimization:
   DownhillSimplex*
List-manipulations:
   Append Complement Delete Depth Difference* Dimensions Drop Extract Flatten
   FlattenAt HeldPart Insert Intersection Join Length Part Partition Prepend
   Product Range ReplacePart Rest Reverse RotateLeft RotateRight Select 
   Sort Sum Take Table Union
Character-strings:
   FromCharacterCode CharacterPosition Characters DigitQ LetterQ StringDrop
   StringFill* StringInsert StringLength StringPosition StringTrim*
   Symbol SymbolName ToCharacterCode ToLowerCase ToUpperCase ToExpression
Functional-Operations:
   Apply Cases Count DeleteCases Identity FixedPoint* FixedPointList*
   Fold Function Level Map MapAll MapAt MapIndexed MapThread Nest Position
   Replace Scan ScanThread* SelectCases* SwitchCases* Thread
Object-oriented programing and context:
   Begin BeginPackage Class* End EndPackage
Flow-Control:
   Break Catch Check Continue Do For Goto If Label Return Switch Throw Which
   While
Tests:
   AtomQ ComplexQ DirectoryQ* EvenQ FileQ* MatchQ MatrixQ MemberQ NearlySameQ* 
   Negative NonNegative NumberQ OddQ Order Positive RealQ StringQ* VectorQ
   BoundQ* FBoundQ*
Input/Output:
   Close Flush* Get OpenRead OpenWrite OpenAppend Print Put Read ReadString SeekFile*
   Short* StringToStream Write WriteString
File System:
   CopyDirectory CopyFile CreateDirectory DeleteDirectory DeleteFile
   DirectoryName FileByteCount FileDate FileNames FileType
   RenameDirectory RenameFile SetFileDate ToFileName
Scoping:
   Block Module With*
Attributes:
   Attributes* Clear Evaluate Head Hold Literal Protect ReleaseHold
   SetAttributes* Unevaluated Unprotect
GUI Widget:
   Window* PanedWindow* Frame* LabelFrame* Canvas* TextLabel* TextMessage*
   Button* CheckButton* RadioButton* Menu* OptionMenu* MenuButton*
   Entry* SpinBox* ListBox* ScrollBar* Scale* TextEditor*
Graphics:
   BeamPlot* ColumnPlot* HistoPlot* ListContourPlot ListDensityPlot 
   ListPlot Plot Show FitPlot* GeometryPlot* OpticsPlot* TkPhotoPutBlock*
System Interface:
   Directory Environment GetEnv* GetGID* GetPID* GetUID* ProcessStatus* 
   SetDirectory SetEnv* System* TemporaryName* MkSecureTemp* RealPath*
Multiprocessing:
   BiPipe* Fork* OpenShared* Shared* Wait*
Utilities:
   Date DateString* Definition* FromDate* ToDate ToDateString* Pause
   MemoryCheck* Message Off On Sleep TimeUsed Timing TracePrint

Functions listed above work basically in the same way as Mathematica's 
except those marked by *.

FFS-dedicated-functions:
   BeamMatrix CalculateOptics DynamicApertureSurvey Element Emittance FFS
   FitValue FitWeight GeoBase LINE OptimizeOptics OrbitGeo RadiationField
   RadiationSpectrum SymplecticJ SetElement TrackParticles Twiss VariableRange
   SynchroBetaEmittance TouschekLifetime WakeFunction
Beam-line-functions:
   BeamLine BeamLineName ExtractBeamLine PrintBeamLine WriteBeamLine
</PRE>
<UL>
<LI>
<H3><A NAME=L363>
Data-Manipulation</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L364>
Fit</A>
</H3>
<PRE>Usage: Fit[data, expr, var, 
         {par1, ini1, [{min1, max1}] }, .. ,{parn, inin, [{minn, maxn}]},
         [options..] ]

performs a nonlinear fitting of data with an expression expr.

data: list of {xi,yi}, {xi,yi,dyi}, or {xi,yi,dxi,dyi}, where dxi and dyi
      are the standard deviation of the i-th point.
expr: an expression containing var as the x-variable, and 
      parameters par1,..,parn explicitly. Use Evaluate[fun] if an implicit
      expression is necessary.
var:  a symbol to express the x-axis variable.
par:  parameter symbol to be varied in the fitting.
ini:  initial value of the parameter. It must be specified.
(min, max}: optional range of parameter.

Fit returns the result as a list:

{par1 -> v1, .., parn->vn, ChiSquare -> chisq, GoodnessOfFit -> good,
ConfidenceInterval -> {c1, .., cn}, ConvarianceMatrix -> cov},

where v1,..,vn are the values of the parameters which minimizes chi-square, chisq is the resulting minimum value of the total chi-s
quare (when no error is given for yi, variance is returned), good is a number given by GammaRegularized[(ndata-npara)/2,chisq/2] to
 represent the goodness of the fit, c1, .., cn are the estimated errors in parameters, and cov is the covariance matrix. A typical 
criterion of the goodness is (good > 0.1).

   Options are

MaxIterations        Maximum number of iterations.
D                    If True (default), tries to use analytical derivative.
Cutoff               If nonzero, set the saturation point for each data as:

chi-suare = Sum_i ( Min[Cutoff, Max[-Cutoff, (d_i - f_ i) / sigma_i]]^2 ) ,

                     which is a sort of robust M-Estimates. By Cutoff, the fit
                     tends to ignore tail data which are beyond Cutoff.
                     If Cutoff is zero (default), it is ignored.
</PRE>
<LI>
<H3><A NAME=L365>
FitEmit</A>
</H3>
<PRE>Obtain the emittance, beta, alpha, etc. from data of particles x and px using FitGaussian.

  FitEmit[x, px] ,

where x and px are the lists of data of the particles in the phase space, returns a list

  {{xmean, pxmean, alpha, beta, emittance},
   {xmean, pxmean, alpha, beta, emittance}_conf},

where the second component is the confidence intervals of the results.
</PRE>
<LI>
<H3><A NAME=L366>
FitGaussian</A>
</H3>
<PRE>Performs Gaussian fit of 1D list data:

  FitGaussian[data, [opt, ...]]

returns a list

  {sigma, mean, {sigma_conf, mean_conf}, chisq} ,

where sigma_conf and mean_conf are the confidence interval of the results sigma and mean, respectively. The arguments opt... are op
tions for Fit. If Plot -> True is specified as the option, a plot of the fitting will be made.
</PRE>
<LI>
<H3><A NAME=L367>
NIntegrate</A>
</H3>
<PRE>NIntegrate returns numerical integration of a Real or Complex
function

Usage:   NIntegrate[f, {x, x0, x1}, options]

where f is a function containing Symbol x as the independent variable. The integral range is from x0 and x1. The function f must co
ntain the symbol x explicitly.

Options           Default      Description
-------------------------------------------------------------
AccuracyGoal      1e-13        Relative accuracy
InitialPoints     20           Number of initial points where
                               the function is evaluated.
</PRE>
<LI>
<H3><A NAME=L368>
PolynomialFit</A>
</H3>
<PRE>Usage: PolynomialFit[data, n]

performs a 1D linear regression of data.

data: list of {xi,yi}
n: the order of the polynomial

Fit returns the result as a list:

{{c0, .., cn}, {Residual -> res}} ,

where c0 .. cn are the coefficients of the fitted polynomial, y = c0 + c1 x + .. + cn x^n . Res is the rms residual of the fit.

</PRE>
<LI>
<H3><A NAME=L369>
Spline</A>
</H3>
<PRE>Spline returns data for cubic-spline interpolation.

Usage:   sp = Spline[list, [Derivative->{dy1,dy2}] ]

where list contains data in the form as {{x1,y1}, ..} or {{x1,{y11, y12, ..}}, ..}.
 Complex number can be allowed for y, but not for x.

 This spline assumes y''=0 at the boundary, unless Derivative->{dy1,dy2} is specified to constrain the derivative at each end to dy
1 or dy2. They can be Null to unspecify the constraint at one of the boundary. The resulting data of the spline is assigned sp as a
 SplineData object. Then one can calculate the interpolated data by

    sp[x]                     value of y at x.
    Derivative[1][sp][x]      value of y' at x.
    Derivative[2][sp][x]      value of y'' at x.
    Integrate[sp[x],{x, x0, x1}]   integral of sp[x] from x0 to x1.

Example:
   sp=Spline[{{1,2},{3,5},{4,2},{5,7}}];
   Plot[{sp[x],Derivative[1][sp][x],Derivative[2][sp][x],Integrate[sp[y],{y,1,#}]&[x]}, {x,1,5},
     FrameLabel->{"x"}, Thickness->2,
     Legend->{"\\@\\tt sp[x]","\\@\\tt sp'[x]","\\@\\tt sp''[x]","\\@$\\int$\\tt sp[x]"}];
   Update[];

<Spline.png
</PRE>
</UL>
<LI>
<H3><A NAME=L370>
DownhillSimplex</A>
</H3>
<PRE>Usage: DownhillSimplex[initial, f, options]

minimizes a function f by the downhill simplex method, starting from an initial simplex initial.  Suppose f is a function of n vari
ables.   Then  initial is a list of n+1 elements, each of which is a list of the form

   {f[vi], vi} ,

where vi is a list of n values corresponding to each variable. The initial must be sorted in ascending order of f, i.e.,

   initial=Sort[Map[{f[#],#}&,vlist]]

generates initial from a list of variables vlist.
   DownhillSimplex returns the final simplex in the same form as initial.

Options:
   VariableRange -> {{min1 .. minn}, {max1 .. maxn}} gives the range of n
      variables.   The default is -Infinity to Infinity for all variables.
   MaxIteration -> maxi gives the limit of number of iterations.   The
      default is Max[100, 10*(n+1)].
   Output -> lfn sets the output file number for the intermediate results.
      the default is 6 (stdout).
   Tolerance -> tol sets the tolerance to judge the local minimum.
      If (fmax-fmin)/(abs(fmax)+abs(fmin)) becomes less than tol, the 
      iteration loop terminates.   The default is 10^-6.

Examples:
  f:=Apply[Function[{x,y},((x^2+y^2)-1)*(x^2+y^2)-(x-.5)/3.],#]&;
  v={{1.,1.},{0.,-1.},{0.,1.}};
  limit={{-0.5,-1.5},{0.65,1.5}};
  p=Sort[Map[{f[#],#}&,v]]
  DownhillSimplex[p,f,MaxIteration->100,
     Tolerance->1e-4,VariableRange->limit]
</PRE>
<LI>
<H3><A NAME=L371>
functional-operations</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L372>
Apply</A>
</H3>
<PRE>   Apply[f, x [, level]] or f@@x [f@@[x, level]] 

takes the bod of a list x as the argument sequence of f, and returns the result:

f@@{a, b, c} ===> f[a, b, c]

An optional argument specifies the level-spec.
</PRE>
<LI>
<H3><A NAME=L373>
Cases</A>
</H3>
<PRE>   Cases[l, pat [, level [,n]]]

returns a list of parts of l, which match a pattern pat. Optional level-spec l and the maximum number of results n can be specified
.
</PRE>
<LI>
<H3><A NAME=L374>
DeleteCases</A>
</H3>
<PRE>   DeleteCases[l, pat [, level [,n]]]

returns a list of parts of l, which do not match a pattern pat. Optional level-spec l and the maximum number of results n can be sp
ecified.
</PRE>
<LI>
<H3><A NAME=L375>
Difference</A>
</H3>
<PRE>Difference[list] returns Rest[list] - Drop[list, -1] .
</PRE>
<LI>
<H3><A NAME=L376>
FixedPoint</A>
</H3>
<PRE>FixedPoint[f, e] starts from f[e] then applies f repeatedly until the result no longer changes. FixedPoint[f, e, n] specifies 
the maximum number of iterations by n. An option SameTest->s specifies the test function. Threshold->re, and AbsoluteThreshold->ae 
set the relative and absolute accuracy, respectively, when SameTest->NearlySameQ (default).
</PRE>
<LI>
<H3><A NAME=L377>
FixedPointList</A>
</H3>
<PRE>FixedPointList[f, e] returns the intermediate values of FixedPoint[f, e] as a list. FixedPointList[f, e, n] and options for Fi
xedPoint are valid.
</PRE>
<LI>
<H3><A NAME=L378>
level-spec</A>
</H3>
<PRE>Functions Map, Apply, Scan, Cases, Position, Count, Level, DeleteCases takes an optional argument level to specify which level
 to operate:

value               operates
n_Real              from level 1 through level n
{n_Real}            only on level n
{n1_Real, n2_Real}  from leveln1 through level n2


If n is negative, it counts from the deepest level of each element.

Examples: f@@[{{a, b}, {c, d}}, {1}] ===> {f[a, b], f[c, d]}
</PRE>
<LI>
<H3><A NAME=L379>
Map</A>
</H3>
<PRE>   Map[f, x [, level]] or f/@x [f/@[x, level]] 

operates f over each element of a list x and returns the result as a list:

f/@{a, b, c} ===> {f[a], f[b], f[c]}

An optional argument specifies the level-spec.
</PRE>
<LI>
<H3><A NAME=L380>
MapThread</A>
</H3>
<PRE>   MapThread[f, l] ===> f@@[Thread[l], {1}]

Example: MapThread[f, {{1, 2}, {3, 4}}] ===> {f[1, 3], f[1, 4]}
</PRE>
<LI>
<H3><A NAME=L381>
Position</A>
</H3>
<PRE>   Position[l, pat [, level [,n]]]

returns a list of indices of parts of l, which match a pattern pat. Optional level-spec l and the maximum number of results n can b
e specified.
</PRE>
<LI>
<H3><A NAME=L382>
Scan</A>
</H3>
<PRE>   Scan[f, x [, level]]

operates f over each element of a list without returning the result:

Scan[f, {a, b, c}] ===> {f[a], f[b], f[c]};Null 

An optional argument specifies the level-spec.
</PRE>
<LI>
<H3><A NAME=L383>
ScanThread</A>
</H3>
<PRE>   ScanThread[f, l] ===> (f@@[Thread[l], {1}];Null) ,

which is equivalent to MapThread without returning the results.
</PRE>
<LI>
<H3><A NAME=L384>
SelectCases</A>
</H3>
<PRE>Usage: SelectCases[list, {test1,..}]

returns a list {list1, .. }, where list1 is a list of subexpressions which makes test1 True, etc. If the second argument is like {c
1, .. , True&},  the last of the returned list contains subexpressions which make none of c1, ... True.
</PRE>
<LI>
<H3><A NAME=L385>
SwitchCases</A>
</H3>
<PRE>Usage: SwitchCases[list, {case1,..}]

returns a list {list1, .. }, where list1 is a list of subexpressions which match case1, etc. SwitchCases does what are done by Case
s and DeleteCases simultaneously. If the second argument is like {c1, .. , _}, the last of the returned list contains subexpression
s which match none of c1, ...
</PRE>
<LI>
<H3><A NAME=L386>
Thread</A>
</H3>
<PRE> Thread[l] returns a threaded list of l:

   Thread[{{1, 2}, {3, 4}}] ===> {{1, 3}, {2, 4}}
   Thread[{{1, 2}, {3, 4}, 5}] ===> {{1, 3, 5}, {2, 4, 5}}

 If an optional second argument h is given, Thread operates only over on a structure whose head is h:

   Thread[{{1, 2}, {3, 4}} , f] ===> {{1, 2}, {3, 4}}
   Thread[{f[1, 2], f[3, 4]} , f] ===> f[{1, 3}, {2, 4}]
   Thread[f[f[1, 2], f[3, 4]] , f] ===> f[f[1, 3], f[2, 4]]

 Thread is equivalent to Transpose if l is a matrix.
</PRE>
</UL>
<LI>
<H3><A NAME=L387>
FFS-dedicated-functions</A>
</H3>
<PRE>Functions dedicated to the optics calculations and simulations in FFS.
</PRE>
<UL>
<LI>
<H3><A NAME=L388>
AccelerateParticles</A>
</H3>
<PRE>AccelerateParticles does TrackParticles with acceleration in a ring for a given number of turns. The adiabatic damping is auto
matically taken cared.

Usage:    AccelerateParticles[beam_,mom_,{n_Symbol,nturn_},opt___]

where beam is a list of beam coordinates in the same format for TrackParticles. mom is an expression to determine MOMENTUM in each 
turn as a function of turn number n. nturn is the total number of turns. An option Synchronize specifies a routine to be executed a
t every turn of the tracking (e.g. changing voltages and magnet settings, or storing the results.)

Example:
  AccelerateParticles[
    beam,
    Which[
      n < 100,  1e9,
      n <= 200, 1e9 + (n - 100) * 1e7,
      True, 2e9],
    {n, 300},
    Synchronize :> ((
      d = {d, MOMENTUM/1e9 * (1 + #2[[2,6,1]])})&)];
</PRE>
<LI>
<H3><A NAME=L389>
BeamMatrix</A>
</H3>
<PRE>BeamMatrix[i] returns a 6 by 6 beam-matrix (i.e., <x_k x_l>) at location i. The index i can have a fraction to specify interme
diate numbers (see LINE or Twiss). The calculation is based on linear 4 by 5 calculation in the present version, so the z-direction
 is meaningless. Flag GAUSS affects the result.
</PRE>
<LI>
<H3><A NAME=L390>
DynamicApertureSurvey</A>
</H3>
<PRE>Usage: DynamicApertureSurvey[range,nturn,options]

where

range: a list of {xrange,yrange,zrange}, with
       xrange: {xmin, xmax},
       yrange: {ymin, ymax},
       zrange: {zmin, zmax},
       and for the horizontal plane, specified by the Axes option, 
       the corresponding range must be given as {v1, ..., vn}.
       These values are the initial amplitude divided by the equilibrium 
       values, i.e., Sqrt[2Jx,y/(EMITX+EMITY)], Sqrt[2Jz/EMITZ].
       See EMITTANCE(EMIT) command or Emittance function.
nturn: number of turns to track.
options: Output->lfn : output to the unit lfn (see OpenWrite).
         Axes->axes : one of "XY", "XZ", "YX", "YZ", "ZX", "ZY",
          where the first character specifies the horizontal axis, and
          the second the vertical, respectively. The default is "ZX".
         ReferenceOrbit->{x0, px0, y0, py0, z0, dp0} : Survey is done around
          this orbit.
         PhaseX->phix : The initial amplitude is rotated in (X, PX) phase space
          by phix. Default is zero.
         PhaseY->phiy : The initial amplitude is rotated in (Y, PY) phase space
          by phiy. Default is zero.
         PhaseZ->phiz : The initial amplitude is rotated in (Z, PZ) phase space
          by phiz. Default is -Pi/2.
         ExpandElementValues->True(default) : set the values of the components
          according to the values of elements. Machine errors may be reset.
          See machine-error-commands, CALCULATE(CALC).

   DynamicApertureSurvey returns the result as a list:

   {score,{{{xmin, xmax},{ymin, ymax},{z1, z2, .., zn}},
           {{z1,score1,{turn1_1,..,turn1_50}},..,
            {zn,scoren,{turnn_1,..,turnn_50}}}}} ,

where score = Sum[scorei,{i,n}], scorei is the "score" of i-th momentum, and turni_j is the lost turn of the particle with i-th mom
entum and j-th initial amplitude.
   DynamicApertureSurvey tracks number of particles with different initial conditions in the range given by range. It outputs a z-x
 diagram of the dynamic aperture of the ring. Fifty one initial conditions are chosen in the range x-range for each point of z-rang
e. The initial y-amplitude is linearly dependent on the x-amplitude. It tracks from xmax to downward for each z-amplitude zn, until
 the particles turns nturn with successive DAPWIDTH x-amplitudes. The default DAPWIDTH is 7.
  DynamicApertureSurvey does parallel processing up to NPARA processes.
</PRE>
<LI>
<H3><A NAME=L391>
Element</A>
</H3>
<PRE>Element[key-string, {element-pattern-string | element-position}] returns values for key-string of elements which match element
-pattern-string or located at element-position. It returns a list if more than one elements match. The key-string and element-patte
rn-string can be symbols, unless values are not assigned to them.
   If the second argument is omitted, it means all elements.
   The element-position can be known by Element["POSITION"].
   Key-strings "VALUE" and element-keywords allows to be set (i.e., Element[a,b] = v) when element-pattern-string chooses only one 
element. If a value is set to Element, it is automatically distributed to all components those belong to the element. If the keywor
d is the default variable, the error given by machine-error-command DK is applied.
   The arguments of Element can be lists. It automatically maps as

   Element[{a,b,c..},y]  means {Element[a,y],Element[b,y],Element[c,y]..}
   Element[x,{a,b,c..}]  means {Element[x,a],Element[x,b],Element[x,c]..},

where both x and y can be also a list.

   If an option Saved->True is given, Element refers the save-buffer which can be transferred to other beam lines. Otherwise values
 set by Element are not saved when FFS is stopped, unless they are the default-keyword or keywords once used in matching.
</PRE>
<UL>
<LI>
<H3><A NAME=L392>
key-strings:Element</A>
</H3>
<PRE>The key-string is not case-sensitive. Available key-strings are:	

"LENGTH"       Number of elements in the beam line. No second argument.
"POSITION"     Position of the element in the element-list.
"NAME"         Name of the element.
"VALUE"        Current value of the default keyword of the element.
"KEYWORDS"     List of available keywords of the element.
"DEFAULT"      The default keyword of the element
"TYPE"         The internal code-number of the type of the element.
"TYPENAME"     The name of the type of the element.
keyword        If keyword is the default keyword, it means the current value. If not, it means the saved value. Changing the non-de
fault keyword by Element does not affects the current setting of the components.
"EXPAND"       Distribute the value of the default-keywords and the keywords used in the matching to all components in the beam lin
e. No second argument.	

Setting by Element["VALUE",..] or Element[keyword,..] to the DEFAULT  keyword or a matching-variable keyword changes the current va
lue, and  distributed to the components in the succeeding calculation.
</PRE>
</UL>
<LI>
<H3><A NAME=L393>
Emittance</A>
</H3>
<PRE>Emittance[option] returns a set of rules as 

   {keyword1->value1, keyword2->value2, ..} .

Its options and default values are Matrix(False), Orbit(False), OneTurnInformation(False), Emittance(True), ExpandElementValues(Tru
e), SaveEMIT(False), InitialOrbit(Null), InitialBeamMatrix(Null), Region({1,-1}), and Output(0).

If Emittance->False is specified, the resulting keywords are:	

Stable                  True if all modes are stable and the closed orbit is found.
Region                  The region {begin, end} to calculate.
Tunes                   {nux, nuy, nuz} .
EnergyLossU0            One turn energy loss in eV.
RfVoltageVc             The effective RF voltage (V).
EquilibriumPosition     dz in meter.
MomentumCompaction      -dz/dp
OrbitDilation           ds in meter.
BucketHeight            dV/E0
HarmonicNumber          The effective harmonic number
OrbitAtExit             physical c.o.d. at the end of line.	

If None of the options is given, the following keywords are added:	

DampingRate             {T0/taux, T0/tauy, T0/tauz}
Emittances              {emitx, emity, emitz} *1)
MomentumSpread          sigma p/p0
BunchLength             sigma_z
Polarization            equilibrium polarization, if POL is on
Polarization2           equilibrium polarization by up to 2nd order calculation
Polarization4           equilibrium polarization by up to 4th order calculation
Polarization6           equilibrium polarization by up to 6th order calculation
PolarizationVector      direction of polarization AppendTo the entrance of the beam line
SpinTune                spin tune on the closed orbit
NominalSpinTune         spin tune calculated by MOMENTUM and electron g-2
TuneShiftByRadiation    {dnux, dnuy, dnuz}	

If OneTurnInformation->True, or Orbit->True, or Matrix->True, the followings are added.	

OrbitAtEntrance         physical c.o.d. at the entrance of the ring.
OneTurnTransferMatrix   symplectic part of the one-turn transfer matrix.
OneTurnDampingMatrix    deviation of transfer matrix due to radiation.
NormalCoordinates       conversion matrix from physical to normal coords.
OneTurnExcitation       excitation matrix by radiation and intrabeam scattering (with INTRA).
EquilibriumBeamMatrix   equilibrium beam matrix.
ExtendedTwissParameters list of rules giving the extended Twiss parameters at the entrance of the ring.	

If Orbit->True or Matrix->True, the following is added:	

ClosedOrbit             List of physical closed orbit at every element in the ring.	

If Matrix->True, the followings are added:	

TransferMatrices        List of physical transfer matrix from the beginning of the beam line to all elements.
IntrabeamExcitation     List of the change of the 6 x 6 beam matrix due to the intrabeam scattering (only when INTRA), converted to
 the beginning of the beam line.	

   If the flag TRPT or NORING is set, the calculation assumes a transport line so that several quantities such as damping rate, eig
en modes, equilibrium beam matrix, etc. are meaningless. Use RING or NOTRPT for such calculation. In the case of TRPT or NORING, th
e incoming beam envelope must be given by the option InitialBeamMatrix with a 6 x 6 symmetric matrix. TRPT is useful for calculatio
n of space charge and intrabeam in a transport line.
   Please do not forget to put semicolon at the end of Emittance[] function, otherwise the output will be huge especially when Orbi
t or Matrix is True.
 If ExpandElementValues->False, calculation is made using the present values of each component (i.e., including machine errors).

If SaveEMIT->True, the calculated values of emittances are stored in variables EMITX, EMITY, EMITZ, SIGE, SIGZ. The default is Save
EMIT->False. These are the values calculated by the lattice, and not affected by MINCOUP.

InitialOrbit->{x0,px0,y0,py0,z0,dp0/p0} specifies the incoming orbit which is valid when NOCOD is set. The option Output->filenum e
nables the print out of EMITTANCE(EMIT) to filnum.

If Region is not the entire ring, parameters such as Emittances and DampingRate, etc., are not calculated, and return NaNs.

*1) The values of Emittances with INTRA and MINCOUP correspond to the equilibrium with intrabeam scattering weakened by MINCOUP.

</PRE>
<LI>
<H3><A NAME=L394>
ExternalMap</A>
</H3>
<PRE>With MAP elements, ExternalMap defines a user-defined map of particles. It also allows a user to do anything (doing statistics
, etc.) at any point of a beam line during a tracking. 

Usage: First define a MAP element at MAIN level:

     MAP    name=(L=leng);

Currently L is the only keyword. Insert it at the location(s) where you want to use it.

1) Tracking
In FFS, define the function ExternalMap as

    ExternalMap["TRACK",n,nt_,x_]:=body;

The second argument n is the position of MAP counting from the beginning, which can be obtained using LINE["POSITION","name.m"]. Th
e third argument nt_ is used to receive the number of turns which is incremented by the tracking. The last argument x_ is used to r
eceive the coordinates of particles. It is a (7 or 9, np) list of real numbers. The elements  (1..8, i) are (x, px ,y ,py ,z ,dp/p0
, sy, sarg) of the i-th particle. The (-1, i)  element is True(==1) if the i-th particle has been survived, and False(==0) if it ha
s been lost. The spin coordinates sy and sarg are only valid with the POL flag.

 You can define ExternalMap to change the coordinates of each particle as you like by returning a new x in the same format as above
. If you do not return it or you return in a different format, the tracking routine does not change the particle coordinates. You c
an neither rebirth a lost particle nor kill a surviving particle.

After defined ExternalMap, tracking calls it in every turn.

Example:

   MAP P1=();
   ....
   LINE A=(... P1 ... P1 ...);
   ....
   FFS USE=A;
     ExternalMap["TRACK",LINE["POSITION","P1.2"],nt_,x_]:=
       (Print[x];x*2);
   ....

   TRACK USE=A ....;

This example defines ExternalMap to print out the coordinates of all particles at the second P1 in the line A. It also makes all co
ordinates of all particles twice in every turn.

   Optionally a compiled module CompiledMap can be used for ExternalMap["TRACK"] (see below).

2) Emittance
In FFS, define the function ExternalMap as

   ExternalMap["EMIT",n,cod_]:=body;

The second argument n is the position of MAP counting from the beginning, which can be obtained using LINE["POSITION","name.m"]. Th
e last argument cod_ is used to receive the orbit at the entrance of the element, as a list of 6 real numbers. ExternalMap must ret
urn a list, either {cod1, trans} or  {cod1, trans, dtrans, dbeam}, where cod1 is the orbit at the exit, trans is the 6 by 6 transfe
r matrix of this element, dtrans is the radiation damping part of the transfer matrix (6 by 6), and dbeam is the radiation excitati
on of the beam matrix (6 by 6). Only j >= i parts of dbeam[[i, j]] are taken into account.

Example:

   ExternalMap["EMIT",LINE["POSITION","P1"],cod_]:=(
     Print[cod];
     {cod+{0,0.001,0,0,0,0},IdentityMatrix[6]});

3) Optics
In FFS, define the function ExternalMap as

   ExternalMap["OPTICS",n,cod_]:=body;

The second argument n is the position of MAP counting from the beginning, which can be obtained using LINE["POSITION","name.m"]. Th
e last argument cod_ is used to receive the orbit at the entrance of the element, as a list of 6 real numbers. ExternalMap must ret
urn a list {cod1, trans}, where cod1 is the orbit at the exit and trans is the 6 by 6 transfer matrix of this element. In the case 
of CACL4D (== ~CALC6D), only the 4 by 5 transfer matrix is effective.

Example:

   ExternalMap["OPTICS",LINE["POSITION","P1"],cod_]:=(
     Print[cod];
     {cod+{0,0.001,0,0,0,0},IdentityMatrix[6]});

4) Geometry
In FFS, define the function ExternalMap as

   ExternalMap["GEO",n,geo_,pos_]:=body;

The second argument n is the position of MAP counting from the beginning, which can be obtained using LINE["POSITION","name.m"]. Th
e argument geo_ receives the geometry of the beam line at the MAP element, in the same format as LINE["GEO",n], i.e., {{GX,GY,GZ},{
CHI1,CHI2,CHI3}}. The last argument pos_ receives the orbit length S at the element. ExternalMap must return an updated list {geo1,
 pos1}, as { {{GX,GY,GZ},{CHI1,CHI2,CHI3}}, S} as the values at the exit of the element.

Example:

   ExternalMap["GEO",LINE["POSITION","P1"],geo_,pos_]:=(
     Print[cod];
     { {geo[[1]]+{1,0,0}, geo[[2]]}, pos+0.1})
</PRE>
<UL>
<LI>
<H3><A NAME=L395>
CompiledMap</A>
</H3>
<PRE>Usage:

ExternapMa["TRACK", n, nt_, x_]:=CompiledMap[nt, x, src, prm, opt___];

where n is the location number, nt the number of turns, x the particle coordinates with the alive flag, as described for ExternalMa
p. It takes options of Rules as shown below. A charachter string src is the source code for the map, which completes a subroutine h
aving a header:

implicit none;
integer,intent(in):: np,nprm,nt,n;
real(kind=8),intent(inout):: x(np),px(np),y(np),py(np),z(np),dp(np),&
                             sy(np),sarg(np),flag(np),prm(nprm);

where np is the number of particles, and prm is a list of reals of any length. The spin coordinates sy and sarg are meaningless wit
hout the flag POL. The src must ends with "return;end" to complete the subroutine, and more routines can be inserted if needed. Cur
rently gfortran in free format is available for the compiler, and gcc will be supported in future.

Example:

src = "flag = flag * merge(1.d0, 0.d0, x&ltprm(1) .or. x&gtprm(2) .or. (y&gtprm(3) .and. y&ltprm(4)));return;end";
prm = {-0.001, 0.001, -3e-4, 3e-4};
ExternalMap["TRACK", LINE["POSITION","M1.2"], nt_, x_]:=CompiledMap[nt, x, src, prm];

works as a special colimation at a MAP element M1.2, resulting:

<Collimate.png

(Actually the example above can be performed also by SADScript:

ExternalMap["TRACK", LINE["POSITION","M1.2"], nt_, x_]:=Append[Drop[x, -1],
       x[[1]] < prm[[1]] || x[[1]] > prm[[2]] || (prm[[3]] < x[[3]] < prm[[4]])];

which runs even FASTER than the compiled one!!)

Options      Defaul     Description
-------------------------------------------------------------
Single       False      If True, the map is called once for the entrire particles even for NPARA > 1.
Completion   Null       A completion SADScript to be called after the map with the arg {x, prm}.
</PRE>
</UL>
<LI>
<H3><A NAME=L396>
FFS</A>
</H3>
<PRE>FFS[command-string] executes command-string as FFS commands. Any commands can be used. Some commands CALCULATE(CAL), GO, VARIA
BLES(VAR), SHOW returns their result, otherwise Null is returned. All outputs of the commands are suppressed.
   FFS[command-string,lo] directs the output of the commands to file-number lo. The file-number lo may be given by OpenWrite or Ope
nAppend.
   The IF structure and REPEAT(REP) loop must complete within a single FFS.
</PRE>
<LI>
<H3><A NAME=L397>
FFS$SHOW</A>
</H3>
<PRE>   FFS["SHOW"] or FFS$SHOW[] returns the current matching conditions as a list. Each element has a form of

{component1, component2, function, goal-value, number-of-momentums, scale},

which corresponds to the format of the print-out by SHOW.
</PRE>
<LI>
<H3><A NAME=L398>
FitValue</A>
</H3>
<PRE>Usage:

(1) FitValue[component, function, {id_,dp_}, goal_, now_] := body

modifies the goal of the matching of function at component. The argument id_ is the orbit id for MatchingAmplitude or InitialOrbits
. The argument dp_ receives the value of dp/p0. The argument goal_ is the value of the goal of the matching set by matching-functio
n-commands. The argument now_ is the current value of function.

Example: FitValue["$$$", "NX", {_,dp_}, goal_, now_] := goal + dp * xix * 2 * Pi

sets the tune NX to have chromaticity xix.

(2) FitValue[component1, component2, function, {id_,dp_}, goal_, now1_, now2_] := body

modifies the value of the function at component1 for a two-component matching. Component1 is assumed upstream in the beam line. The
 value of body is used in place of the current value, now1. The argument id_ is the orbit id for MatchingAmplitude or InitialOrbits
. The argument dp_ receives the value of dp/p0. The argument goal_ is the value of the goal of the matching set by matching-functio
n-commands. The argument now1 and now2 are the current values of the function at component1 and component2, respectively.

Example: FitValue["QF1", "QF2", "NX", _, goal_, now1_, now2_] := 
   If[Abs[now2-(now1+goal)] < 0.01*2*Pi , Null, now1]

sets the tune difference between QF1 and QF2 gaol +- 0.01.

   During the matching process the matching routine calls FitValue with arguments, then if body returns a number, it overrides the 
goal give by matching-function-commands. If body returns Null, the matching of function is ignored.
   The matching-function-command is necessary besides FitValue to perform the matching. Only defining FitValue does not do the matc
hing.
   FitValue is cleared by USE. It is hidden by VISIT and restored by BYE
</PRE>
<LI>
<H3><A NAME=L399>
FitWeight</A>
</H3>
<PRE> A defined function to modify the weight of matching of particular function at particular component with particular momentum o
ffset.

Usage:   FitWeight[component, function, {id_,dp_}, default_] := weight;

where	

component  is the name of the location of the fit, like "QF.2", etc.
function   is the name of the matching-function, like "BX", "LENG", etc.
id_        is the id number of the orbit for MatchingAmplitude or InitialOrbits.
dp_        is a variable to receive the momentum deviation of the fit.
default_   is a variable to receive the default fit weight.
weight     is an expression which returns the desired weight.	

Example: FitWeight["$$$","LENG",{_,dp_},ws_]:=ws*10;

makes the weight of LENG at $$$ 10 times (100 times in MatchingResidual) bigger than the default.
</PRE>
<LI>
<H3><A NAME=L400>
GaussianCoulomb</A>
</H3>
<PRE>EquAlign["Text[{\\tt GaussianCoulomb[x, y, sigx, sigy]} returns the electromagnetic force $f_x+if_y$ at the coordinates $(x,y\
)$, generated by a Gaussian bunch with sizes {\\tt (sigx,sigy)}=$(\\sigma_x,\\sigma_y)$. Its derivative at the origin is\n\\begin{\
align} \\frac{\\partial f_x}{\\partial x}&=-2 \\frac{x}{\\sigma_x(\\sigma_x+\\sigma_y)}\\,,\\\\\\frac{\\partial f_y}{\\partial y}&\
=-2 \\frac{y}{\\sigma_y(\\sigma_x+\\sigma_y)}\\,.\\end{align};;;12]",""
]</PRE>
<LI>
<H3><A NAME=L401>
GeoBase</A>
</H3>
<PRE>GeoBase[{chi1, chi2, chi3}] converts the rotation angles of the coordinate base vectors to a transformation matrix {{x_gx,x_gy
,x_gz}, {y_gx,y_gy,y_gz}, {z_gx,z_gy,z_gz}}
</PRE>
<LI>
<H3><A NAME=L402>
LINE</A>
</H3>
<PRE>LINE[key-string, {component-pattern-string | component-position}]

returns values for key-string of components which match component-pattern-string or located at component-position. It returns a lis
t if more than one components match. The key-string and component-pattern-string can be symbols, unless values are not assigned to 
them. The second arg can be a fractional number to denote an intermediate value of two components.
   If the second argument is omitted, it means all components.
   The component-position can be known by LINE["POSITION"].
   Key-strings "DIR" and component-keywords allows to be set (i.e.,
LINE[a,b] = v) when component-pattern-string chooses only one component.
   The arguments of LINE can be lists. It automatically maps as

   LINE[{a,b,c..},y]  means {LINE[a,y],LINE[b,y],LINE[c,y]..}
   LINE[x,{a,b,c..}]  means {LINE[x,a],LINE[x,b],LINE[x,c]..},

where both x and y can be also a list.
</PRE>
<UL>
<LI>
<H3><A NAME=L403>
key-strings:LINE</A>
</H3>
<PRE>The key-string is not case-sensitive. Available key-strings are:	

"LENGTH"       Number of components in the beam line. No second argument.
"POSITION"     Position of the component in the beam line.
"NAME"         Name of the component.
"TYPE"         The internal code-number of the type of the component.
"TYPENAME"     The name of the type of the component.
"ELEMENT"      The name of the corresponding element.
"DIR"          The orientation of the component, +-1.
"S"            The orbit length to the entrance from the beginning of the beam line.
"LENG"         Same as "S".
"GEO"          Geometric-functions at the entrance of the component, {{GX, GY, GZ}, {GCHI1, GCHI2, GCHI3}}.
"OGEO"         Geometric-functions of the orbit at the entrance of the component, {{OGX, OGY, OGZ}, {OCHI1, OCHI2, OCHI3}}.
"GAMMA"        Lorentz factor gamma.
"GAMMABETA"    Lorentz factor gamma*beta = Sqrt[gamma^2 - 1].
"SIGab"        Beam matrix component, where a and b are one of X, PX, Y, PY, Z, DP. If b is omitted it returns Sqrt[SIGaa] is retur
ned. Just "SIG" returns the entire 6 by 6 beam matrix.
"SIZEab"       Beam matrix component calculated by (CODPLOT;EMIT), where a and b are one of X, PX, Y, PY, Z, DP. If b is omitted it
 returns Sqrt[SIZEaa] is returned.- "SIZE" returns the entire 6 by 6 beam matrix.
"MULT"         The ordered number of each component belonging to the- same element, starting from 1.
keyword        The value of the keyword of the component (see below).
"EXPAND"       Distribute the value of the default-keywords and the keywords used in the matching to all components in the beam lin
e. No second argument.	
"GX", "GY", "GZ"  Geometric functions for the coordinate GX, GY, GZ.
"GCHI1", "GCHI2", "GCHI3"  Geometric functions for the coordinate CHI1, CHI2, CHI3
"OGX", "OGY", "OGZ", "OCHI1", "OCHI2", "OCHI3"  Geometrical functions for the orbit.
 Setting by LINE[keyword,..] to the DEFAULT keyword for the FIRST component changes the current value of the corresponding element,
 because the value of an element is stored in the first component.
</PRE>
</UL>
<LI>
<H3><A NAME=L404>
OptimizeOptics</A>
</H3>
<PRE>Usage: OptimizeOptics[options]

optimizes (1 + MatchingResidual) or any function using DownhillSimplex with variables specified by FREE. Unlike GO, any keyword of 
any element can be a variable.
   OptimizeOptics returns the final simplex. The variables are set to the values which give the minimum of the function so far at t
he end.

Options:
   All options for DownhillSimplex are valid.
   OptimizeFunction -> fun is the function to be minimized. The default is
      ((FFS["CALC"];1+MatchingResidual)&).
   InitialSimplex -> initial sets the initial simplex to initial. The
      default is Null, which mean to create initial from the current value
      of the variables. Its format is same as for initial of 
      DownhillSimplex
   SimplexSize -> size is the initial size of the simplex. Each variable
      is relatively shifted by this amount from the current value.

Example:
   free Q* Q* L
   fit nx .3 ny .2
   OptimizeOptics[]

optimizes the optics by changing the lengths of quads which are not allowed by GO, as well as K1 of quads.
</PRE>
<LI>
<H3><A NAME=L405>
OrbitGeo</A>
</H3>
<PRE>OrbitGeo[location] returns the geometry {GX, GY, GZ} of the current (not design) orbit.
</PRE>
<LI>
<H3><A NAME=L406>
RadiationField</A>
</H3>
<PRE>To calculate the field of the synchrotron radiation from particles, first record trajectories of particles. This is done by th
e function TrackParticles with a new flag RADLIGHT on. When RADLIGHT is on, TrackParticles returns a list

   {beam, trajectory} ,

where beam is a list as {location, coordinates}, and trajectory is a list

   { {t1 .. tm}, {x1 ..xm}, {y1 .. ym}, {z1 .. zm} }, ..

where {t,x,y,z}_i is the coordinates of the particle at i-th point in the trajectory. The origin and the direction of the spatial c
oordinates are the same as GEO coordinate {GX, GY, GZ}. One can track many particles at the same time by TrackParticles, so the tra
jectory has the dimensions {np, m}, where np is the number of particles.

   After the trajectory is obtained, one can calculate the field in time domain
at any observation point. This is done by the function RadiationFiled as

   field = RadiationField[ trajectory[[i]], obs];

where trajectory[[i]] is the trajectory of the i-th particle, and obs is the spatial coordinate of the observation point in the GEO
 coordinate. The output field is a list

   { {tau1 .. taum},
     {Ex1 .. Exm}, {Ey1 .. Eym}, {Ez1 .. Ezm},
     {Hx1 .. Hxm}, {Hy1 .. Hym}, {Hz1 .. Hzm},
     {Sx1 .. Sxm}, {Sy1 .. Sym}, {Sz1 .. Hzm} }

where H = (n x E)/(c mu0) and S = E x H , and tau is the observation time.
   RadiationField uses the Feynmann-Heviside formula

   E = (mu0 e*CHARGE/4pi) (c^2n/R^2 + R/c d(c^2n/R^2)/dt + d^2n/dt^2) ,
 where n and R are the direction vector and the distance from the electron at the retarded time to an observation point. 
   The derivatives in the above formula is calculated using the spline
interpolation.

   Next one can calculate the spectrum of the field by RadiationSpectrum as

   spect = RadiationSpectrum[ {field[[1]], field[[k]]},
        {lambda1, lambda2, dlambda} ] ,

where filed[[k]] is one of the fields calculated by RadiationField. The range of the wavelength is given as a list above. The outpu
t spectrum spect is a list as

   { {k1 .. kk}, {c1 .. ck}, {s1 .. sk} } ,

where k1 .. kk is the wave number k = omega/c, c1 .. ck and s1 .. sk are the cosine and sine integrals of the field in tau1 .. taum
 , i.e.,

   ck + I sk = Integrate[ field[tau] Exp[I c k tau] dtau] .

   An example is seen in $(SAD_ROOTPATH)/sad/examples.sad .
</PRE>
<LI>
<H3><A NAME=L407>
RadiationSpectrum</A>
</H3>
<PRE>To calculate the field of the synchrotron radiation from particles, first record trajectories of particles. This is done by th
e function TrackParticles with a new flag RADLIGHT on. When RADLIGHT is on, TrackParticles returns a list

   {beam, trajectory} ,

where beam is a list as {location, coordinates}, and trajectory is a list

   { {t1 .. tm}, {x1 ..xm}, {y1 .. ym}, {z1 .. zm} }, ..

where {t,x,y,z}_i is the coordinates of the particle at i-th point in the trajectory. The origin and the direction of the spatial c
oordinates are the same as GEO coordinate {GX, GY, GZ}. One can track many particles at the same time by TrackParticles, so the tra
jectory has the dimensions {np, m}, where np is the number of particles.

   After the trajectory is obtained, one can calculate the field in time domain
at any observation point. This is done by the function RadiationFiled as

   field = RadiationField[ trajectory[[i]], obs];

where trajectory[[i]] is the trajectory of the i-th particle, and obs is the spatial coordinate of the observation point in the GEO
 coordinate. The output field is a list

   { {tau1 .. taum},
     {Ex1 .. Exm}, {Ey1 .. Eym}, {Ez1 .. Ezm},
     {Hx1 .. Hxm}, {Hy1 .. Hym}, {Hz1 .. Hzm},
     {Sx1 .. Sxm}, {Sy1 .. Sym}, {Sz1 .. Hzm} }

where H = (n x E)/(c mu0) and S = E x H , and tau is the observation time.
   RadiationField uses the Feynmann-Heviside formula

   E = (mu0 e*CHARGE/4pi) (c^2n/R^2 + R/c d(c^2n/R^2)/dt + d^2n/dt^2) ,
 where n and R are the direction vector and the distance from the electron at the retarded time to an observation point. 
   The derivatives in the above formula is calculated using the spline
interpolation.

   Next one can calculate the spectrum of the field by RadiationSpectrum as

   spect = RadiationSpectrum[ {field[[1]], field[[k]]},
        {lambda1, lambda2, dlambda} ] ,

where filed[[k]] is one of the fields calculated by RadiationField. The range of the wavelength is given as a list above. The outpu
t spectrum spect is a list as

   { {k1 .. kk}, {c1 .. ck}, {s1 .. sk} } ,

where k1 .. kk is the wave number k = omega/c, c1 .. ck and s1 .. sk are the cosine and sine integrals of the field in tau1 .. taum
 , i.e.,

   ck + I sk = Integrate[ field[tau] Exp[I c k tau] dtau] .

   An example is seen in $(SAD_ROOTPATH)/sad/examples.sad .
</PRE>
<LI>
<H3><A NAME=L408>
SetElement</A>
</H3>
<PRE>Create/set/read a MAIN-level element.

Usage: SetElement[ element-name, element-type, options]

where

   element-name: name of the element, either a symbol or a string
   element-type: type of the element, a symbol, a string, or a number
   options: one or more rules or list of rules of the form
            keyword -> value or keyword :> value, to set the corresponding
            value of keyword of the element.

   SetElement returns a list of information of the element, in the suitable form for applying SetElement again.
   You can define a new element by SetElement.
   You can change the values of keywords of the element.
   You cannot, however, change the type of an existing element, nor cannot delete the element.
   The element-type can be Null. If so, a null type is assumed for a new element.

Examples:

   LINE A = ( .. );
   QUAD QF = (K1 = 0.2);
   ...
   FFS USE = A;
     ...
    SetElement["QF"]                     ! reads values of QF.
    SetElement["QF","QUAD"]              ! same as above.
    SetElement["QF","BEND"]              ! error because QF is QUAD.
    SetElement["QF",,{"K1"->0.1}]        ! set K1 of QF to 0.1 .
    SetElement["QF","QUAD",{"K1"->0.1}]  ! same as above.

 !Assuming QF1 and QF2 are undefined yet:

    SetElement["QF1","QUAD",{"K1"->0.1}] ! create a new QUAD QF1 with K1=0.1 .
    SetElement["QF2",,{"K1"->0.1}]       ! error because no type with key.
    SetElement["QF2"]                    ! This is OK.
    SetElement["QF2","QUAD"]             ! Now the type of QF2 is defined.
</PRE>
<LI>
<H3><A NAME=L409>
SurvivedParticles</A>
</H3>
<PRE>SurvivedParticles[x]

returns the list of 6 coordinates and the flag of the survived particles in x. The form of x is {x, px/p0, y, py/p0, z, dp/p0, flag
}, where each is a list of length of the number of particles. If all particles are lost, it is a list of seven null lists.
</PRE>
<LI>
<H3><A NAME=L410>
SymplecticJ</A>
</H3>
<PRE>SymplecticJ[n] returns an n by n symplectic matrix:

EquAlign["\\left(\\begin{matrix}\\begin{matrix}.&1&.&.\\\\-1&.&.&.\\\\.&.&.&1\\\\.&.&-1&.\\end{matrix}& ...\\\\...&...\\end{matrix}
\\right) .","   {{0, 1, ...}, {-1, 0, ...}, {0, 0, 0, 1, ...}, {0, 0, -1, 0, ...}, ...} ."]
</PRE>
<LI>
<H3><A NAME=L411>
SynchroBetaEmittance</A>
</H3>
<PRE>SynchroBetaEmittance calculates equilibrium emittance under influence of synchrotron motion and chromaticity.

Usage:

   SynchroBetaEmittance[{nus0, nus1, dnus},options]

or

   SynchroBetaEmittance[nus0,options]

where nus0, nus1, and dnus are the starting, ending and step size of synchrotron tune, respectively. If only nus0 is given, calcula
tion is done only for nus0. The returned value is a list:

   {{nus, emitx, emity, emitxp, emityp, conv}, ... }

where nus, emitx, emity, emitxp, emityp, conv are the synchrotron tune, equilibrium horizontal and vertical emittances, horizontal 
and vertical projected emittances, and the convergence, respectively. When conv is negative, calculation failed to converge, and th
e returned emittances are not reliable.

Options               Type        Default     Meaning

-----------------------------------------------------------
AzimuthalModes        Real        9           Number of azimuthal modes
</PRE>
<LI>
<H3><A NAME=L412>
TouschekLifetime</A>
</H3>
<PRE>TouschekLifetime interpolates the data calculated by EMIT or Emittance[]. There are three ways of usage:

   TouschekLifetime[Infinity, Infinity, nz]: Touschek lifetime in seconds
     with momentum aperture nz * SIGE.

   TouschekLifetime[nx, Infinity, nz]: Touschek lifetime in seconds
     with acceptance 2Jx/(nx * (EMITX+EMITY)) + 2Jz/(nz * EMITZ) < 1.

   TouschekLifetime[Infinity, ny, nz]: Touschek lifetime in seconds
     with acceptance 2Jy/(ny * (EMITX+EMITY)) + 2Jz/(nz * EMITZ) < 1.

EMIT or Emittance[] with INTRA must precede TouschekLifetime.
</PRE>
<LI>
<H3><A NAME=L413>
TrackParticles</A>
</H3>
<PRE>TrackParticles[beam, destination-component, nbegin, nend]

returns a beam after the tracking at the entrance of the destination- component. The destination can be specified by the name of th
e component or by a number obtained by LINE["POSITION", component]. If destination is omitted, the end of the line is assumed.

The argument nbegin is the initial turn number to be passed to tracking to indicate it is in the n-th turn. The number is increased
 by 1 when it passes the end of beam line. If nbegin is omitted, 1 is assumed.

The argument nend is the last turn number. The default is nbegin.

   The variable beam and also the result of TrackParticles are lists of the form 

   {location, coordinates}

where location is the position-number of the starting point. If location is same as or in the downstream of destination, the tracki
ng is done by folding across the beginning of the beam line. The coordinates are in a list of {7 or 9, np} form, where np is the nu
mber of particles. The first 6 or 8 elements of coordinates specifie either

   {x, px/p0, y, py/p0, z, dp/p0} (NOPOL)
   {x, px/p0, y, py/p0, z, dp/p0, sarg, sy} (POL)

in this order, depending on POL. The row [[-1, i]] is the alive flag which is True (==1) when the particle is alive, and False (==0
) when lost.

   If the flag POL is on, TrackParticles performs spin tracking. Then the coordinates has two more components sy and sarg, which co
rrespond to the y-component of the classical spin vector and the angle ArcTan[sx, sz], respectively. If POL is on, another flag RAD
POL turns on the Sokolov-Ternov effect.

   When a flag RADLIGHT is on, TrackParticles returns the trajectories of particles which are used to calculate the radiation field
s. See RadiationField and RadiationSpectrum.

When PHOTONS is ON (default is OFF), TrackParticles generates a list of all photons radiated through the tracking. The list is assi
gned to a symbol PhotonList.

When LOSSMAP is ON (default is OFF), the input list must have two more lines resulting in a shape of {9 or 11, np}. Then TrackParti
cles returns into these lines the component and the turn where the loss of each particle is detected.
</PRE>
<LI>
<H3><A NAME=L414>
TransferMatrix</A>
</H3>
<PRE>TransferMatrix[from_, to_, options___] returns the 4x4 or 6x6 transfer matrix (TM) from component 'from' to component 'to', de
pending on the flag CALC4D or CALC6D, respectively. Locations from and to can be the name or the component number. If to < from, th
e inverse Matrix of TM[to, from] is returned, If Fold option is False (default).  Possible options are:

Options           Default      Description
-------------------------------------------------------------
Fold              False        If True && to < from, returns TM[1, to].TM(from,-1] .
Symplectic        False        If True, returns the symplectic matrix considering acceleration.
Calc6D            False        If True, returns 6x6 TM even under CALC4D.
</PRE>
<LI>
<H3><A NAME=L415>
Twiss</A>
</H3>
<PRE> Twiss[optical-function, component] returns the value of the optical-function at the entrance of component. The values are tho
se calculated by the last CALCULATE(CALC) or GO commands, or CalculateOptics function.
 The second argument, component can be a name of component, a component number, or a list of them. If the number has a fraction, th
e intermediate value in the component is calculated.
 Twiss["ALL",component] or Twiss["*",component] returns all 28 optical-functions at the entrance of component as a list:

{AX, BX, GMX, NX, AY, BY, GMY, NY, EX, EPX, EY, EPY, R1, R2, R3, R4, DETR, DX, DPX, DY, DPY, DZ, DDP, AZ, BZ, GMZ, NZ, ZX, ZPX, ZY,
 ZPY},

which can be directly used in CalculateOptics. In the current version, however, parameters after AZ are uninteresting, because it a
lways returns 1 for BZ and zeros for the others. "R"//optical-function refers the reference optics. "D"//optical-function refers th
e difference between the current and the referece optics. "RALL" and "DAL" mean the all optical functions for the reference optics 
and the differences, respectively.
   Keywords "PEX", "PEPX", "PEY", "PEPY", "PZX", "PZPX", "PZY", "PZPY" return dispersions in the physical coordinate.
   Keywords "BMAGX", "BMAGY", "BMAGZ" return the BMAG coefficients againt the reference-optics set by the REFERENCE(REF) command.
   Keywords "LENGTH", "GAMMA", "GAMMABETA", "S", "SIGab" return the same results as for the function LINE.
   The units of NX, NY, NZ are in radian.
</PRE>
<LI>
<H3><A NAME=L416>
VariableRange</A>
</H3>
<PRE>Usage:   VariableRange[element, keyword ,v_] := expression

where the current value of the element:keyword is passed in v_, and expression should give False when the value is out of range.

Example: VariableRange["QF","ROTATE",v_]:= -0.1 < v < 0.1;

This restricts the range of the rotation angle of QF within +-100 mrad.

         VariableRange[_,"ROTATE",v_]:= -0.1 < v < 0.1;

This specifies the same for all elements.
   The expression can also return the range as a list {vmin, vmax}, which may give more chance of solution-finding for the matching
 routine.
   VariableRange only acts for variables used in the matching with the FREE command.
</PRE>
<LI>
<H3><A NAME=L417>
VariableWeight</A>
</H3>
<PRE>Usage:   VariableWeight[element, keyword ,v_] := expression

where the default weight for matching with element:keyword is passed in v_, and expression should return a modified value of weight
. If non-real is returned, the default weight is used.

Example: VariableWeight["QF","K1",v_]:= 0.1*v;

reduces the weight of QF1:K1 to 1/10 of the default value.

   The weight also affects the step size of the numerical derivative of the response. A smaller weight makes the step size larger.

   VariableWeight only acts for variables used in the matching with the FREE command.
</PRE>
<LI>
<H3><A NAME=L418>
WakeFunction</A>
</H3>
<PRE>   WakeFunction[Longitudinal, comp]={{z1, wl1}, ..., {zn, wln}};
   WakeFunction[Transverse,   comp]={{z1, wt1}, ..., {zn, wtn}};

specify longitudinal and transverse dipole wake functions at a component comp (string). Each functions is a list of {z, w} where z 
is the distance and w is the value of the wake, in the unit of either V/C or V/C/m.
   The wake functions are applied at the component comp, giving kicks to each orbit whose initial conditions are given by InitialOr
bits. The sufficient number of orbits depends on the situation.
   WakeFunction is valid only when TRPT and INS, and also either TWAKE or LWAKE is ON.
   For tracking, it is only valid in TrackParticles.
</PRE>
</UL>
<LI>
<H3><A NAME=L419>
Graphics</A>
</H3>
<PRE>Graphics represents an object for 2D graphics with the form
Graphics[primitives, options]. Up to now available primitives are:

Circle[{cx,cy},rx, options]             : Circle. 
Circle[{cx,cy},{rx,ry}, options]        : Oval. 
Points[{{x1,y1} .. {x2,y2}}, options]   : Points.
Points[{{x1,y1,dx,dy} .. {x2,y2,dx,dy}}, options]  : Points with error bars.
Line[{{x1,y1} .. {x2,y2}}, options]     : Line.
Line[{{x1,y1,dx,dy} .. {x2,y2,dx,dy}}, options]    : Line with error bars.
Rectangle[{x1,y1}, {x2,y2}]             : A box.
Rectangle[{x1,y1}, {x2,y2}, graphic]    : Graphics in a box.
Polygon[{{x1,y1} .. {x2,y2}}, options]  : Polygon.
Text[{string, {x,y}}, options]          : Text-string at {x,y}.

Possible options and their defaults values of Graphics are:

option           default         optional values
------------------------------------------------
AspectRatio      GoldenRatio     any positive number
DisplayFunction  $DisplayFunction  Identity or Null to suppress display
Detach           False           True to run tdr asynchronously
Epilog           {}              List of primitives
Frame            True            False to erase outline, ticks, ticklabels.
FrameClick       True            to allow click on frame to change options.
FrameLabel       {"","","",""}   List of strings, can be a LaTeX input
FrameTicks       {Both,Both,Ticks,Ticks}
                                 None to turn off ticks and labels
                                 Both to turn on ticks and labels
                                 Ticks to turn on ticks only
                                 << For bottom tick >>
                                 False is same as Ticks
                                 True is same as Both
                                 << For top tick >>
                                 False is same as None
                                 True is same as Ticks
                                 << For left & right ticks >>
                                 False is same as None
                                 True is same as Both
                                 If a form {___, _List} is given where
                                 the List is a list of {coord, label, opt___}
                                 label is displayed at coord with option opt.
                                 If a form {___, fun} is given and 
                                 fun[coord,exp,org] returns a list of options
                                 for Canvas[Create$Text], it is displayed at major
                                 ticks at coord. exp is the exponent and org is the
                                 original label.
GridLines        Automatic       Automatic to draw grid lines at major ticks
                                 {Automatic,None} for only x
                                 {None,Automatic} for only y
                                 Both, Minor, and Major can be also used.
PlotLabel        ""              string, can be a LaTeX input
PlotRange        Automatic       {ymin,ymax} or {{xmin,xmax},{ymin,ymax}}
Prolog           {}              List of promitives
Scale            {Linear,Linear} Log, Date
TickSize         1               relative size of ticks.
FrameThickness   Automatic       thickness of the frame line incl. ticks.
Legend           ""              shows legend-string, can be a LaTeX input
FontScale        1               Relative size of fonts for FrameLabel, FrameTicks.
FrameFontScale   1               Relative size of fonts for FrameLabel.
                                 If Real, applied to all frames. If List, applied to
                                 bottom, left, top, right, supplemented 1s to the right.
TickFontScale    1               Relative size of fonts for FrameTicks.
                                 If Real, applied to all frames. If List, applied to
                                 bottom, left, top, right, supplemented 1s to the right.
LegendFontScale  1               Relative size of fonts for Legend.

Options for primitives:

For Text:
option           default         optional values
------------------------------------------------
TextAlign        ""              "CENTER"
TextCases        ""              string to represent CASES of TopDrawer
TextPosition     ""              "DATA" to represent the position by data
                                 coordinates
TextRotate       0               clockwise rotation angle in degree
TextSize         1               relative size of a character
PlotColor        "Black"       name of the color

For Point
option           default         optional values
------------------------------------------------
PointSize        1               relative size of a point
PointSymbol      "1O"            Symbol, see PointSymbol below.
PlotColor        "Black"       name of the color
ErrorBarTickSize 1               length of error bar ticks

For Line
option           default         optional values
------------------------------------------------
Dashing          "1"             character string or a list of numbers to
                                 represent the dashing of the line.
Plot             True            whether plot symbols at data points.
                                 If True, PointSize and PointSymbol are
                                 effective (see above).
PlotColor        "Black"         name of color
ErrorBarTickSize 1               length of error bar ticks.
Thickness        1               thickness of line

For Rectangle
option           default         optional values
------------------------------------------------
MeshStyle        Null            character string to describe the stipple of
                                 outline.
PlotColor        ""              name of color of the outline.
FillColor        Null            name of color inside of the rectabgle
BelowFrame       False           If True, the rectangle is place behind the frame of plot.

For Polygon
option           default         optional values
------------------------------------------------
Plot             False           whether plot symbols at data points.
                                 If True, PointSize and PointSymbol are
                                 effective (see above).
PointSize        1               relative size of a point
PointSymbol      "1O"            Symbol, see PointSymbol below.
PointColor       "forest green"  point fill color.
PointBorderColor Automatic       point border color.
                                 Automatic measn PointColor.
PointTags        Null            points tag string or list of tag strings.
PlotJoined       True            whether plot border line of polygon.
Thickness        1               thickness of border line
Dashing          "1"             character string or a list of numbers to
                                 represent the dashing of the line.
PlotColor        "black"         border line color.
LineTags         Null            border line tag string.
FillColor        Null            polygon fill color.
                                 Null means empty polygon.
Tags             False           polygon tag string.

   ListPlot accepts options for Graphics, Point, and Line.   Show accepts
options for Graphics.   The output is written to file #9 (fort.9 in OSF1 and
ftn09 in HP-UX) in TopDrawer commands.   If SAD is running on X, the plot is
also done immediately.

Examples:
  g1=ListPlot[{{1,2},{10,20}},Scale->Log,PlotJoined->True,
    DisplayFunction->Identity];
  g2=ListPlot[{{1,15},{10,3}},Scale->Log,PlotJoined->True,Dashing->"1 0.3",
    DisplayFunction->Identity,Plot->False];
  g3=ListPlot[{{1,2.5},{5,10},{10,12}},Scale->Log,
    DisplayFunction->Identity];
  Show[g1,g2,g3,FrameLabel->{"X (mm)","Log(Y)"},PlotLabel->"Test Plot",
      AspectRatio->1];
</PRE>
<UL>
<LI>
<H3><A NAME=L420>
BeamPlot</A>
</H3>
<PRE>Usage: BeamPlot[loc, axes, options]

plots a beam ellipse at a location loc, for axes. Axes are given by a list 
{ax, ay}, where ax and ay are one of "X", "PX", "Y", "PY", "Z", "DP".
The beam envelope should be calculated by (CODPLOT;EMIT) or BEAM commands before
BeamPlot.

options       defaults
-----------------------------------------
Orbit         True                Uses Twiss["DX",loc], etc. as the center of
                                  ellipse.
SizeFunction  "SIZE"              If "SIG", LINE["SIG"] is used.
                                  LINE["SIZE"] is the default.
AspectRatio   1
DataRange     Default             If Default, PlotRange becomes square for
                                  axes = {"X", "Y"} or {"PX", "PY"}
</PRE>
<LI>
<H3><A NAME=L421>
ColumnPlot</A>
</H3>
<PRE>Usage:  ColumnPlot[data, options, ...]

plots a column plot.
1) If data is a 1D vector, it makes a simple column plot.
2) If data is a 2D matrix, it makes a multiple-column plot.
3) If data is a 3D list, it makes a stacked, multiple-column plot.

Besides options common for all plotting functions, ColumnPlot has its own
options:

Option           Value          Default             Action
---------------------------------------------------------------------------
ColumnOffset    0 < number < 1  0.15            Ratio of spacing of columns
Reference        number         0               Where column starts
Orientation     Vertical        Vertical        Orientation of columns
                Horizontal
ColumnLabel     List of Str.    Automatic       Labels for each column
                Function                        Scale for column number
                None                            No labels
FillColor       color                           Colors to fill columns
                list of colors
MeshStyle       bitmap                          Bitmap to fill columns
                list of bitmaps                 to distinguish stacking
TextSize        positive number 1               relative label size
PlotNull        True or False   False           plot a minimal rect for 0 occurrence

Example:
  g=ColumnPlot[{{{1,1,2},{2,2,3}}, {{1,4,2},{2,2,3}}, {{1,3,2},{2,2,3}}}, Orientation->Horizontal];
  Update[];

<ColumnPlot.png
</PRE>
<LI>
<H3><A NAME=L422>
FitPlot</A>
</H3>
<PRE>Usage: FitPlot[data, fun, var, {par1,ini1}, .. , {parn, inin}, opt].

options        defaults
-----------------------------------------
FunctionLabel  Default     Shows the fit function within FrameLabel[[3]].
ResultLabel    Default     Shows the fit results within FrameLabel[[3]].

</PRE>
<LI>
<H3><A NAME=L423>
GeometryPlot</A>
</H3>
<PRE>Usage: GeometryPlot[options]

plots a geometry of beam line.

options       defaults
-----------------------------------------
Region        {1,LINE["LENGTH"]}  {begin, end}, begin and end can be strings.
                                  Both begin and end point of drawing region
                                  could be given by "S" unit by using S[begin|end] form.
Names         "*"                 A pattern of component names to be plotted.
</PRE>
<LI>
<H3><A NAME=L424>
HistoPlot</A>
</H3>
<PRE>Usage:  HistoPlot[data, options, ...]

plots a histogram using ColumnPlot(default) or ListPlot.
Data can be a single list, or list of lists, which results in a multi-column histogram on a common axis.
Besides options common for all plotting functions and ColumnPlot, it has its own options:

Option           Value          Default             Action
---------------------------------------------------------------------------
Bins            number          Automatic           number of bins
BinRange        {min,max}       Automatic           Range of bins
PlotStyle       ColumnPlot      ColumnPlot          plot function
                ListPlot
                FitPlot
Orientation     Vertical        Vertical            orientation of columns
                Horizontal
FitParameters   args for FitPlot in a list
</PRE>
<LI>
<H3><A NAME=L425>
LaTeX</A>
</H3>
<PRE>Some Graphics options and the Text primitive accept a LaTeX input, if the string
starts with "\\@". The following character string is interpreted by latex, in text mode.
Thus a $ sign is necessary to enter the math mode.
 Several packages are included by default: color, amssymb, amsmath, bm, mathtools, txfonts.
 To use LaTeX in SAD, pdflatex and convert by ImageMagick must be installed in the system,
or anywhere accecible. SAD tries to locate them, then set a variable $HaveLaTeX to contain
their location. $HaveLaTeX can be set to "" to disable LaTeX.
</PRE>
<LI>
<H3><A NAME=L426>
ListContourPlot</A>
</H3>
<PRE>Usage:  ListContourPlot[list, options, ...]

plots a contour plot by list which is a 2D List of Real data.

Option           Value            Default         Action
---------------------------------------------------------------------------
Contours         Real             10              number of contours
PlotRange        {min,max}, {prxy, prz}, or {prx, pry, prz}
                                  Automatic       depth of contours (prz) and PlotRange for x-y (prxy)
AspectRatio      Real             1
MeshRange        ({x1,xn},{y1,yn}} or {{x1,..,xn},{y1,..,y1n}}
                                  Automatic       Range of x and y axes
ColorFunction    Color scheme (Blue, Purple, Pink, Yellow, Green, Cyan),Function, or String
                                  Blue            Null or None means "white"
ContourColorFunction
                 Function or String
                                  Automatic       Null or None to hide
ColorScale       True or False    True            displays a color scale on the right
Smoothing        integer >= 0     1               number of linear interpolations

Example:
 xr0=0;xr=Table[xr0+=Sin[i*Pi/21],{i,20}];xr-=(xr[[1]]+xr[[-1]])/2;
 yr=xr;
 table=Outer[Cos[Sqrt[(#^2+#2^2)/2]]&,xr,yr];

 gc=Graphics[MapThread[
  Rectangle[#2,#3,
    ListContourPlot[table, MeshRange->{xr, yr}, AspectRatio->1,
      DisplayFunction->Identity, ColorFunction->#,
      FrameLabel->{"x", "y", ToString[#]}]]&,
   {{ Blue,        Pink,       Green,      Purple,      Yellow,     Cyan},
     {{-0.15,0.65},{0.25,0.65},{0.65,0.65},{-0.15,0   },{0.25,0   },{0.65,0}},
     {{ 0.2, 1.1 },{0.6, 1.1 },{1,   1.1 },{ 0.2, 0.45},{0.6 ,0.45},{1.0, 0.45}}}]];
 Show[gc];Update[];
<ListContourPlot.png
</PRE>
<LI>
<H3><A NAME=L427>
ListDensityPlot</A>
</H3>
<PRE>Usage:  ListDensityPlot[list, options, ...]

plots a density plot by list which is a 2D List of Real data.

Option           Value            Default         Action
---------------------------------------------------------------------------
PlotRange        {min,max}, {prxy, prz}, or {prx, pry, prz}
                                  Automatic       depth of contours (prz) and PlotRange for x-y (prxy)
AspectRatio      Real             1
MeshRange        ({x1,xn},{y1,yn}} or {{x1,..,xn},{y1,..,y1n}}
                                  Automatic       Range of x and y axes
ColorFunction    Color scheme (Blue, Purple, Pink, Yellow, Green, Cyan),Function, or String
                                  Blue            Null or None means "white"
Mesh             True or False    False           True to draw mesh
MeshColor        Function or String
                                  Automatic       Null or None to hide
ColorScale       True or False    True            displays a color scale on the right
Smoothing        integer >= 0     1               number of linear interpolations

Example:
   data = Table[Sin[x]/Cos[x^2 + y^2], {x, -2, 2, 0.1}, {y, -2, 2, 0.1}];
   ListDensityPlot[data,PlotRange->{-5,5}, MeshRange->{{-2,2},{-2,2}}, FrameLabel->{"x","y"}];
   Update[];

<ListDensityPlot.png
</PRE>
<LI>
<H3><A NAME=L428>
ListPlot</A>
</H3>
<PRE>Usage: ListPlot[{{x1,y1},..,{xn,yn}}, options]

makes a graphic with points.
ListPlot[{y1,..,yn}, options] assumes 1,..n for the x-xoordinate.
ListPlot[{{x,y,dy}, ..}, options ] plots error bars of length dy in y.
ListPlot[{{x,y,dx,dy}, ..}, options ] plots error bars in x and y.
ListPlot[{{{x,y,___}, ..},..}, options ] plots ListPlot for multiple data.

option           default         optional values
------------------------------------------------
PlotJoined       False           True
                                 Step
StepRatio        1               ratio of stepping position
                                 between two data points

Type ? to see other options for Graphics.

Example:
  data1={{1,2},{3,5},{4,-1}};
  data2={{1,4},{2,-2},{3.5,3},{5,3}};
  ListPlot[{data1, data2},PlotJoined->{True, False}, Thickness->2,
    PointSize->2,
    FrameLabel->{"\\@$x$","\\@$y$"}, Legend->{"data1","data2"}];
  Update[];

<ListPlot.png
</PRE>
<LI>
<H3><A NAME=L429>
OpticsPlot</A>
</H3>
<PRE>Usage: OpticsPlot[fun_list, options]

makes a plot of built-in optical functions, user-defined functions, or
list of data at components on the beam line.   The parameters are:	

fun_list: a list of objects to be plotted in a window. The number of windows in a plot is the length of fun_list object plotted in 
a window MUST have same dimensions. An element of fun_list is one of fun_label, fun, list_data or a list as {object, options}, wher
e
fun_label: one of "AX", "BX", "GMX", "NX", "EX", "EPX", "DX", "DPX", "AY", "BY", "GMY", "NY", "EY", "EPY", "DY", "DPY", "R1", "R2",
 "R3", "R4", "DETR", "AZ", "BZ", "GMZ", "NZ", "ZX", "ZPX", "ZY", "ZPY", "DZ","DDP","PEX", "PEPX", "PEY", "PEPY", "BMAGX", "BMAGY", 
"BMAGZ", "GAMMA", "GAMMABETA","SIGab", where a and b in "SIGab" are one of X, PX, Y, PY, Z, DP. "R"//fun_label refers the reference
 optics. "D"//fun_label refers the difference between the current and reference optics.
            fun: Any function of the component number.   A fractional number may be used to obtain the intermediate value.
            list_data: a list of {{pos1, val1}..{posn,valn}}.	

options       defaults
-----------------------------------------
Region        {1,LINE["LENGTH"]}  {begin, end}, begin and end can be strings.
                                  Both begin and end point of drawing region
                                  could be given by "S" unit by using S[begin|end] form.
Lattice       True                False to turn of drawing lattice
LatticeRegion Automatic           {low,high}, the region where lattice is drawn
FrameHeight   Automatic           List of relative heights of each frame
InfoLabel     False               If True, pressing Button shows Twiss, etc.
Names         "*"                 A pattern of component names to be plotted.
RemoveOverlap "L$NAME"            If not "L$NAME", overlapping of lattice names
                                  remain untouched.
Tags          False               True to attach tags "C$"//(component name)
                                  to each rectangle for the lattice, and
                                  "L$"//(component name) to the component 
                                  label (CanvasDrawer only).
Legend        False               If Automatic, Legend is composed from FrameLabel
                                  Automatically, can be a LaTeX input.

options in a fun_list element:
options       defaults
-----------------------------------------
Unit          1                  Unit of the object. "Meter", "InvMeter",etc.
FrameLabel    ""                 Left frame label, can be a LeTeX input
Legend        False               If Automatic, Legend is composed from FrameLabel
                                  Automatically, can be a LaTeX input.

Example:
  p2=OpticsPlot[{{"BX","BY"}, 
     {"EX",{{{11,0.1,0.02},{21,0.12,0.02}}, 
       FrameLabel->"\\@$\\varDelta \\eta_{x,{\\rm  meas.}}$", Unit->Meter},
       PlotRange->{0,Automatic}}},
     Thickness->2, Names->"Q*"];
   Update[];
<OpticsPlot.png
</PRE>
<LI>
<H3><A NAME=L430>
ParametricPlot</A>
</H3>
<PRE>Usage: ParametricPlot[{funx,funy}, range, options] or Plot[{{funx1, funy1} .. }, range, options],

where {funx, funy} are x- and y- functions and range is a list given as {x, xmin, xmax}.

options        defaults
-----------------------------------------
MaxBend        0.01
PlotPoints     25
PlotDivision   250
Dashing        {"1","0.8 0.24","0.4 0.12","0.2 0.08","0.1 0.08",
                  "0.8 0.08 0.08 0.08","0.4 0.08 0.08 0.08"}
Options for ListPlot and Graphics are also available

The independent variable should have been cleared (i.e., no value should
not be set) when Plot is called. 

Example:
ParametricPlot[{{2 Cos[t], 2 Sin[t]}, {2 Cos[t], Sin[t]},
   {Cos[t], 2 Sin[t]}, {Cos[t], Sin[t]}}, {t, 0, 2 Pi}, 
   Legend -> "Expressions"];
 Update[];

<ParametricPlot.png
</PRE>
<LI>
<H3><A NAME=L431>
Plot</A>
</H3>
<PRE>Usage: Plot[fun, range, options] or Plot[{fun1, .. }, range, options],

where fun is a function and range is a list given as {x, xmin, xmax}.

options        defaults
-----------------------------------------
MaxBend        0.01
PlotPoints     25
PlotDivision   250
Dashing        {"1","0.8 0.24","0.4 0.12","0.2 0.08","0.1 0.08",
                  "0.8 0.08 0.08 0.08","0.4 0.08 0.08 0.08"}
Options for ListPlot and Graphics are also available

The independent variable should have been cleared (i.e., no value should
not be set) when Plot is called. 

Example:
  ff[x_]:=Sin[x]/x;
  ff[0]=1;
  Plot[{Cos[x],ff[x]}, {x,0,10}, Thickness->2];
  Update[];

<Plot.png
</PRE>
<LI>
<H3><A NAME=L432>
PointSymbol</A>
</H3>
<PRE>Notations for symols to be plotted:
------------------------------------------
"1O", "CI", "CL"        circle
"6O", "LT"              left triangle
"7O", "RT"              right triangle
"8O", "DT"              down triangle
"9O", "UT"              up triangle
"SQ", "BX"              square
"DI", "DM", "RH"        diamond
"CR", "PL"              plus)
"DC", "TI", "MU", "ML"  times, multiply)
Bar, "BA". "BR"         bar from axis

Example:
sym={
  {"CI","CL","1O",},{"LT","6O"},{"RT","7O"},{"DT","8O"},{"UT","9O"},
  {"SQ","BX"},{"DI","RH","DM"},{"PL"},{"TI", "ML", "MU"},{Bar,"BA","BR"}};
Show[
  Graphics[Join[
    Table[Point[{1+Floor[(k-1)/5]*0.5,5-Mod[k-1,5]},PointSymbol->sym[[k]][[1]],
      PointSize->3],{k,Length[sym]}],
    Table[Text[{(sym[[k]]//"")[2,-2],
      {Scaled[1.1+Floor[(k-1)/5]*0.5],Scaled[5-Mod[k-1,5]]}}],{k,Length[sym]}]],
    FrameLabel->{"","","\\@{\\tt PointSymbol} in CanvasDrawer"},
    FrameTicks->{None,Both,None,None},
    DataRange->{{0.9,1.9},{0,5.5}},GridLines->{None,Axis}]];

<PointSymbol.png
</PRE>
</UL>
<LI>
<H3><A NAME=L433>
Input/Output</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L434>
$FORM</A>
</H3>
<PRE>$FORM is a character-string to specify the format of the output of a real number.

Usage: $FORM="w.f"
       $FORM="Sw.f"
       $FORM="Fw.f"
       $FORM="Mw.f"

where w is the width of the output, and f is the length of the fractions. If S is attached, trailing zeroes are omitted. If F is at
tached, it becomes same as FORTRAN's F-format. If M is attached, the exponent is expressed as 10^n. If w and f are omitted, 17.15 i
s assumed.
   The default is S17.15 .
</PRE>
<LI>
<H3><A NAME=L435>
$Input</A>
</H3>
<PRE>$Input holds the file number for console input stream. The default is -1.
</PRE>
<LI>
<H3><A NAME=L436>
$Output</A>
</H3>
<PRE>$Output holds the file number for console output. The default is -1.
</PRE>
<LI>
<H3><A NAME=L437>
Close</A>
</H3>
<PRE> Close[f] closes file number [f]. It is necessary to complete the output to an external file.
 Close[f1, ...] and Close[{f1, ...}] close all files f1, ...
</PRE>
<LI>
<H3><A NAME=L438>
OpenAppend</A>
</H3>
<PRE>f = OpenAppend[file]

opens file (_String) for write and returns the file number (_Real)
</PRE>
<LI>
<H3><A NAME=L439>
OpenRead</A>
</H3>
<PRE>f = OpenRead[file]

opens file (_String) for read and returns the file number (_Real)
</PRE>
<LI>
<H3><A NAME=L440>
OpenWrite</A>
</H3>
<PRE>f = OpenWrite[file]

opens file (_String) for write and returns the file number (_Real)
</PRE>
<LI>
<H3><A NAME=L441>
PageWidth</A>
</H3>
<PRE>PageWidth is the number of columns of the output. The default is set from GetEnv["WIDTH"].
</PRE>
<LI>
<H3><A NAME=L442>
Print</A>
</H3>
<PRE>
   Print[expr1 [,expr2 ...]]

converts expr1... to _String then write them to $Output. A newline character is appended at the end.
</PRE>
<LI>
<H3><A NAME=L443>
Read</A>
</H3>
<PRE>Read[f, item [, item1...] [, opts..]]

reads item from file number f. If f is $Input, it reads from the current input stream. item can be one of or a list of:
Word        a word, delimited by WordSeparators
Real        a real expression
Expression  an expression
Character   a single character

 A format n*item is possible with a positive integer n.
 A list {item1,.., itemn} is possible. The result is also a list.

 opts are options given by a Rule:
Option         Value       Default    Effect
WordSeparator  _String     " ,\t"     the delimiters for Word
ReadNewRecord  True/False  True       If true, read the next record of the file beyond the end of line
NullWords      True/False  False      If True, "" is returned when the input contains adjavent word separators
</PRE>
<LI>
<H3><A NAME=L444>
ReadString</A>
</H3>
<PRE>ReadString[f]

reads the next record from file number f, and returns it as a _String.
</PRE>
<LI>
<H3><A NAME=L445>
StandardForm</A>
</H3>
<PRE>StandardForm[expr]

resets $FORM and PageWidth to their defaults, then evaluate expr, returns the result, and resets $FORM and PageWidth to those at th
e beginning of StandardForm.
</PRE>
<LI>
<H3><A NAME=L446>
StringToStream</A>
</H3>
<PRE>f = StringToStream[string]

opens a character string for read and returns the file number (_Real)
</PRE>
<LI>
<H3><A NAME=L447>
Write</A>
</H3>
<PRE>   Write[f, expr1 [,expr2 ...]]

converts expr1... to _String then write them to file number f. A newline character is appended at the end.
</PRE>
<LI>
<H3><A NAME=L448>
WriteString</A>
</H3>
<PRE>WriteString[f, expr1 [,expr2 ...]]

converts expr1... to _String then write them to file number f. No newline character is appended.
</PRE>
</UL>
<LI>
<H3><A NAME=L449>
Multiprocessing</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L450>
Fork</A>
</H3>
<PRE>Forks the process into a parent and a child processes.

   Fork[]

returns 0 and the child's pid for the child and the parent, respectively.
</PRE>
<LI>
<H3><A NAME=L451>
OpenShared</A>
</H3>
<PRE>Allocated shared memory of n bytes.


   s = OpenShared[n] ,

where s is a file number to be used by Shared function. The allocated memory can be released by Close[s].
</PRE>
<LI>
<H3><A NAME=L452>
Shared</A>
</H3>
<PRE>Read/Write to the shared memory.

   Shared[s]
   Shared[s] = x
   Shared[s] := x

where s is given by OpenShared, and x is Real, built-in function, String, defined symbol, or list of them.
</PRE>
<LI>
<H3><A NAME=L453>
SharedSize</A>
</H3>
<PRE>Returns the size of an object for OpenShared.

   n = SharedSize[x] 
</PRE>
</UL>
<LI>
<H3><A NAME=L454>
Object-oriented-programing</A>
</H3>
<PRE>Environment for an object-oriented-programming is supplied by:

Class:          The function to define a class.
context:        A class defines a context to define its all symbols for
                the variables and methods within the context.
                This automatically avoids conflicts of symbols between 
                classes, Global, and System. When c = Class[ ... ] is
                done, a context c` is defined.

members:        The set of Members of a class is a union of class variables,
                instance variables, and class methods of the class.

operator @:     A special operator to access class member. In a notation 
                f@g, g's context defaults the class of the class of f. 
                f@g@h[x] is recognized as ((f@g)@h)[x] , thus the context of
                h defaults the class of f.

superclasses:   A class inherits all class variables, instance variables,
                class methods from its superclasses which are give by the
                first argument of Class. If a null list is given, Object` 
                is set as the default superclass. Multiple inheritance is
                allowed.

class variable: Class variables are given by the second argument of Class
                as a list of symbols. They are unique in the class.
                They can be initialized by declaring in a way such as 
                {a=1, {b, c} = {2, 3}} like Module. A form like
                {a = b = c =1} is allowed.

instance variable: 
                Instance variables are given by the third argument of Class
                as a list of symbols. An instance has those symbols
                separately. They can be initialized by declaring in a way
                such as {a=1, {b, c} = {2, 3}} like as Module. A form like as
                {a = b = c =1} is allowed. Also they
                are initialized at the creation of instance by rules as
                x = c[ a->1, b:>Print[d]], etc.

class methods:  Class methods are given by the fourth(last) argument of
                Class. They must be in the form of either one of

                f_[arg___] := g_;
                With[_, f_[arg___] := g_];
                With[_, f_[arg___] := g_; .. ];
                If[_,
                  ft_[argt___] := gt_; ..,
                  ft_[argf___] := gf_; ..,];
                h_[f_[arg___], b___] ^:= g_; .

                where f is the symbol for the method to be defined.
                Set may be used instead of SetDelayed if necessary.

This:           A symbol This in the definition of the method, it is 
                translated to the object (the instance or the class) which 
                refers the member.

default reference:
                In the definition of the class methods, whenever a member of
                the class is appeared, it is recognized as This@member.
                When a symbol of the member conflicts the symbol in System`,
                the system symbol should be wrapped by Literal.

reference of member of superclasses:
                Members of the superclasses (denote cc) are referred by 
                cc`member in the definition of the method.

copying an instance:
                An instance c of a class can be copied to another symbol
                by c1 = c. After the copying, c1 and c refer the identical
                instance. Destructing one of them by such as c1=. clears
                the instance and also all the assigned symbols.

Constructor:    When an instance is defined, by x = c[arg], a method
                x@Constructor[arg] is always invoked.
                In evaluation of instance definition under class scope,
                class member symbol appeared 1st slot of Rule or RuleDelayed
                argument is sent to Constructor of new class instance
                without evaluation. (In other term, class member symbol on
                1st slot of Rule or RuleDelayed argument behaves like
                evaluating with implicit Literal[]) One can configure
                Constructor[] in the definition of the class.
                x = c[arg] returns the returned value of Constructor[arg].
                The rules in the argument work in two ways: (1) A rule for an
                instance variable or a class variable sets the initial value
                of the variable, (2) Other rules are stored in an instance
                variable Options as a list.

Destructor:     An instance x is cleared by (x=.), which invokes 
                x@Destructor[]. The default Destructor is Object`Destructor,
                but one can reconfigure it in the definition of the class.

Short:          When an instance x is returned as the result of expression
                for Out[], x@Short[] is invoked to show the result. The 
                default Short is Object`Short, but one can reconfigure it
                in the definition of the class.

other methods:  Class[] gives the class of the instance.
                Parents[] gives the immediate superclasses.
                AllParents[] gives the all superclasses.
                Members[] gives a list of class variables, class methods,
                and instance variables of the class.
                AllMembers[] gives a list of class variables, class methods,
                and instance variables of the class and its all parents.
</PRE>
<UL>
<LI>
<H3><A NAME=L455>
Class</A>
</H3>
<PRE>Class sets up a class of objects.

Usage:   a = Class[
               list of superclasses,
               list of class-variables,
               list of instance-variables,
               class-methods];

Example: a = Class[
               {aa, bb},      (* aa and bb are superclasses *)
               {a1, a2},      (* class-variables *)
               {v1, v2},      (* instance-variables *)
               Constructor[arg__] := (Print[{arg}]; v1 = Plus[arg]);
               sum[] := v1 + v2 (* defining Constructor and method "sum"*)
             ];

         a1 = a[1, 2]          (* creating an instance of a *)
         a1@v1                 (* accessing an instance variable *)
         a1@v2 = 3             (* setting an instance variable *)
         a1@sum[]              (* calling a method "sum" *)
         a1=.                  (* delete an instance *)
</PRE>
</UL>
<LI>
<H3><A NAME=L456>
Random-number-functions</A>
</H3>
<PRE>The random number functions use common seed given by SEED command or SeedRandom function. It has an initial value 17 at the be
ginning of FFS. The cut-off value of GaussRandom[] is given by variable GCUT.
</PRE>
<UL>
<LI>
<H3><A NAME=L457>
Random</A>
</H3>
<PRE>Random[]           gives a uniform random number between 0 and 1.
Random[n]          gives a list of n uniform random numbers.
Random[n1, n2, ..] gives a (n1 * n2 * .. ) tensor of uniform random numbers.
</PRE>
<LI>
<H3><A NAME=L458>
GaussRandom</A>
</H3>
<PRE>GaussRandom[]           gives a Gaussian random number with average 0, 
                        standard deviation 1, cutoff at GCUT.
GaussRandom[n]          gives a list of n Gaussian random numbers.
GaussRandom[n1, n2, ..] gives a (n1 * n2 * .. ) tensor of Gaussian random
                        numbers.
</PRE>
<LI>
<H3><A NAME=L459>
ParabolaRandom</A>
</H3>
<PRE>ParabolaRandom[]           gives a parabola random number between -1 and 1. 
ParabolaRandom[n]          gives a list of n parabola random numbers.
ParabolaRandom[n1, n2, ..] gives a (n1 * n2 * .. ) tensor of parabola random
                           numbers.
</PRE>
<LI>
<H3><A NAME=L460>
SeedRandom</A>
</H3>
<PRE>SeedRandom[plugin_String] selects new pseudo random-number generator
                          plugin named as plugin.
SeedRandom[seed_Real]     initializes the internal state of the current
                          pseudo random-number generator plugin by seed.
SeedRandom[{seeds__Real}] initializes the internal state of the current
                          pseudo random-number generator plugin by {seeds}.
SeedRadnom[state_List]    restores both the selection of the pseudo random-number
                          generator plugin and the internal state of the selected
                          plugin by using state dumped by SeedRandom[].
SeedRandom[]              returns List containing both the current selected pseudo
                          random-number generator plugin name and its internal state.
</PRE>
<LI>
<H3><A NAME=L461>
ListRandom</A>
</H3>
<PRE>ListRandom[] returns List of available pseudo random-number generator plugins.
</PRE>
</UL>
<LI>
<H3><A NAME=L462>
System-interface</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L463>
System</A>
</H3>
<PRE>System[string] executes string as a shell command. It returns the system return code.
</PRE>
<LI>
<H3><A NAME=L464>
TemporaryName</A>
</H3>
<PRE>TemporaryName[] returns a unique file name for a temporary use.
</PRE>
</UL>
<LI>
<H3><A NAME=L465>
Utilities</A>
</H3>
<PRE>
</PRE>
<UL>
<LI>
<H3><A NAME=L466>
DateString</A>
</H3>
<PRE> DateString[] returns the current date and time as string  "mm/dd/CCYY HH:MM:SS".
 DateString[date] converts date to string as above. The date can be either a real number (in second, date=0 is 1/1/1900 0:0:0) or a
 list of 6 reals {Y,m,d,H,M,S}.
</PRE>
<LI>
<H3><A NAME=L467>
MemoryCheck</A>
</H3>
<PRE>MemoryCheck[n]

checks the consistency of the memory allocation by SAD. The range of the check and the output depend on n:	

MemoryCheck[]  : checks the consistency of the free area and returns the allocation info,
MemoryCheck[1] : checks the consistensy of the free and used areas. Returns the allocation info.
MemoryCheck[2] : checks the consistensy of the free and used areas. Returns the allocation info. and a list of free segments.	

 The returned value is {used, allocated from system, # of free segments, missing size[, list of free segments]} in units of word (=
 8 bytes).
 If an inconsistency is found, messages are printed out.
</PRE>
<LI>
<H3><A NAME=L468>
TimeUsed</A>
</H3>
<PRE>TimeUsed[] returns the cputime since the start of SAD in seconds.
</PRE>
<LI>
<H3><A NAME=L469>
Timing</A>
</H3>
<PRE>Timing[fun]

evaluates fun and returns {cputime, result}. cputime is in seconds.
</PRE>
<LI>
<H3><A NAME=L470>
TracePrint</A>
</H3>
<PRE>TracePrint[fun]

prints out all function calls and each expression compound in ";" in the evaluation of fun.
</PRE>
</UL>
</UL>
<H3><A NAME=L471>
FIT</A>
</H3>
<PRE>Usage: (1) FIT [component]
       (2) FIT component1 component2

sets the current location where the matching condition is applied. The component is given with the form name[.order][{+-}offset] (s
ee components). If component is omitted, the end of the beam line is chosen.
   If two components are given, it means a relative-fitting or zone-fitting. If the fitting condition is not maximum-fitting, the c
ondition means to make values at two components equal (for AX, BX, GMX, AY, BY, GMY, EX, EPX, EY, EPY, R1, R2, R3, R4, DX, DPX, DY,
 DPY, PEX, PEPX, PEY, PEPY, CHI1, CHI2, CHI3),  or have the specified difference (for NX, NY, LENG, GX, GY, GZ). If the fitting con
dition is maximum-fitting, the condition means a zone-fitting (for AX, BX, GMX, AY, BY, GMY, EX, EPX, EY, EPY, R1, R2, R3, R4, DX, 
DPX, DY, DPY, PEX, PEPX, PEY, PEPY, CHI1, CHI2, CHI3), which suppress the maximum of the function in the region between component1 
and component2, or maximum-fitting for the difference of the function (for NX,  NY, LENG, GX, GY, GZ). The fit region is shown in t
he first part of the prompt when FFSPRMPT is ON.

Examples: (1) FIT QF.2-10

sets the current fit point at  10 components upstream from the entrance of the second QF.

          (2) FIT QF QD NX 0.5 BXM 10

sets the two-point fitting between QF and QD, then set the difference of NX between QF and QD to be 0.5, and the maximum of BX to b
e 10 in the region between QF and QD.
</PRE>
<H3><A NAME=L472>
FITPOINTS(FITP)</A>
</H3>
<PRE>Usage: FITP n

 sets n to the number of off-momentum points in the off-momentum matching. If the fitting condition is on-momentum only, it is not 
affected.
</PRE>
<H3><A NAME=L473>
FIX</A>
</H3>
<PRE>Usage: (1) FIX element-pattern [keyword] [element-pattern1 [keyword1]..]

removes elements which match element-pattern from the matching variables. The optional keyword specifies the non-default variables.
 If the keyword is omitted, all keywords are removed.
   For the MARK element at the beginning of the beam line, a special form can be used for the FIX command. That is a form &lt match
ing-function>&gt I (appending "I" to a matching-function name).

Example: FIX AXI BXI AYI BYI

removes incoming AX, BX, AY, and BY from the matching variables.

Usage: (2) FIX

sets the standard optics for the orbit correction commands.
</PRE>
<H3><A NAME=L474>
FREE</A>
</H3>
<PRE>Usage: FREE element-pattern [keyword] [element-pattern1 [keyword1]..]

specifies elements which match element-pattern as the matching variables. The optional keyword specifies the non-default variables.
 See default-keyword. 
   For the MARK element at the beginning of the beam line, a special form can be used for the FREE command. That is a form &lt matc
hing-function &gt I  (appending "I" to a matching-function name) which means the incoming condition of the matching-function is var
ied in the matching.

Example: FREE AXI BXI AYI BYI

changes incoming AX, BX, AY, and BY to find the solution.
</PRE>
<UL>
<LI>
<H3><A NAME=L475>
default-keyword</A>
</H3>
<PRE>The default and available non-default variable keywords are:

type    default-keyword  non-default variable keyword
DRIFT   L                -
BEND    ANGLE            K1,K0,E1,E2
QUAD    K1               ROTATE
SEXT    K2               ROTATE
OCT     K3               ROTATE
DECA    K4               ROTATE
DODECA  K5               ROTATE
MULT    K1               K0,K2..K21,SK0,SK1,SK2..SK21,ROTATE,ANGLE
MARK    -                AX,BX,EX,EPX,AY,BY,EY,EPY,R1,R2,R3,R4,DETR,
                         DX,DPX,DY,DPY,DZ,DDP,AZ,BZ,ZX,ZPX,ZY,ZPY
</PRE>
</UL>
<H3><A NAME=L476>
geometric-functions</A>
</H3>
<PRE>Available geometric-functions are:

GX      geometrical coordinate xi
GY      geometrical coordinate eta
GZ      geometrical coordinate zeta
CHI1    geometrical rotation angle ch1_1
CHI2    geometrical rotation angle ch1_2
CHI3    geometrical rotation angle ch1_3

The geometrical coordinate {xi, eta, zeta} is set by the ORG command, and its default origin is at the entrance of the beam line, a
nd the default directions are xi in s-direction, eta in -(x-direction), and zeta in -(y-direction) at the entrance. The set {xi, et
a, zeta} forms a right-hand system.
   The rotation angles are defined so as to give the local {x,y,s} is written

    {x, y, s}_local
   = rotate[s, chi3] rotate[x, chi2] rotate[y, -chi1]{x, y, s}_origin,

where rotate[a, b] reads "rotate around the new-a vector by b right-handedly.

geometric functions disignate the geometry of the coordinate. If the geometry of orbit is needed, use LINE["OGEO"], etc., or DISP O
G.
</PRE>
<H3><A NAME=L477>
GO</A>
</H3>
<PRE>Usage: GO [[NO]EXPAND]

Does matching for fitting conditions given by matching-function-commands with variables specified by FREE.

If an option EXPAND is given, it expands the beam line before the calculation. If NOEXPAND is given, it avoids any expansion. The d
efault behavior on EXPAND is controlled by the KEEPEXP flag.   FFS["CAL"] and FFS["GO"] returns the result as a list, whose format 
is

   {dp, kind, reslist, function-values},

where	

dp:        a list contains dp/p0 .
kind:      a list of kind of the orbit (usually 0, but 1 to 6 for the finite amplitude matching, see MatchingAmplitude).
reslist:   a list of {residual, xstab, ystab}, where	
       residual: matching residual,
       xstab:    True when the matrix is stable in X,
       ystab:    True when the matrix is stable in Y, for each orbit.

Above are lists with length nf (== number of orbits).

function-values: a list of length nc (== number of calculated items). Each element has the form:

       {component1, component2, function, list-of-values},

       where

       component1, component2: fit locations (see FIT).
       function: name of the function (see matching-function-commands).
       list-of-values: list of the value of the function for each orbit Length nf.
       The central orbit comes at the Floor[(n+1)/2]-th element.
</PRE>
<H3><A NAME=L478>
IF</A>
</H3>
<PRE>Usage: IF expr1 body1 [ELSEIF expr2 body2 [ELSEIF ..]] [ELSE body3] ENDIF

This is a FORTRAN77 like IF-structure. If the expression expr1 is True(==1) or nonzero, executes commands in body1. If it is False(
==0), skip commands until ELSE, ELSEIF or ENDIF appears at the same level of the IF-structure, and executes commands after ELSE or 
ENDIF, or executes the ELSEIF command. If expr1 is not a real number, an error message is printed and ignores the command line.

</PRE>
<H3><A NAME=L479>
INPUT(IN)</A>
</H3>
<PRE>IN {filename | file-number} switches the input stream to the specified file or the file-number. The original stream is kept an
d to be returned by TERMINATE(TERM). The input file is not rewound.
</PRE>
<H3><A NAME=L480>
machine-error-commands</A>
</H3>
<PRE>Usage: machine-error-command [options] amount component-pattern ..

where machine-error-command is one of

command    keyword affected     applicable types
DELX       DX                   BEND QUAD SEXT OCT DECA DODECA SOL CAV
DELY       DY                   BEND QUAD SEXT OCT DECA DODECA SOL CAV
DL         L                    DRIFT SOL
DTHETA     ROTATE               QUAD SEXT OCT DECA DODECA CAV
DTHETA     DROTATE              BEND
DK         default-keyword      DRIFT BEND QUAD SEXT OCT DECA DODECA MULT SOL CAV
DDK        K0 or DBZ            BEND SOL

   amount is the amount of the error,
   component-pattern is the pattern to specify the components to be applied.

   Options are	

RANDOM(R)        Set amount*GaussRandom[] to the keyword. 
UNIFORM(U)       Set the specified amount to the keyword without random number.
INCOHERENT(INC)  GaussRandom[] is called for each component. Default.
COHERENT(C)      GaussRandom[] is called once for each component-pattern.
PUT(P)           Set the error to the keyword. Default.
ADD(A)           Add the error to the keyword.	
</PRE>
<H3><A NAME=L481>
matching-function-commands</A>
</H3>
<PRE>Usage: (1) matching-function  goal-value [off-momentum-points]
       (2) matching-functionM goal-value [off-momentum-points]
       (3) matching-functionI incoming-value
       (4) matching-functionSCALE scale

(1) sets the matching condition for matching-function at the current fitting point or region with the goal-value and the off-moment
um-points (see off-momentum-matching).
   If off-momentum-points is omitted, the previous value for this matching-function at this fitting-point is assumed. If the previo
us value is not defined, 1 is assumed. If -1 is given for off-momentum-points, the matching-function is rejected from the matching 
(see REJECT(REJ)).
   If "*" is given for goal-value, the previous value is used if exists.

Example:   BX 10 3    (beta_x to be 10 at 3 momenta) 
           BX 20      (now beta_x to be 20 at 3 momenta (previous setting))
           BX *  5    (now beta_x to be 20 (previous setting) at 5 momenta)

(2) If the letter "M" is appended to matching-function, it means the maximum-fitting for the function. The maximum of either the va
lue (for positive-definite functions) or the absolute value (for bipolar functions) are to be limited in the matching.

(3) If SCALE is appended to matching-function, it sets the scale of the input/output of the function to scale. This scale is used i
n the matching-function commands, DISPLAY(DISP), SHOW, etc.

(4) If the current fit location is at a MARK, @ refers the saved value at the MARK. @- refers -(saved value), and @* refers (the or
ientation of MARK)*(saved value).  These are useful to match using the already-saved values, for instance to match between two beam
 lines having the common MARK.

   Available matching-functions are:
optical-functions (see optical-functions):
AX BX GMX NX AY BY GMY NY EX EPX EY EPY R1 R2 R3 R4 DETR DX DPX DY DPY DZ DDP PEX PEPX PEY PEPY TRX TRY LENG
geometric-functions (see geometric-functions):
GX GY GZ CHI1 CHI2 CHI3
</PRE>
<H3><A NAME=L482>
multi-turn-tracking</A>
</H3>
<PRE>The multi-turn tracking can be done by TrackParticles or DynamicApertureSurvey[] function in FFS.

The multi-turn tracking uses the closed orbit, normal coordinate, and the equilibrium emittances. Therefore One of EMITTANCE(EMIT),
 the Emittance[] function, or the EMIT command in the MAIN level are necessary to be done once in prior to the multi-turn-tracking.
 The values of EMITX, EMITY, EMITZ, SIGE can be changed between EMITs and the multi-turn-tracking.
</PRE>
<H3><A NAME=L483>
MATRIX(MAT)</A>
</H3>
<PRE>Usage: MATRIX [{SYMPLECTIC(S) | PHYSICAL(P)}] [from to]

prints out the 4 by 5 (w/CALC4D) or 6 by 6 (w/CALC6D) transfer matrix from from-component to to-component. If SYMPLECTIC(S) is spec
ified (default), the symplectic transfer matrix on {x,px/p0,y,py/p0,dp/p0} where p0 is the nominal momentum at the entrance, is giv
en. Otherwise, in the case of TRPT, the transfer matrix on {x,px/p0(s),y,py/p0(s),dp/p0(s)} is printed out.
   If the from- and to- components are omitted, entire beam line is assumed.
If to-component is upstream the from-component, it gives the inverse matrix (TRPT) or one-turn-wrapped matrix (RING).
</PRE>
<H3><A NAME=L484>
MEASURE(MEA)</A>
</H3>
<PRE>Usage: MEA [end-component] [OUT file plot-spaces]

tracks particles from the entrance to end-component and prints out the statistics at the end. If end-component is omitted, the comp
onent end used in the last MEASURE(MEA) (default: end of the beam line) is assumed.
   If OUT file plot-spaces are attached, it plots phase space distribution on file. The phase-spaces are specified like as X-PX, 
or X-Y, etc., (up to any numbers).
   Parameters for the tracking are specified by special-variables and flags:

seed for the random-number generator:
     SeedRandom[seed_Real] or SeedRandom[{seeds__Real}]

special-variables (can be set with =):
     NP        number of particles 
     EMITX     horizontal emittance
     EMITY     vertical emittance
     DP        relative momentum spread
     DP0       relative momentum offset dp/p0
     GCUT      cut-off value of the Gaussian tail
flags:
     GAUSS/UNIFORM    Gaussian/uniform(default) momentum distribution
     JITTER/NOJITTER  off(default)/on nullifying the incoming centroid offset
     RFSW/NORFSW      switch on(default)/off the rf-cavities
     RAD/NORAD        synchrotron radiation on/off
     RADCOD/NORADCOD  off/on compensation of energy loss due to radiation
     FIXSEED/MOVESEED keep(default)/unkeep the initial random-number seed

   The initial transverse distribution is Gaussian.
</PRE>
<H3><A NAME=L485>
off-momentum-matching</A>
</H3>
<PRE>FFS matches the optical functions for an orbit with finite momentum deviation.

Example: 
   DP=0.01;      sets the range of momentum to DP0-0.01 < dp/p0 < DP0+0.01 .
   BX 10 9;      sets the goal of betax to 10 m, at 9 points.
                 in the range above, i.e.,
                 dp/p0 = {-0.01,-0.0075,-0.005,-0.0025,0,
                          0.0025,0.005,0.0075,0.01} + DP0 .
   GO starts the matching.

As this example, the off-momentum points are chosen with equal separation. If the off-momentum point n is an even number, the chose
n points are same as the case of n+1, but the on-momentum point (==DP0) is excluded.
 If a list {min, max} is set to DP, the off-momentum matching is performed at dp/p(k) = min*Sin[k Pi/2/n], max*Sin[k Pi/2/n], {k,0,
fitp/2}, where fitp is the number of off-momentum points given by FITP.
</PRE>
<H3><A NAME=L486>
optical-functions</A>
</H3>
<PRE>Available optical functions for matching are:	

AX      alpha_X
BX      beta_X
GMX     gamma_X
NX      psi_X, the default scale is 1/(2Pi)
AY      alpha_Y
BY      beta_Y
GMY     gamma_Y
NY      psi_Y, the default scale is 1/(2Pi)
EX      eta_X   (dispersion_X)
EPX     eta_Px  (dispersion_PX) 
EY      eta_Y   (dispersion_Y)
EPY     eta_Py  (dispersion_PY)
R1      R_1     (see x-y-coupling)
R2      R_2     (see x-y-coupling)
R3      R_3     (see x-y-coupling)
R4      R_4     (see x-y-coupling)
DETR    R_1*R_4 - R_2*R_3 (see x-y-coupling)
DX      dx
DPX     dpx
DY      dy
DPY     dpy
DZ      dz
DDP     delta=dp/p0
AZ      alpha_Z
BZ      beta_Z
GMZ     gamma_Z
NZ      psi_Z, the default scale is 1/(2Pi)
ZX      zeta_X  (z-dispersion_X)
ZPX     zeta_Px (z-dispersion_PX) 
ZY      zeta_Y  (z-dispersion_Y)
ZPY     zeta_Py (z-dispersion_PY)
PEX     eta_x   (dispersion_x)
PEPX    eta_px  (dispersion_px) 
PEY     eta_y   (dispersion_y)
PEPY    eta_yy  (dispersion_py)
TRX     trace(T_X), only defined at the end of the beam line.
TRY     trace(T_Y), only defined at the end of the beam line.
BMAGX   BmagX, against the reference optics.
BMAGY   BmagY, against the reference optics.
BMAGZ   BmagZ, against the reference optics.
LENG    length of the design orbit	

In the above, upper case X, Px, Y, Py represents the x-y decoupled coordinate. EX, EPX, EY, EPY refer the decoupled coordinate, whi
le PEX, PEPX, PEY, PEPY are in the physical coordinate. On the other hand,  DX, DPX, DY, DPY refer the physical coordinate.
</PRE>
<H3><A NAME=L487>
ORG</A>
</H3>
<PRE>Usage: ORG location, dgx, dgy, dgz, dchi1, dchi2, dch3

sets the origin of the geometrical coordinate relative to the location with a relative shift (dgx, dgy, dgz) and rotation (dchi1, d
chi2, dchi3).
 If location is omitted, reset geometrical coordinate to the original setting.
 CALC is necessary to reflect the setting to the geometry at each point.
</PRE>
<H3><A NAME=L488>
OUTPUT(OUT)</A>
</H3>
<PRE>OUT {filename | file-number} switches the output stream to the specified file or the file-number. The file is written from the
 beginning.
</PRE>
<H3><A NAME=L489>
pattern</A>
</H3>
<PRE> Pattern is a special expression for mathing arguments in function definitions and rules with several forms:

_           matches any single argument.
__          matches a sequence of 1 or more arguments.
___         matches a sequence of 0 or more arguments.
x_          matches any single argument, which is names x.
x__         matches a sequence of 1 or more arguments, which is named x.
x___        matches a sequence of 0 or more arguments, which is named x.
x:pattern   a pattern which is named x.
pattern:v   a pattern which has a default value v when matching is failed.
pattern..   a non-null sequence of arguments each of which matches pattern.
pattern...  a sequence, which can be null, of arguments each of which matches pattern.
expression  matches expression.
</PRE>
<UL>
<LI>
<H3><A NAME=L490>
MatchQ</A>
</H3>
<PRE> MatchQ[x, pat] returns True if x matches pat
</PRE>
</UL>
<H3><A NAME=L491>
physical-constants</A>
</H3>
<PRE>EquAlign["Text[Physical constants available in FFS are:\n\\begin{align*}\n{\\tt SpeedOfLight} &\\qquad c\\equiv 299792458 {\\\
rm\\ m/s}\\\\\n{\\tt PlanckConstant} &\\qquad h \\equiv 6.62607015\\times 10^{-34} {\\rm\\ Js}\\\\\n{\\tt PlanckHbar} &\\qquad \\h\
bar\\equiv h/(2\\pi)\\\\\n{\\tt ElectronCharge} &\\qquad  e_e \\equiv 1.602176634\\times 10^{-19} {\\rm\\ C}\\\\\n{\\tt FineStruct\
ureConstant}&\\qquad  \\alpha = 1/137.035999084 \\\\\n{\\tt ElectronMass}&\\qquad  m_e = 0.51099895000\\times 10^6 {\\rm\\ eV}\\\\\
\n{\\tt ElectronRadius}&\\qquad  {\\rm classical\\ radius\\ of\\ electron\\ in\\ m,} r_e \\equiv \\alpha \\hbar c / (e_e m_e)\\\\\\
n{\\tt ProtonMass}&\\qquad  m_p  = 938.27208816\\times 10^6 {\\rm\\ eV}\\\\\n{\\tt ProtonRadius}&\\qquad  {\\rm classical\\ radius\
\\ of\\ proton\\ in\\ m}\\\\\n{\\tt SIMu0}&\\qquad \\mu_0\\equiv 2\\alpha h/(c e_e^2)\\\\\n{\\tt SIEpsilon0}&\\qquad    \\varepsil\
on_0\\equiv 1/(\\mu_0 c^2)\\\\\n{\\tt ElectronGminus2over2}&\\qquad   (g-2)/2 {\\rm\\ of\\ electron} = 0.001159652181280002\\\\\n{\
\\tt BoltzmannConstant}&\\qquad   1.380649\\times 10^{-23} {\\rm\\ J/K .}\n\\end{align*};;;0]",
"Physical constants available in FFS are:\n\nSpeedOfLight           c = 299792458 m/s\nPlanckConstant         h = 6.62607015d-34 J\
s\nPlanckHbar             hbar = h/2/Pi\nElectronCharge         e_e = 1.602176634d-19 C\nFineStructureConstant  alpha = 1.d0 / 137\
.035999084d0\nElectronMass           m_e in eV = 0.51099895000d6\nElectronRadius         classical radius of electron = alpha hbar\
 c / (e_e m_e), in m\nProtonMass             m_p in eV = 938.27208816d6\nProtonRadius           classical radius of Proton, in m\n\
SIMu0                  2 alpha h / e_e^2 / c\nSIEpsilon0             1/SIMu0/c^2\nElectronGminus2over2   (g-2)/2 of electrons = 0.\
001159652181280002\nBoltzmannConstant      1.380649d-23 J/K"
]</PRE>
<H3><A NAME=L492>
PRINT(PRI)</A>
</H3>
<PRE>PRI expression evaluates expression and prints out the result.
</PRE>
<H3><A NAME=L493>
QUIT</A>
</H3>
<PRE>Exits FFS and return to SAD/MAIN level, without saving the values of the elements.
</PRE>
<H3><A NAME=L494>
RADINT</A>
</H3>
<PRE>RADINT prints out the radiation integrals involving the x-coupling for all components of the beam line.
</PRE>
<H3><A NAME=L495>
READ</A>
</H3>
<PRE>READ {filename | file-number} switches the input stream to the specified file or the file-number. The original stream is kept 
and to be returned by TERMINATE(TERM). The input file is rewound.
</PRE>
<H3><A NAME=L496>
RECOVER(REC)</A>
</H3>
<PRE>REC exchanges the values of FREEd elements with those when the last GO command was issued. FIXed elements are not affected.

</PRE>
<H3><A NAME=L497>
REFERENCE(REF)</A>
</H3>
<PRE>REFERENCE(REF) sets the current optics as the reference optics.
</PRE>
<UL>
<LI>
<H3><A NAME=L498>
reference-optics</A>
</H3>
<PRE>Optics stored as a reference. Can be refered by DISP REF (mode), DRAW, Twiss, OpticsPlot. Set automatically by the first CALC 
or GO after USE. Can be updated by REFERENCE(REF).
</PRE>
</UL>
<H3><A NAME=L499>
REJECT(REJ)</A>
</H3>
<PRE>Usage: (1) REJ matching-function-pattern [matching-function-pattern1..]
       (2) REJ TOTAL
       (3) REJ TOTALFIT

rejects the matching-functions which match matching-function-pattern at the current FIT location. If TOTAL or TOTALFIT is given, th
e entire matching conditions in all locations are rejected, then output parameters by CALCULATE are reset when TOTAL is given.

</PRE>
<H3><A NAME=L500>
RENUMBER(RENUM)</A>
</H3>
<PRE>RENUM comp renumbers the component number starting from a component comp.
</PRE>
<H3><A NAME=L501>
REPEAT(REP)</A>
</H3>
<PRE>Usage: REP [n] body UNTIL [expr1]

executes commands in body n times until expr1 gives nonzero. The number n can be any expression which gives a number. If n is omitt
ed, infinity is assumed. If expr1 is omitted, False(==0) is assumed.
</PRE>
<H3><A NAME=L502>
RESET</A>
</H3>
<PRE>Usage: RESET [ALL] [element-pattern]

restores the value of the elements. What are restored are the value of the default keyword of all elements, the values of the non-d
efault keywords which have been changed manually or by the matching. If ALL is given, it resets all keywords. If element-pattern is
 given, reset is limited to the elements which match the pattern.
</PRE>
<H3><A NAME=L503>
RESUME(RES)</A>
</H3>
<PRE>Resumes reading from the previous input stream suspended by SUSPEND(SUSP) or END.
</PRE>
<H3><A NAME=L504>
REVERSE(REV)</A>
</H3>
<PRE>REV changes the sign of AX, AY, EPX, EPY, R2, R3, DPX, DPY at the
entrance of the beam line.
</PRE>
<H3><A NAME=L505>
set-value-of-element</A>
</H3>
<PRE>Usage: element-pattern [keyword] [{MIN | MAX | MINMAX | MAXMIN}] value

sets value to the specified keyword of the elements which match element-pattern. If keyword is omitted, the default-keyword is assu
med. keyword can be a wildcard to apply all matching keywords.
   If MIN, MAX, MINMAX, MAXMIN are specified, it sets the limit of the default-keyword. Both MINMAX and MAXMIN means MIN=-Abs[value
] and MAX=+Abs[value].
   If the keyword is not the default-keyword, it affects both the current and the saved value.
</PRE>
<UL>
<LI>
<H3><A NAME=L506>
keywords</A>
</H3>
<PRE>Available keywords are:	

type    keywords
DRIFT   L RADIUS
BEND    L ROTATE DROTATE DX DY ANGLE K0 K1 E1 E2 AE1 AE2 F1 FB1 FB2 FRINGE DISFRIN DISRAD EPS RANKICK
QUAD    L ROTATE DX DY K1 F1 F2 FRINGE DISFRIN DISRAD EPS
SEXT    L ROTATE DX DY K2 DISFRIN DISRAD
OCT     L ROTATE DX DY K3 DISFRIN DISRAD
DECA    L ROTATE DX DY K4 DISFRIN DISRAD
DODECA  L ROTATE DX DY K5 DISFRIN DISRAD
MULT    L DX DY DZ CHI1 CHI2 ROTATE(=CHI3) K0..K21 SK0..SK21 DISFRIN F1 F2 FRINGE DISRAD EPS VOLT DVOLT HARM PHI DPHI FREQ RADIUS A
NGLE E1 E2 AE1 AE2 DROTATE
SOL     BZ DX DY DZ DPX DPY BOUND GEO CHI1 CHI2 CHI3 DBZ DISFRIN
CAVI    L ROTATE DX DY VOLT DVOLT V1 V20 V11 V02 FREQ PHI HARM RANVOLT RANPHASE DISFRIN FRINGE
TCAVI   L ROTATE DX DY K0 V1 FREQ PHI HARM RANKICK RANPHASE
COORD   DX DY CHI1 CHI2 CHI3 DIR
MARK    AX BX AY BY EX EPX EY EPY R1 R2 R3 R4 DETR DX DPX DY DPY DZ DDP AZ BZ NZ ZX ZPX ZY ZPY EMITX EMITY DP AZ SIGZ GEO OFFSET
APERT   DX1 DX2 DY1 DY2 DP AX AY DX DY
</PRE>
<LI>
<H3><A NAME=L507>
default-keyword</A>
</H3>
<PRE>The default and available non-default variable keywords are:

type    default-keyword  non-default variable keyword
DRIFT   L                -
BEND    ANGLE            K1,K0,E1,E2
QUAD    K1               ROTATE
SEXT    K2               ROTATE
OCT     K3               ROTATE
DECA    K4               ROTATE
DODECA  K5               ROTATE
MULT    K1               K0,K2..K21,SK0,SK1,SK2..SK21,ROTATE,ANGLE
MARK    -                AX,BX,EX,EPX,AY,BY,EY,EPY,R1,R2,R3,R4,DETR,
                         DX,DPX,DY,DPY,DZ,DDP,AZ,BZ,ZX,ZPX,ZY,ZPY
</PRE>
</UL>
<H3><A NAME=L508>
special-variables</A>
</H3>
<PRE>There are several variables which have special rolls in FFS. Some of them are also accessible in the MAIN level.
</PRE>
<UL>
<LI>
<H3><A NAME=L509>
$Line</A>
</H3>
<PRE> %Line counts the number of the results in FFS Shown with Out[]:= . Out remembers all outputs up to Out[$Line]. $Line = 0 rese
ts the counter and forgets the outputs.
</PRE>
<LI>
<H3><A NAME=L510>
CASE</A>
</H3>
<PRE>CASE is a character-string to be attached with TITLE to issue the CASE command of TopDrawer in DRAW or GEO commands.
</PRE>
<LI>
<H3><A NAME=L511>
CHARGE</A>
</H3>
<PRE>CHARGE contains the charge of the particle. The default is +1.
</PRE>
<LI>
<H3><A NAME=L512>
CONVERGENCE</A>
</H3>
<PRE>CONVERGENCE is the goal of the convergence(==MatchingResidual) in the matching. If MatchingResidual becomes smaller than CONVE
RGENCE times the effective number of the conditions, the matching by GO terminates. The flag CONV is set when MatchingResidual is s
maller than CONVERGENCE after GO or CALCULATE(CAL). The default value is 10^-9.
</PRE>
<LI>
<H3><A NAME=L513>
DAPWIDTH</A>
</H3>
<PRE>DAPWIDTH is the successive width of the x-amplitudes to terminate the tracking assuming that the aperture is enough. The defau
lt is 7.
</PRE>
<LI>
<H3><A NAME=L514>
DP</A>
</H3>
<PRE>DP represents the relative momentum spread of the beam. It is automatically set by the keyword DP of the MARK element at the b
eginning of the beam line. The value of EMITY affects the default weight of variables in the matching. In the off-momentum matching
, the range DP0 - DP < dp/p0 < DP0 + DP is used for the matching.
 If DP is set to a list {min, max}, the off-momentum matching is performed at dp/p= min*Sin[k Pi/2/n], max*Sin[k Pi/2/n], {k,0,fitp
/2}, where fitp is the number of off-momentum points given by FITP.
 The assumed momentum-distribution in the BEAMSIZE(BEAM), MEASURE(MEA), etc. commands, is Gaussian with the standard deviation DP a
nd the mean DP0 if the flag GAUSS is on, otherwise uniform (square) in the range DP0 - DP < dp/p0 < DP0 + DP.
</PRE>
<LI>
<H3><A NAME=L515>
DP0</A>
</H3>
<PRE> DP0 represents the central value of the relative momentum offset in the optics calculation, or the center of the momentum dis
tribution of the beam. The on-momentum optics has the relative momentum deviation dp/p0 == DP0, and the off-momentum calculation is
 done in the range DP0 - DP < dp/p0 < DP0 + DP.
 DP0 sets the momentum deviation of the closed orbit at the entrance for EMIT with RADTAPER.
</PRE>
<LI>
<H3><A NAME=L516>
DTSYNCH</A>
</H3>
<PRE> DTSYNCH is the equilibrium arrival time advance (= -c*delta t, in meter) where the synchrotron radiation loss balances with t
he RF, calculated by EMIT/Emittance[SaveEMIT->True]. This corresponds to the origin of the RF phase. The default is zero.
</PRE>
<LI>
<H3><A NAME=L517>
EFFRFFREQ</A>
</H3>
<PRE> The effective angular frequency weff (= 2 Pi EFFRFFREQ) is obtained using the second derivative

  d^2Vcacc/dt^2 == -weff^2 Vcacc ,

ehere Vcacc is the total acceleration voltage at the equilibrium phase PHICAV. These quantities Vcacc and its derivatives are summe
d over all CAVIs and MULTs.
 It is set by EMITTANCE(EMIT) or Emittance[]. Effective with RING only.
</PRE>
<LI>
<H3><A NAME=L518>
EFFVC</A>
</H3>
<PRE> Effective peak rf voltage EFFVC is given by

  Abs[ weff Vcacc + I dVcacc/dt ] / weff ,

where Vcacc, weff are total acceleration voltage at the equilibrium phase PHICAV and the effective RF angular frequency (=2 Pi EFFR
FFREQ). DVcacc/dt is the time derivative of Vcacc. The quantity Vcacc and its derivatives are summed over all CAVIs and MULTs.
 It is set by EMITTANCE(EMIT) or Emittance[]. The unit is Volt. Effective with RING only.
</PRE>
<LI>
<H3><A NAME=L519>
EFFVCRATIO</A>
</H3>
<PRE> Ratio of (effective voltage)/(Sum[VOLT_k,{k}]) (default: 1). Set by EMITTANCE(EMIT) or Emittance[]. Effective with RING only.

</PRE>
<LI>
<H3><A NAME=L520>
ElementValues</A>
</H3>
<PRE>ElementValues is a symbol to assign rules to determine values of keywords of elements or components. This is used to give a de
pendence between keywords of different elements or components, or determine then by a parametric expression.

Useage:  ElementValues = { key[elem] :> expr, ...}

where	

   key:      keyword to specify a value (string).
   elem:     String to specify the elements or components, wildcards are allowed.
   expr:     an expression which returs a real number to be set to the elements or components.	

Example:  ElementValues = 
            { "DX"["QF1"] :> "DX"["QD1"]-0.001,
              "DY"["QF2.3"] :> -"DY"["QD1.2"],
              "ROTATE"["QF*"] :> f[x] }

Remarks:
	
1. Iff elem contains ".", it is recognized as components, otherwise as elements.
2. In the r.h.s. of the rule, an expression like key[elem] is evaluated as either LINE[key, elem] or Element[key, elem], depending 
on elem has ".".
3. The expression expr can be any expression returning a real number.
4. Later rules overrides the former, if many rules apply on the same keyword of the same element.
5. The rule given by ElementValues overrides the relation given by COUP_LE command.
6. Use a[b] in stead of a@b.
7. ElementValues is cleared by USE. It is hidden by VISIT and restored by BYE.
</PRE>
<LI>
<H3><A NAME=L521>
EMITX</A>
</H3>
<PRE>EMITX is a real variable for the horizontal emittance (not normalized by gamma beta). It is automatically set by the keyword E
MITX of the MARK element at the beginning of the beam line. The EMITTANCE(EMIT) command returns its calculated value in EMITX. The 
value of EMITX affects the default weight of variables in the matching. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L522>
EMITXE</A>
</H3>
<PRE>EMITXE specifies the minimum horizontal emittance for EMITTANCE(EMIT) and Emittance[] calculations. It is useful to give emitt
ance determined externally, such as for proton machines.
</PRE>
<LI>
<H3><A NAME=L523>
EMITY</A>
</H3>
<PRE>EMITY is a real variable for the vertical emittance (not normalized by gamma beta). It is automatically set by the keyword EMI
TY of the MARK element at the beginning of the beam line. The EMITTANCE(EMIT) command returns its calculated value in EMITY. The va
lue of EMITY affects the default weiht of variables in the matching. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L524>
EMITYE</A>
</H3>
<PRE>EMITYE specifies the minimum vertical emittance for EMITTANCE(EMIT) and Emittance[] calculations. It is useful to give emittan
ce determined externally, such as for proton machines.
</PRE>
<LI>
<H3><A NAME=L525>
EMITZ</A>
</H3>
<PRE>EMITZ is a real variable for the longitudinal emittance (not normalized by gamma beta). It is automatically set by the keyword
 EMITZ of the MARK element at the beginning of the beam line. The EMITTANCE(EMIT) command returns its calculated value in EMITZ. Ac
cessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L526>
EMITZE</A>
</H3>
<PRE>EMITZE specifies the minimum longitudinal emittance for EMITTANCE(EMIT) and Emittance[] calculations. It is useful to give emi
ttance determined externally, such as for proton machines.
</PRE>
<LI>
<H3><A NAME=L527>
ExponentOfResidual</A>
</H3>
<PRE>The exponent to calculate MatchinResidual. The default is 2.
</PRE>
<LI>
<H3><A NAME=L528>
FFS$NumericalDerivative</A>
</H3>
<PRE>If False (default), the calculation of response matrix for each matching variables uses analytical expressions as much as poss
ible. If True, performs numerical differentiation during the matching by GO. It is useful for some variables and matching functions
 in some cases. It is slow, so should be avoided for off-momentum-matching for a large beam line.
</PRE>
<LI>
<H3><A NAME=L529>
FitFunction</A>
</H3>
<PRE>FitFunction is a symbol to assign user-defined functions for matching with the GO command. 

Usage:   FitFunction := fun, 

where fun is a function that returns a real number or a list of real numbers, to be matched to zero by GO. The goal of GO is to mak
e fun zero or a list of zeros, together with built-in matching conditions. Thus the sum of fun^2 is added to MatchingResidual. GO a
lso evaluates FitFunction to obtain the derivatives numerically. The function fun can refer the value of variables by Element or LI
NE functions, and the optical functions at DP0 by Twiss. The algorithm of matching is same as that for built-in conditions, but it 
is slower because of the numerical differentiation, when the beam line is long and the number of variables large.

Example:  FitFunction := {Twiss["BX","$$$"]-20, Twiss["BY","$$$"]-20};

which puts the same goal as

   FIT $$$ BX 20 BY 20 .

   FitFunction is cleared by USE. It is also hidden by VISIT and restored by BYE.
</PRE>
<LI>
<H3><A NAME=L530>
FSHIFT</A>
</H3>
<PRE>FSHIFT is the relative shift df/f0 of the revolution (or rf) frequency in a ring. This is valid in EMITTANCE(EMIT), the partic
le-tracking, and CAL/GO with CALC6D. For CAL/GO with CALC4D, DP0 should be used instead.
</PRE>
<LI>
<H3><A NAME=L531>
GCUT</A>
</H3>
<PRE>GCUT specifies the cut-off value of Gaussian distribution in unit of the standard deviation. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L532>
InitialOrbits</A>
</H3>
<PRE>Usage: InitialOrbits = { {x1, px1, y1, py1, z1, dp1}, ...};

or     InitialOrbits = { {ax1, bx1, nx1, ay1, by1, ny1,
          ex1, epx1, ey1, epy1, r11, r21, r31, r41,
          x1, px1, y1, py1, z1, dp1, 0, 0, 0, 0, 0, 0, 0}, ...};

specifies initial conditions of a number of orbits for the optics calculation by CALCULATE(CAL) and GO. Those coordinates are offse
t from the central orbit. If six numbers are given, only the offsets of the orbits are affected. If 27 numbers are given, all Twiss
 parameters are set (values for non-orbit params are used directly. Orbits are giving offsets.)
  If InitialOrbits are given, the off-momentum matching and finite-amplitude matching is disabled.
  InitialOrbits is also necessary to calculate optics with wake field.
</PRE>
<LI>
<H3><A NAME=L533>
LOSSAMPL</A>
</H3>
<PRE>
LOSSAMPL is the transverse amplitude beyond which a particle is judged to have been lost. The default is 1 m. Accessible in MAIN.

</PRE>
<LI>
<H3><A NAME=L534>
LOSSDZ</A>
</H3>
<PRE>LOSSDZ is the longitudinal position z beyond which a particle is judged to have been lost. The default is 100 m. Accessible in
 MAIN. LOSSDZ is effective only when SPAC is ON.
</PRE>
<LI>
<H3><A NAME=L535>
MatchingAmplitude</A>
</H3>
<PRE>MatchingAmplitude is a list of amplitudes for the finite-amplitude matching.

Usage: MatchingAmplitude := { {dp1,x1,y1}, ..};

where dp1 is the momentum deviation to be matched, x1 and y1 are the horizontal and vertical amplitudes at the beginning of the bea
m line, normalized by Sqrt of the sum of the emittance, i.e., Sqrt[(EMITX+EMITY)]. Three orbits are chosen in each dimension. The i
nitial conditions of the orbit is chosen as

   {X,Px,Y,Py} =
   { {x1,0,0,0}, {-x1/2,Sqrt[3]/2 x1,0,0}, {-x1/2,-Sqrt[3]/2 x1,0,0},
     {0,0,y1,0}, {0,0,-y1/2,Sqrt[3]/2 y1}, {0,0,-y1/2,Sqrt[3]/2 y1} },

and when x1==0 or y1==0 corresponding orbits are excluded. The above are labeled {x1,x2,x3,y1,y2,y3} in the output of CALCULATE(CAL
) or GO, and also labeled 1 to 6 in the second element of FFS["CALC"] and FFS["GO"].

    This matching is done when dp1 is within the off-momentum range given by DP, i.e., Abs[dp1] < DP. If dp1 is in the range, the n
earest zero- amplitude optics is chosen. The maching conditions for the finite- amplitude optics are same as those for the zero-amp
litude one.
   Th orbit with finte initial condition never close after one revolution, but FFS simply ignores it and obtain the periodic optics
 around the open
orbit.
</PRE>
<LI>
<H3><A NAME=L536>
MatchingResidual</A>
</H3>
<PRE>MatchingResidual holds the convergence in the last GO or CALCULATE(CAL) commands. It is calculated by

     sw*(Sum[(w_i*df_i)^ExponentOfResidual,{i}]/sw)^(2/ExponentOfResidual)
     +penalty
 where w_i is the weight of the i-th condition, df_i is the difference of the i-th function from the goal, penalty is an additional
 big number  (typically 10), when the optics is unstable or closed orbit is not found in the case of CELL. The parameter sw is defi
ned as

     sw=Sum[(OffMomentumWeight/2/woff)^2,{i}]
 with

     woff = 1                               for on-momentum optics
          = Sqrt[number-of-momentum-points] for off-momentum optics.
 The weight of the function is lighter in the case of off-momentum-matching so that all off-momentum deviations functions weight eq
ual to the on-momentum one. However, the relative weight for the off-momentum part can be changed by setting OffMomentumWeight. 
   The weight of each function at each point with each momentum can be specified by defining the FitWeight function.
</PRE>
<LI>
<H3><A NAME=L537>
MASS</A>
</H3>
<PRE>MASS is the rest mass of the particle in eV. The default is the electron mass.
</PRE>
<LI>
<H3><A NAME=L538>
MINCOUP</A>
</H3>
<PRE>MINCOUP is the minimum emittance ratio to be assumed in the calculation of intrabeam effects in EMITTANCE(EMIT) and Emittance[
]. Emittances Max[EMITk, MINCOUP*(EMITX+EMITY)] (k=X,Y) are assumed in the intrabeam calculation. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L539>
MOMENTUM</A>
</H3>
<PRE>MOMENTUM is the nominal momentum of the beam line at the entrance in eV/c. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L540>
NBUNCH</A>
</H3>
<PRE>NBUNCH is the number of bunches for the calculation of WakeFunction. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L541>
NetResidual</A>
</H3>
<PRE>The net residual of convergence except the penalty for unstable optics.
</PRE>
<LI>
<H3><A NAME=L542>
NP</A>
</H3>
<PRE>NP is the number of particles in the tracking. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L543>
NPARA</A>
</H3>
<PRE>NPARA specifies the maximum number of parallel processes for various calculations such as CALC, GO, TrackParticles, DynamicApe
rtureSurve, etc.
</PRE>
<LI>
<H3><A NAME=L544>
OffMomentumWeight</A>
</H3>
<PRE>Relative weight of the off-momentum deviation for the off-momentum matching. The default is 1.
</PRE>
<LI>
<H3><A NAME=L545>
OMEGA0</A>
</H3>
<PRE>OMEGA0 is 2*Pi*SpeedOfLight/LINE["s","$$$"] . Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L546>
OpticsEpilog</A>
</H3>
<PRE>OpticsEpilog is a variable to assign a user-defined function which is to be executed every time after an optics calculation is
 done in CALCULATE(CAL) or GO commands. In GO, OpticsEpilog is called at the end of each iteration. This function is useful, for in
stance, for setting parameters which depends on the result of optics calculation itself.
</PRE>
<LI>
<H3><A NAME=L547>
OpticsProlog</A>
</H3>
<PRE>OpticsProlog is a variable to assign a user-defined function which is to be executed every time before an optics calculation i
s done in the CALCULATE(CAL) or GO commands. In GO, OpticsProlog is called at the beginning of each iteration. This function is use
ful, for instance, for setting parameters which depends on the result of optics calculation itself.
</PRE>
<LI>
<H3><A NAME=L548>
PBUNCH</A>
</H3>
<PRE>PBUNCH is the number of particles/bunch for the calculation of the intra-beam and space charge effects in EMITTANCE(EMIT), and
 WakeFunction. Accessible in MAIN.
</PRE>
<LI>
<H3><A NAME=L549>
PhotonList</A>
</H3>
<PRE>When PHOTONS is ON (default is OFF), with RAD and FLUC, TrackParticles generates a list of all photons radiated through the tr
acking. The list is assigned to a symbol PhotonList. PhotonList is a list of

{en, gx, gy, gz, nx, ny, nz, xi1, xi2, xi3, np, nele}

where

en:    photon energy [eV]
gx:    GX coordinate of the emission point [m]
gy:    GY coordinate of the emission point [m]
gz:    GZ coordinate of the emission point [m]
nx:    GX component of the photon direction vector
ny:    GY component of the photon direction vector
nz:    GZ component of the photon direction vector (nx^2+ny^2+nz^2)=1.
xi1:   Stokes' parameter for polarization 45 degree to the GZ=0 plane.
xi2:   Stokes' parameter for right-handed polarization
xi3:   Stokes' parameter for polarization in the GZ=0 plane.
np:    particle number
nele:  component number in the beam line

The probability of each polarization is given by each Stokes' parameter as (1+xi)/2 . TrackParticles always updates PhotonList. The
 length of PhtonList is the number of emitted photons.
   Remember that the {GX, GY, GZ} = {0, 0, 0} and their directions are {z, -x, -y} at the entrance of the beam line by default. It 
is changeable by the GEO command anyway.
</PRE>
<LI>
<H3><A NAME=L550>
PHICAV</A>
</H3>
<PRE>The equilibrium RF phase (in radian, = 2 Pi EFFRFFREQ DTSYNCH/c) where the synchrotron radiation loss and acceleration balance
s. If there are phase, voltage, frequency variations in RF cavities, it is calculated based on "effective voltage". Effective with 
RING only.
</PRE>
<LI>
<H3><A NAME=L551>
SIGE</A>
</H3>
<PRE> SIGE is the equilibrium momentum spread at the entrance of the beam line calculated by EMIT/Emittance[SaveEMIT->True].

</PRE>
<LI>
<H3><A NAME=L552>
SIGZ</A>
</H3>
<PRE> SIGZ is the equilibrium bunch length at the entrance of the beam line calculated by EMIT/Emittance[SaveEMIT->True].
</PRE>
<LI>
<H3><A NAME=L553>
SpeedOfLight</A>
</H3>
<PRE>SpeedOfLight is 299792458.
</PRE>
<LI>
<H3><A NAME=L554>
TITLE</A>
</H3>
<PRE>TITLE is a character-string to make the title of the plot in DRAW or GEO commands.
</PRE>
<LI>
<H3><A NAME=L555>
Track$Excitation</A>
</H3>
<PRE>An artificial random beam exciation is added in the tracking, by setting

  Track$Excitation = {sqrte, tru},

where sqrte is the square root of the eigen values of the beam excitation per tuen, and tru is the transpose of the eigenvector  ma
tric of an exciatation matrix B. The matrix B is a 6 by 6 symmetric matrix and {e, tru} = Eigensystem[B], and sqrte = Sqrt[e]. The 
excitation is represented in the physical coordinate at the end of the beam line. Emittance[] gives that matrix for synchrotron rad
iation and intrabeam scattering. This exciation is applied at the end of a beam line. To stop the scattering, say Track$Excitation 
= Null .
</PRE>
<LI>
<H3><A NAME=L556>
UnstableLevel</A>
</H3>
<PRE>Number of unstable planes in the optics calculations. Equal to zero if all x and y optics are stable for on/off-momentum and f
inite amplitude matching.
</PRE>
</UL>
<H3><A NAME=L557>
SAVE</A>
</H3>
<PRE>Usage: SAVE [element-pattern]

saves the values of the elements. What are saved are the value of the default keyword of all elements, the values of the non-defaul
t keywords which have been changed manually or by the matching. If ALL is given it resets all keywords. If element-pattern is given
, it is only limited to the elements which match the pattern, otherwise all elements are saved.
</PRE>
<H3><A NAME=L558>
SEED</A>
</H3>
<PRE>The SEED command is obsolete. Use SeedRandom[] function instead of SEED.
</PRE>
<H3><A NAME=L559>
SHOW</A>
</H3>
<PRE>SHOW prints out the current matching conditions.

   FFS["SHOW"] or FFS$SHOW[] returns the current matching conditions as a list. Each element has a form of

{component1, component2, function, goal-value, number-of-momentums, scale},

which corresponds to the format of the print-out by SHOW.
</PRE>
<H3><A NAME=L560>
SPLIT</A>
</H3>
<PRE>Usage: SPLIT component length

splits the component into two pieces at the point where the distance from the entrance is length. The new components have the same 
name as the original, and the strengths are proportional to the new lengths. Only magnets and cavities can be split. You should CAL
CULATE(CAL) after SPLIT to get optical parameters after SPLIT. Matching using SPLIT element as a variable may degrade the speed of 
convergence.
</PRE>
<H3><A NAME=L561>
STATUS(STAT)</A>
</H3>
<PRE>STAT shows the current settings of flags, fit points, 
special-variables, the region for DISPLAY, seed of the random number generator, and elapsed CPU time, etc.
</PRE>
<H3><A NAME=L562>
STOP</A>
</H3>
<PRE>Exits FFS and returns to SAD/MAIN level, with saving the values of the elements.
</PRE>
<H3><A NAME=L563>
SUSPEND(SUSP)</A>
</H3>
<PRE>Suspend reading from the current input stream, and wait for input from the console. Resumes by RESUME(RES)
</PRE>
<H3><A NAME=L564>
TERMINATE(TERM)</A>
</H3>
<PRE>   TERM [INPUT(IN)] suspends the current input stream and switches it to the previous input stream.
   TERM OUTPUT(OUT) suspends the current output and switches it to the previous output stream.
</PRE>
<H3><A NAME=L565>
TYPE(T)</A>
</H3>
<PRE>Usage: TYPE [element-pattern [element-pattern1..]]

prints out the values of elements which match element-pattern in the SAD MAIN input format. Keywords which have zero values are omi
tted unless it is the default variable. If non element-pattern is given, all elements are printed out.
</PRE>
<H3><A NAME=L566>
UNTIL</A>
</H3>
<PRE>Usage: REP [n] body UNTIL [expr1]

executes commands in body n times until expr1 gives nonzero. The number n can be any expression which gives a number. If n is omitt
ed, infinity is assumed. If expr1 is omitted, False(==0) is assumed.
</PRE>
<H3><A NAME=L567>
USE</A>
</H3>
<PRE>Usage: USE [[NO]EXPAND] beam-line

switches the beam line used in FFS to the beam line given by beam-line. beam-line can be an BeamLine object or the name of a beam l
ine defined in MAIN. All information specific to the current beam line, such as matching conditions is lost. If the keyword EXPAND 
is given (default), the new beam line is expanded, i.e., the values of components are refreshed to the saved values.
   If a BeamLine object is used by USE or VISIT, the new beam line becomes a
new LINE in the MAIN level, with a name which is created automatically.
</PRE>
<H3><A NAME=L568>
VARIABLES(VAR)</A>
</H3>
<PRE>VARIABLES displays a list of current matching-variables and their present, previous, saved, minimum, and maximum values togeth
er with the COUPLEd master elements and their coefficients.
   When executed in the FFS function, it returns the result as a list.

   Usage:   FFS["VAR"]

returns a list of nvar elements, where nvar is the number of current matching-variables given by the FREE command. Each element has
 the form

  {name, keyword, present, previous, saved, minimum, maximum, coupled-master-element, coupling-coefficient} ,

which corresponds to the output of the VARIABLES(VAR) command.
</PRE>
<H3><A NAME=L569>
VARY</A>
</H3>
<PRE>Usage: VARY keyword element-pattern

changes the default-keyword of the elements which match element-pattern to keyword.
</PRE>
<H3><A NAME=L570>
VISIT</A>
</H3>
<PRE>Usage: VISIT [[NO]EXPAND] beam-line

switches the beam line used in FFS to the beam line given by beam-line. beam-line can be an BeamLine object or the name of a beam l
ine defined in MAIN. All information specific to the current beam line, such as matching conditions are reserved, and the previous 
beam line is restored when BYE command is issued. If the keyword EXPAND is given (default), the new beam line is expanded, i.e., th
e values of components are refreshed to the saved values.
   If a BeamLine object is used by USE or VISIT, the new beam line becomes a new LINE in the MAIN level, with a name which is creat
ed automatically.
</PRE>
<H3><A NAME=L571>
wildcards</A>
</H3>
<PRE>   Many commands and functions accept the wildcards as a specification for the name of elements or components. The valid wildc
ards are:

       *         matches any zero or more characters.
       %         matches one character.
       {..}      matches any character enclosed.
       {^..}     matches any character not enclosed.
       ..|..     alternative pattern.
</PRE>
<HR>
</BODY>
